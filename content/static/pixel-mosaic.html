<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pixel Mosaic - Demo</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:30px}.control-section{background:#f8f9fa;border-radius:6px;padding:12px;border:1px solid #e9ecef}.control-section-title{font-size:.8em;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #dee2e6}.control-section-grid{display:grid;grid-template-columns:1fr;gap:12px}.control-group{display:flex;flex-direction:column;gap:6px;min-height:50px;transition:opacity .2s ease}.control-group[style*="display: none"]{min-height:0;opacity:0}label{font-weight:600;color:#555;font-size:.85em}input[type=checkbox]{margin-right:8px;cursor:pointer;width:18px;height:18px;accent-color:#667eea}label:has(input[type=checkbox]){display:flex;align-items:center;cursor:pointer;user-select:none}input[type=range]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:0;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;transition:background .2s}input[type=range]::-webkit-slider-thumb:hover{background:#5568d3}input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;border:none;transition:background .2s}input[type=range]::-moz-range-thumb:hover{background:#5568d3}input[type=number]{width:70px;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:.85em}input[type=number]:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.1)}input[type=file]{padding:10px;border:2px dashed #667eea;border-radius:4px;cursor:pointer;background:#fff;transition:all .2s}input[type=file]:hover{border-color:#5568d3;background:#f8f9ff}button{padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:6px;font-size:.9em;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 4px rgba(102,126,234,.2)}button:hover:not(:disabled){background:#5568d3;box-shadow:0 4px 8px rgba(102,126,234,.3);transform:translateY(-1px)}button:active:not(:disabled){transform:translateY(0);box-shadow:0 2px 4px rgba(102,126,234,.2)}button:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;transform:none}.canvas-container{display:flex;flex-direction:column;align-items:center;margin-top:20px;margin-bottom:20px}.canvas-wrapper{text-align:center;width:100%}.canvas-wrapper h2{margin-bottom:12px;color:#333;font-size:1.1em}canvas{max-width:100%;height:auto;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}.info{margin-top:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;color:#1565c0}.step-navigation{display:none;justify-content:center;align-items:center;gap:15px;margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px}.step-navigation.active{display:flex}.step-navigation button{padding:8px 16px;font-size:.9em;min-width:90px}.step-label{font-weight:600;color:#333;font-size:1em;min-width:180px;text-align:center}.step-counter{color:#666;font-size:.85em}.github-link{margin-top:30px;text-align:center;padding:20px}.github-link a{display:inline-flex;align-items:center;gap:8px;color:#667eea;text-decoration:none;font-weight:600;font-size:1.1em;transition:color .3s}.github-link a:hover{color:#5568d3}.github-link a::before{content:'üîó';font-size:1.2em}</style></head><body><div class=container><h1>üé® Pixel Mosaic</h1><div class=control-section style="max-width:400px;margin:0 auto 20px"><div class=control-section-title>üì§ Image Upload</div><div class=control-section-grid><div class=control-group><label for=imageInput>Upload Image</label> <input type=file id=imageInput accept=image/*></div></div></div><div class=canvas-container><div class=canvas-wrapper><h2 id=canvasTitle>Upload an image to begin</h2><canvas id=mainCanvas></canvas><div style=margin-top:15px><button id=pixelateBtn disabled=disabled>Pixelate Image</button></div><div class=step-navigation id=stepNavigation><button id=stepPrev>‚Üê Previous</button><div><div class=step-label id=stepLabel>Original</div><div class=step-counter id=stepCounter></div></div><button id=stepNext>Next ‚Üí</button></div></div></div><div class=controls><div class=control-section><div class=control-section-title>üé® Pixelation</div><div class=control-section-grid><div class=control-group><label for=pixelSize>Pixel Size: <span id=pixelSizeValue>3</span></label> <input type=range id=pixelSize min=2 max=128 value=3> <input type=number id=pixelSizeNumber min=2 max=128 value=3></div><div class=control-group><label for=contrast>Contrast: <span id=contrastValue>1.0</span></label> <input type=range id=contrast min=0.5 max=2 step=0.1 value=1.0> <input type=number id=contrastNumber min=0.5 max=2 step=0.1 value=1.0></div><div class=control-group><label><input type=checkbox id=useColorLimit checked=checked> Enable Color Limiting</label></div><div class=control-group id=colorLimitGroup><label for=colorLimit>Color Limit: <span id=colorLimitValue>32</span></label> <input type=range id=colorLimit min=2 max=256 value=32> <input type=number id=colorLimitNumber min=2 max=256 value=32></div></div></div><div class=control-section><div class=control-section-title>üîç Edge-Aware</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useEdgeAware> Enable Edge-Aware</label><div id=gpuIndicator style=display:none;margin-top:4px;font-size:.75em;color:#666><span id=gpuStatus>Checking GPU...</span></div></div><div class=control-group id=edgeSharpnessGroup style=display:none><label for=edgeSharpness>Edge Sharpness: <span id=edgeSharpnessValue>0.8</span></label> <input type=range id=edgeSharpness min=0 max=1 step=0.1 value=0.8> <input type=number id=edgeSharpnessNumber min=0 max=1 step=0.1 value=0.8></div><div class=control-group id=gridResolutionGroup style=display:none><label for=gridResolution>Grid Resolution: <span id=gridResolutionValue>-</span></label> <input type=range id=gridResolution min=10 max=500 value=100> <input type=number id=gridResolutionNumber min=10 max=500 value=100><div style=font-size:.75em;color:#666;margin-top:4px>Current: <span id=currentGridResolution>-</span></div></div><div class=control-group id=numPassesGroup style=display:none><label for=numPasses>Optimization Passes: <span id=numPassesValue>3</span></label> <input type=range id=numPasses min=1 max=10 value=3> <input type=number id=numPassesNumber min=1 max=10 value=3></div><div class=control-group id=showStepsGroup style=display:none><label><input type=checkbox id=showAlgorithmSteps> Show Algorithm Steps</label></div><div class=control-group id=useSplinesGroup style=display:none><label><input type=checkbox id=useSplines> Use B-Splines</label></div><div class=control-group id=splineSmoothnessGroup style=display:none><label for=splineSmoothness>Spline Smoothness: <span id=splineSmoothnessValue>0.3</span></label> <input type=range id=splineSmoothness min=0 max=1 step=0.01 value=0.3> <input type=number id=splineSmoothnessNumber min=0 max=1 step=0.01 value=0.3></div></div></div><div class=control-section><div class=control-section-title>üîÑ Transform</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useProjection> Apply Rotation</label></div><div class=control-group id=rotationGroup style=display:none><label for=rotationAngle>Rotation: <span id=rotationAngleValue>0</span>¬∞</label> <input type=range id=rotationAngle min=0 max=360 value=0> <input type=number id=rotationAngleNumber min=0 max=360 value=0></div><div class=control-group><label><input type=checkbox id=useScaling> Apply Scaling</label></div><div class=control-group id=scalingGroup style=display:none><label for=scaleX>Scale X: <span id=scaleXValue>1.0</span></label> <input type=range id=scaleX min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleXNumber min=0.1 max=3 step=0.1 value=1.0></div><div class=control-group id=scalingGroupY style=display:none><label for=scaleY>Scale Y: <span id=scaleYValue>1.0</span></label> <input type=range id=scaleY min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleYNumber min=0.1 max=3 step=0.1 value=1.0></div></div></div></div><div class=info><strong>How to use:</strong> Upload an image, adjust the pixel size and color limit, then click "Pixelate Image". Enable "Edge-Aware Pixelation" for adaptive grid optimization with adjustable edge sharpness. Check "Show Algorithm Steps" to visualize the edge detection process.</div><div class=github-link><a href=https://github.com/yogthos/pixel-mosaic target=_blank rel="noopener noreferrer">View on GitHub</a></div></div><script type=module>function de(e,t,o,r){let c=new Float32Array(o*r);for(let a=1;a<r-1;a++)for(let s=1;s<o-1;s++){let i=a*o+s,h=e[i],l=t[i];if(h===0){c[i]=0;continue}let d=l;for(;d<0;)d+=2*Math.PI;for(;d>=2*Math.PI;)d-=2*Math.PI;let n,f;d>=0&&d<Math.PI/8||d>=15*Math.PI/8&&d<2*Math.PI||d>=7*Math.PI/8&&d<9*Math.PI/8?(n=e[i-1],f=e[i+1]):d>=Math.PI/8&&d<3*Math.PI/8||d>=9*Math.PI/8&&d<11*Math.PI/8?(n=e[(a-1)*o+(s+1)],f=e[(a+1)*o+(s-1)]):d>=3*Math.PI/8&&d<5*Math.PI/8||d>=11*Math.PI/8&&d<13*Math.PI/8?(n=e[(a-1)*o+s],f=e[(a+1)*o+s]):(n=e[(a-1)*o+(s-1)],f=e[(a+1)*o+(s+1)]),h>=n&&h>=f?c[i]=h:c[i]=0}return c}function he(e,t,o,r={}){let{threshold:c=.1,highThreshold:a=null,lowThreshold:s=null,usePercentile:i=!0,binarize:h=!0}=r,l=new Float32Array(e.length),d=c;if(i&&c>0){let n=[];for(let f=0;f<e.length;f++)e[f]>0&&n.push(e[f]);if(n.length>0){n.sort((m,p)=>m-p);let f=c,v=Math.ceil(n.length*f),g=Math.min(n.length-1,Math.max(0,v));d=n[g]}}if(a!==null&&s!==null&&a>s){let n=a,f=s;if(i){let m=[];for(let p=0;p<e.length;p++)e[p]>0&&m.push(e[p]);if(m.length>0){m.sort((y,M)=>y-M);let p=1-a,S=1-s,E=Math.floor(m.length*p),x=Math.floor(m.length*S);n=m[Math.max(0,E-1)]||0,f=m[Math.max(0,x-1)]||0}}let v=new Set,g=new Set;for(let m=0;m<e.length;m++)e[m]>=n?(v.add(m),l[m]=h?1:e[m]):(e[m]>=f&&g.add(m),l[m]=0);for(let m=0;m<e.length;m++)if(g.has(m)){let p=!1,S=m%t,E=Math.floor(m/t);for(let x=-1;x<=1&&!p;x++)for(let y=-1;y<=1&&!p;y++){if(y===0&&x===0)continue;let M=S+y,I=E+x;if(M>=0&&M<t&&I>=0&&I<o){let b=I*t+M;v.has(b)&&(p=!0)}}p&&(l[m]=h?1:e[m])}}else for(let n=0;n<e.length;n++)e[n]>=d?l[n]=h?1:e[n]:l[n]=0;return l}function se(e,t={}){let{applyNMS:o=!0,threshold:r=null,edgeSharpness:c=.8,highThreshold:a=null,lowThreshold:s=null,captureIntermediates:i=!1}=t;r===null&&(r=.1+c*.5);let{data:h,width:l,height:d}=e,n=new Float32Array(l*d),f=new Float32Array(l*d),v=null;i&&(v=new Float32Array(l*d));let g=[-1,0,1,-2,0,2,-1,0,1],m=[-1,-2,-1,0,0,0,1,2,1];for(let y=1;y<d-1;y++)for(let M=1;M<l-1;M++){let I=0,b=0;for(let C=-1;C<=1;C++)for(let T=-1;T<=1;T++){let _=((y+C)*l+(M+T))*4,z=(h[_]+h[_+1]+h[_+2])/3,U=(C+1)*3+(T+1);I+=z*g[U],b+=z*m[U],i&&C===0&&T===0&&(v[y*l+M]=z/255)}let w=Math.sqrt(I*I+b*b);n[y*l+M]=w;let A=Math.atan2(b,I)+Math.PI/2;f[y*l+M]=A}if(i){for(let y=0;y<d;y++)for(let M=0;M<l;M++)if(y===0||y===d-1||M===0||M===l-1){let I=(y*l+M)*4,b=(h[I]+h[I+1]+h[I+2])/3;v[y*l+M]=b/255}}let p=0;for(let y=0;y<n.length;y++)n[y]>p&&(p=n[y]);if(p>0)for(let y=0;y<n.length;y++)n[y]/=p;let S=null;i&&(S=new Float32Array(n));let E=n,x=null;return o&&(E=de(n,f,l,d),i&&(x=new Float32Array(E))),E=he(E,l,d,{threshold:r,highThreshold:a,lowThreshold:s}),i?{edgeMap:E,intermediates:{grayscale:v,magnitude:S,afterNMS:x||S,afterThreshold:E},width:l,height:d}:E}function me(e,t,o,r,c,a=!1){if(r=Math.max(0,Math.min(t-1,r)),c=Math.max(0,Math.min(o-1,c)),!a){let I=Math.round(r),w=Math.round(c)*t+I;return e[w]||0}let s=Math.floor(r),i=Math.floor(c),h=Math.min(t-1,s+1),l=Math.min(o-1,i+1),d=r-s,n=c-i,f=i*t+s,v=l*t+s,g=i*t+h,m=l*t+h,p=e[f]||0,S=e[v]||0,E=e[g]||0,x=e[m]||0,y=p*(1-d)+E*d,M=S*(1-d)+x*d;return y*(1-n)+M*n}function Qe(e){let t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return null;let o=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;

    void main() {
      gl_Position = vec4(a_position, 0.0, 1.0);
      v_texCoord = a_texCoord;
    }
  `,r=`
    precision mediump float;
    uniform sampler2D u_image;
    uniform vec2 u_textureSize;
    varying vec2 v_texCoord;

    void main() {
      vec2 onePixel = vec2(1.0) / u_textureSize;

      // Sample neighboring pixels for Sobel operator
      float tl = texture2D(u_image, v_texCoord + vec2(-onePixel.x, -onePixel.y)).r;
      float tm = texture2D(u_image, v_texCoord + vec2( 0.0, -onePixel.y)).r;
      float tr = texture2D(u_image, v_texCoord + vec2( onePixel.x, -onePixel.y)).r;
      float ml = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  0.0)).r;
      float mr = texture2D(u_image, v_texCoord + vec2( onePixel.x,  0.0)).r;
      float bl = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  onePixel.y)).r;
      float bm = texture2D(u_image, v_texCoord + vec2( 0.0,  onePixel.y)).r;
      float br = texture2D(u_image, v_texCoord + vec2( onePixel.x,  onePixel.y)).r;

      // Sobel X kernel: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
      float sobelX = -tl + tr - 2.0 * ml + 2.0 * mr - bl + br;

      // Sobel Y kernel: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
      float sobelY = -tl - 2.0 * tm - tr + bl + 2.0 * bm + br;

      // Calculate gradient magnitude
      float magnitude = sqrt(sobelX * sobelX + sobelY * sobelY);

      // Normalize magnitude to [0, 1] range
      // Max theoretical magnitude for normalized [0,1] input with Sobel is ~5.66
      // Use 6.0 as divisor to ensure we stay in [0, 1] range
      float magnitudeNormalized = magnitude / 6.0;

      // Calculate edge direction (perpendicular to gradient)
      // atan2 returns [-\u03C0, \u03C0], we add \u03C0/2 and normalize to [0, 2\u03C0)
      float direction = atan(sobelY, sobelX) + 3.14159265359 / 2.0;
      if (direction < 0.0) direction += 2.0 * 3.14159265359;

      // Normalize direction to [0, 1] for storage in texture
      float directionNormalized = direction / (2.0 * 3.14159265359);

      // Output: R = magnitude (normalized), G = direction (normalized), B = unused, A = 1.0
      gl_FragColor = vec4(magnitudeNormalized, directionNormalized, 0.0, 1.0);
    }
  `;function c(n,f,v){let g=n.createShader(f);return n.shaderSource(g,v),n.compileShader(g),n.getShaderParameter(g,n.COMPILE_STATUS)?g:(console.error("Shader compile error:",n.getShaderInfoLog(g)),n.deleteShader(g),null)}function a(n,f,v){let g=n.createProgram();return n.attachShader(g,f),n.attachShader(g,v),n.linkProgram(g),n.getProgramParameter(g,n.LINK_STATUS)?g:(console.error("Program link error:",n.getProgramInfoLog(g)),n.deleteProgram(g),null)}let s=c(t,t.VERTEX_SHADER,o),i=c(t,t.FRAGMENT_SHADER,r);if(!s||!i)return null;let h=a(t,s,i);if(!h)return null;let l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW);let d=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,d),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),{gl:t,program:h,positionBuffer:l,texCoordBuffer:d}}function et(e,t){let{width:o,height:r,data:c}=t,a=new Uint8Array(o*r);for(let i=0;i<c.length;i+=4){let h=Math.round(.299*c[i]+.587*c[i+1]+.114*c[i+2]);a[i/4]=h}let s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,o,r,0,e.LUMINANCE,e.UNSIGNED_BYTE,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),s}function Ie(e,t={}){let{applyNMS:o=!0,threshold:r=null,edgeSharpness:c=.8,highThreshold:a=null,lowThreshold:s=null}=t;r===null&&(r=.02+c*.18);let{width:i,height:h}=e,l=document.createElement("canvas");l.width=i,l.height=h;let d=Qe(l);if(!d)return console.warn("WebGL not available, falling back to CPU"),null;let{gl:n,program:f,positionBuffer:v,texCoordBuffer:g}=d,m=et(n,e);n.viewport(0,0,i,h),n.useProgram(f);let p=n.getAttribLocation(f,"a_position"),S=n.getAttribLocation(f,"a_texCoord");n.bindBuffer(n.ARRAY_BUFFER,v),n.enableVertexAttribArray(p),n.vertexAttribPointer(p,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,g),n.enableVertexAttribArray(S),n.vertexAttribPointer(S,2,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,m),n.uniform1i(n.getUniformLocation(f,"u_image"),0),n.uniform2f(n.getUniformLocation(f,"u_textureSize"),i,h);let E=n.createTexture();n.bindTexture(n.TEXTURE_2D,E),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,h,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);let x=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,x),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,E,0);let y=n.checkFramebufferStatus(n.FRAMEBUFFER);if(y!==n.FRAMEBUFFER_COMPLETE)return console.error("WebGL framebuffer incomplete:",y),n.deleteTexture(m),n.deleteTexture(E),n.deleteFramebuffer(x),null;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,m),n.drawArrays(n.TRIANGLES,0,6);let M=n.getError();if(M!==n.NO_ERROR)return console.error("WebGL error during rendering:",M),n.deleteTexture(m),n.deleteTexture(E),n.deleteFramebuffer(x),null;let I=new Uint8Array(i*h*4);n.readPixels(0,0,i,h,n.RGBA,n.UNSIGNED_BYTE,I);let b=new Float32Array(i*h),w=new Float32Array(i*h);for(let C=0;C<i*h;C++){b[C]=I[C*4]/255;let T=I[C*4+1]/255;w[C]=T*2*Math.PI}let A=b;return o&&(A=de(b,w,i,h)),A=he(A,i,h,{threshold:r,highThreshold:a,lowThreshold:s}),n.deleteTexture(m),n.deleteTexture(E),n.deleteFramebuffer(x),A}function Re(e,t,o=2){if(t.length<o+1)return t.length===2?{x:t[0].x+(t[1].x-t[0].x)*e,y:t[0].y+(t[1].y-t[0].y)*e}:{x:t[0].x,y:t[0].y};if(o===2){let r=t[0],c=t[1],a=t[2],s=e*e,i=1-e,l=.5*(i*i),d=.5*(1+2*e-2*s),n=.5*s;return{x:l*r.x+d*c.x+n*a.x,y:l*r.y+d*c.y+n*a.y}}if(o===3){let r=t[0],c=t[1],a=t[2],s=t[3],i=e*e,h=i*e,l=1-e,f=l*l*l/6,v=(3*h-6*i+4)/6,g=(-3*h+3*i+3*e+1)/6,m=h/6;return{x:f*r.x+v*c.x+g*a.x+m*s.x,y:f*r.y+v*c.y+g*a.y+m*s.y}}return{x:t[0].x+(t[1].x-t[0].x)*e,y:t[0].y+(t[1].y-t[0].y)*e}}function Pe(e,t,o=null,r=null,c=.3){let a=[e];if(o&&r){let s=(e.x+t.x)/2,i=(e.y+t.y)/2,h=c,l=s+(o.x+r.x-2*s)*h,d=i+(o.y+r.y-2*i)*h;a.push({x:l,y:d})}else a.push({x:(e.x+t.x)/2,y:(e.y+t.y)/2});return a.push(t),a}function be(e,t,o,r,c=2){let a=o.corners,s=a[0].x,i=a[0].x,h=a[0].y,l=a[0].y;for(let m=1;m<4;m++)s=Math.min(s,a[m].x),i=Math.max(i,a[m].x),h=Math.min(h,a[m].y),l=Math.max(l,a[m].y);let d=Math.max(i-s,l-h)*.1;if(e<s-d||e>i+d||t<h-d||t>l+d)return!1;let n=4,f=[];for(let m=0;m<4;m++){let p=a[m],S=a[(m+1)%4],E=(p.x+S.x)/2,x=(p.y+S.y)/2;for(let y=0;y<n;y++){let M=y/n,I=M*M,b=1-M,A=.5*(b*b),C=.5*(1+2*M-2*I),T=.5*I;f.push({x:A*p.x+C*E+T*S.x,y:A*p.y+C*x+T*S.y})}}let v=0,g=f.length;for(let m=0;m<g;m++){let p=f[m],S=f[(m+1)%g];p.y<=t?S.y>t&&(S.x-p.x)*(t-p.y)-(e-p.x)*(S.y-p.y)>0&&v++:S.y<=t&&(S.x-p.x)*(t-p.y)-(e-p.x)*(S.y-p.y)<0&&v--}return v!==0}function Ce(e,t,o){let r=[[o[0],o[1]],[o[1],o[2]],[o[2],o[3]],[o[3],o[0]]],c=null;for(let[a,s]of r){let i=s.x-a.x,h=s.y-a.y,l=e-a.x,d=t-a.y,n=i*d-h*l;if(Math.abs(n)<1e-10)continue;let f=n>0?"left":"right";if(c===null)c=f;else if(c!==f)return!1}return!0}var fe=class{constructor(t,o){this.x=t,this.y=o,this.originalX=t,this.originalY=o}reset(){this.x=this.originalX,this.y=this.originalY}},ge=class{constructor(t){this.corners=t}getBounds(t=!1,o=2){let r=1/0,c=1/0,a=-1/0,s=-1/0;for(let i of this.corners)r=Math.min(r,i.x),c=Math.min(c,i.y),a=Math.max(a,i.x),s=Math.max(s,i.y);if(t){let i=[[this.corners[0],this.corners[1]],[this.corners[1],this.corners[2]],[this.corners[2],this.corners[3]],[this.corners[3],this.corners[0]]];for(let[h,l]of i){let d=Pe(h,l);for(let n=0;n<=1;n+=.1){let f=Re(n,d,o);r=Math.min(r,f.x),c=Math.min(c,f.y),a=Math.max(a,f.x),s=Math.max(s,f.y)}}}return{minX:r,minY:c,maxX:a,maxY:s}}getAverageColor(t,o=!1,r=null,c=2){let{data:a,width:s}=t,i=this.getBounds(o,c),h=Math.max(0,Math.floor(i.minX)),l=Math.max(0,Math.floor(i.minY)),d=Math.min(s-1,Math.floor(i.maxX)),n=Math.min(t.height-1,Math.floor(i.maxY)),f=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],v=Math.max(1,Math.floor(Math.min((d-h)/10,(n-l)/10,4))),g=0,m=0,p=0,S=0,E=0;for(let x=l;x<=n;x+=v)for(let y=h;y<=d;y+=v){let M=y+.5,I=x+.5,b=!1;if(o&&r?b=be(M,I,this,r,c):b=Ce(M,I,f),b){let w=(x*s+y)*4;g+=a[w],m+=a[w+1],p+=a[w+2],S+=a[w+3],E++}}if(E===0)for(let x=l;x<=n;x++)for(let y=h;y<=d;y++){let M=(x*s+y)*4;g+=a[M],m+=a[M+1],p+=a[M+2],S+=a[M+3],E++}return E===0?{r:0,g:0,b:0,a:255}:{r:Math.round(g/E),g:Math.round(m/E),b:Math.round(p/E),a:Math.round(S/E)}}getBlendedColor(t,o,r=!1,c=null,a=2){let{data:s,width:i}=t,h=this.getBounds(r,a),l=Math.max(0,Math.floor(h.minX)),d=Math.max(0,Math.floor(h.minY)),n=Math.min(i-1,Math.floor(h.maxX)),f=Math.min(t.height-1,Math.floor(h.maxY)),v=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],g=Math.max(1,Math.floor(Math.min((n-l)/15,(f-d)/15,2))),m=[],p=0,S=0,E=0,x=0;for(let T=d;T<=f;T+=g)for(let _=l;_<=n;_+=g){let z=_+.5,U=T+.5,H=!1;if(r&&c?H=be(z,U,this,c,a):H=Ce(z,U,v),H){let F=(T*i+_)*4,L=s[F],N=s[F+1],R=s[F+2],P=s[F+3];m.push({r:L,g:N,b:R,a:P}),p+=L,S+=N,E+=R,x+=P}}if(m.length===0)return this.getAverageColor(t,r,c,a);let y=m.length;p=Math.round(p/y),S=Math.round(S/y),E=Math.round(E/y),x=Math.round(x/y),m.sort((T,_)=>T.r+T.g+T.b-(_.r+_.g+_.b));let M=Math.floor(m.length/2),I=m[M].r,b=m[M].g,w=m[M].b,A=m[M].a,C=o;return{r:Math.round(p*(1-C)+I*C),g:Math.round(S*(1-C)+b*C),b:Math.round(E*(1-C)+w*C),a:Math.round(x*(1-C)+A*C)}}};function Ae(e,t,o){let r=Math.ceil(e/o),c=Math.ceil(t/o),a=[],s=[];for(let i=0;i<=c;i++){let h=[];for(let l=0;l<=r;l++){let d=l*e/r,n=i*t/c;h.push(new fe(d,n))}a.push(h)}for(let i=0;i<c;i++)for(let h=0;h<r;h++){let l=new ge([a[i][h],a[i][h+1],a[i+1][h+1],a[i+1][h]]);s.push(l)}return{corners:a,cells:s,cols:r,rows:c}}function tt(e,t,o){let{width:r,height:c}=t,{cols:a,rows:s}=e,i=new ImageData(r,c),h=i.data,l=r/a,d=c/s;for(let n=0;n<s;n++)for(let f=0;f<a;f++){let v=n*a+f,g=o[v],m=Math.floor(f*l),p=Math.floor((f+1)*l),S=Math.floor(n*d),E=Math.floor((n+1)*d);for(let x=S;x<E&&x<c;x++)for(let y=m;y<p&&y<r;y++){let M=(x*r+y)*4;h[M]=g.r,h[M+1]=g.g,h[M+2]=g.b,h[M+3]=255}}return i}function we(e,t,o,r,c,a,s,i=!1,h=null,l=null,d=2,n=.3){let f=a-r,v=s-c,g=Math.sqrt(f*f+v*v);if(g<1)return 0;let m=Math.max(3,Math.ceil(g*1.5)),p=0,S=0,E=0,x=null;i&&(x=Pe({x:r,y:c},{x:a,y:s},h,l,n));for(let b=0;b<=m;b++){let w=b/m,A,C;if(i&&x){let U=Re(w,x,d);A=U.x,C=U.y}else A=r+f*w,C=c+v*w;let T=Math.max(0,Math.min(t-1,A)),_=Math.max(0,Math.min(o-1,C));me(e,t,o,T,_,!1)>0?(p++,S++,E=Math.max(E,S)):S=0}let y=p/(m+1),M=E/(m+1),I=me(e,t,o,Math.max(0,Math.min(t-1,r)),Math.max(0,Math.min(o-1,c)),!1)>0?.2:0;return y*.4+M*.4+I}function Te(e,t,o,r,c,a=3){let s=0,i=0;for(let h=-a;h<=a;h++)for(let l=-a;l<=a;l++){let d=Math.floor(r+l),n=Math.floor(c+h);if(d>=0&&d<t&&n>=0&&n<o){i++;let f=n*t+d;e[f]>0&&s++}}return i>0?s/i:0}function Be(e,t,o,r,c={}){let{searchSteps:a=9,numIterations:s=2,stepSize:i=1,edgeSharpness:h=.8,useSplines:l=!1,splineDegree:d=2,splineSmoothness:n=.3}=c;if(!t||t.length!==o*r)return console.warn("Invalid edge map for grid optimization"),e;let{corners:f,cells:v}=e,g=f.length,m=f[0].length,p=.3+h*.5,S=.2*(1-h*.5);for(let E=0;E<s;E++)for(let x=1;x<g-1;x++)for(let y=1;y<m-1;y++){let M=f[x][y],I=M.x,b=M.y,w=[];x>0&&w.push(f[x-1][y]),x<g-1&&w.push(f[x+1][y]),y>0&&w.push(f[x][y-1]),y<m-1&&w.push(f[x][y+1]);let A=Te(t,o,r,M.x,M.y,Math.ceil(i));for(let F of w){let L=null,N=null;if(l){let R=F.x-M.x,P=F.y-M.y;Math.abs(R)>Math.abs(P)?(x>0&&(L=f[x-1][y]),x<g-1&&(N=f[x+1][y])):(y>0&&(L=f[x][y-1]),y<m-1&&(N=f[x][y+1]))}A+=we(t,o,r,M.x,M.y,F.x,F.y,l,L,N,d,n)}let C=Math.floor(Math.sqrt(a)),T=Math.floor(C/2);for(let F=-T;F<=T;F++)for(let L=-T;L<=T;L++){if(L===0&&F===0)continue;let N=M.x+L*i,R=M.y+F*i;if(N<0||N>=o||R<0||R>=r)continue;let P=Te(t,o,r,N,R,Math.ceil(i));for(let D of w){let G=null,k=null;if(l){let V=D.x-N,O=D.y-R;Math.abs(V)>Math.abs(O)?(x>0&&(G=f[x-1][y]),x<g-1&&(k=f[x+1][y])):(y>0&&(G=f[x][y-1]),y<m-1&&(k=f[x][y+1]))}P+=we(t,o,r,N,R,D.x,D.y,l,G,k,d,n)}P>A&&(A=P,I=N,b=R)}let _=E/Math.max(1,s-1),z=p+S*(1-_),U=I-M.x,H=b-M.y;M.x+=U*z,M.y+=H*z}return e}function Le(e,t,o=null,r=.8,c=!1,a=2){let{width:s,height:i}=t,h=[];for(let l=0;l<e.cells.length;l++)h.push(e.cells[l].getBlendedColor(t,r,c,e,a));return tt(e,t,h)}function pe(e,t,o){let r=document.createElement("canvas");r.width=t,r.height=o;let c=r.getContext("2d"),a=c.createImageData(t,o),s=a.data;if(e.length!==t*o){console.warn(`Edge map size mismatch: expected ${t*o}, got ${e.length}`);for(let l=0;l<s.length;l+=4)s[l]=255,s[l+1]=0,s[l+2]=0,s[l+3]=255;return c.putImageData(a,0,0),r}let i=!1,h=0;for(let l=0;l<e.length;l++)e[l]>0&&(i=!0,h=Math.max(h,e[l]));if(i)for(let l=0;l<e.length;l++){let d=e[l],n=l*4;if(d>0){let f=Math.round(d*255);s[n]=f,s[n+1]=f,s[n+2]=f}else s[n]=0,s[n+1]=0,s[n+2]=0;s[n+3]=255}else for(let l=0;l<s.length;l+=4)s[l]=32,s[l+1]=32,s[l+2]=32,s[l+3]=255;return c.putImageData(a,0,0),r}function Ge(e){let{width:t,height:o,data:r}=e,c=document.createElement("canvas");c.width=t,c.height=o;let a=c.getContext("2d"),s=a.createImageData(t,o),i=s.data;for(let h=0;h<r.length;h+=4){let l=Math.round(.299*r[h]+.587*r[h+1]+.114*r[h+2]);i[h]=l,i[h+1]=l,i[h+2]=l,i[h+3]=r[h+3]}return a.putImageData(s,0,0),c}function xe(e,t,o="rgba(255, 0, 0, 0.7)",r=1){let c=document.createElement("canvas");c.width=e.width,c.height=e.height;let a=c.getContext("2d");a.drawImage(e,0,0),a.strokeStyle=o,a.lineWidth=r,a.lineCap="round",a.lineJoin="round";let{corners:s}=t,i=s.length,h=s[0].length,l=e.width/(h-1),d=e.height/(i-1),n=Math.min(l,d),f=n<20?Math.ceil(20/n):1;for(let v=0;v<i;v+=f){a.beginPath(),a.moveTo(s[v][0].x,s[v][0].y);for(let g=1;g<h;g++)a.lineTo(s[v][g].x,s[v][g].y);a.stroke()}if(f>1&&i>1){let v=i-1;a.beginPath(),a.moveTo(s[v][0].x,s[v][0].y);for(let g=1;g<h;g++)a.lineTo(s[v][g].x,s[v][g].y);a.stroke()}for(let v=0;v<h;v+=f){a.beginPath(),a.moveTo(s[0][v].x,s[0][v].y);for(let g=1;g<i;g++)a.lineTo(s[g][v].x,s[g][v].y);a.stroke()}if(f>1&&h>1){let v=h-1;a.beginPath(),a.moveTo(s[0][v].x,s[0][v].y);for(let g=1;g<i;g++)a.lineTo(s[g][v].x,s[g][v].y);a.stroke()}return c}function ee(e){let t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),t}function _e(e,t,o={}){let{returnCanvas:r=!1,colorLimit:c=null,contrast:a=1}=o,s=e instanceof ImageData?e:De(e),i=dt(e,t),h=i.scaledImageData;c&&c>0&&(h=ze(h,c),i.scaledCanvas.getContext("2d").putImageData(h,0,0),i.scaledImageData=h);let l=ht(i);if(a!==1){let d=l.getContext("2d").getImageData(0,0,l.width,l.height);d=Fe(d,a),l.getContext("2d").putImageData(d,0,0)}return r?l:l.getContext("2d").getImageData(0,0,l.width,l.height)}function nt(e,t,o,r){let{width:c,height:a,data:s}=e,i=new ImageData(c,a),h=i.data;for(let l=0;l<a;l+=o)for(let d=0;d<c;d+=o){let n=Math.min(d+o,c),f=Math.min(l+o,a),v=[],g=!1,m=0;for(let S=l;S<f;S++)for(let E=d;E<n;E++){let x=(S*c+E)*4;v.push({r:s[x],g:s[x+1],b:s[x+2],a:s[x+3]});let y=S*c+E;t[y]>0&&(g=!0,m=Math.max(m,t[y]))}let p;if(g&&r>0){let S=ot(v);if(r>=1)p=S;else{let E=Ne(v),x=r*m;p={r:Math.round(E.r*(1-x)+S.r*x),g:Math.round(E.g*(1-x)+S.g*x),b:Math.round(E.b*(1-x)+S.b*x),a:Math.round(E.a*(1-x)+S.a*x)}}}else p=Ne(v);for(let S=l;S<f;S++)for(let E=d;E<n;E++){let x=(S*c+E)*4;h[x]=p.r,h[x+1]=p.g,h[x+2]=p.b,h[x+3]=p.a}}return i}function Ne(e){let t=0,o=0,r=0,c=0;for(let s of e)t+=s.r,o+=s.g,r+=s.b,c+=s.a;let a=e.length;return{r:Math.round(t/a),g:Math.round(o/a),b:Math.round(r/a),a:Math.round(c/a)}}function ot(e){if(e.length===0)return{r:0,g:0,b:0,a:255};if(e.length===1)return e[0];let t=[...e].sort((o,r)=>{let c=.299*o.r+.587*o.g+.114*o.b,a=.299*r.r+.587*r.g+.114*r.b;return c-a});return t[Math.floor(t.length/2)]}function at(e,t){let o=new Uint8ClampedArray(e.data),r=e.width,c=e.height,a=Math.max(1,Math.floor(Math.sqrt(r*c)/100)),s=[];for(let d=0;d<o.length;d+=4*a){let n=o[d],f=o[d+1],v=o[d+2];s.push({r:n,g:f,b:v})}let i=[];if(s.length<=t){let d=new Map;for(let n of s){let f=`${n.r},${n.g},${n.b}`;if(!d.has(f)&&(d.set(f,n),d.size>=t))break}i.push(...Array.from(d.values()))}else{let d=new Map;for(let f of s){let v=`${f.r},${f.g},${f.b}`;d.set(v,(d.get(v)||0)+1)}let n=Array.from(d.entries()).sort((f,v)=>v[1]-f[1]).map(([f])=>{let[v,g,m]=f.split(",").map(Number);return{r:v,g,b:m}});for(i.push(n[0]);i.length<t&&i.length<n.length;){let f=-1,v=null;for(let g of n){if(i.some(p=>p.r===g.r&&p.g===g.g&&p.b===g.b))continue;let m=1/0;for(let p of i){let S=Math.sqrt(Math.pow(g.r-p.r,2)+Math.pow(g.g-p.g,2)+Math.pow(g.b-p.b,2));S<m&&(m=S)}m>f&&(f=m,v=g)}if(v)i.push(v);else{for(let g of n){if(i.length>=t)break;i.some(m=>m.r===g.r&&m.g===g.g&&m.b===g.b)||i.push(g)}break}}}i.length===0&&i.push({r:128,g:128,b:128});let h=new ImageData(r,c),l=h.data;for(let d=0;d<o.length;d+=4){let n=o[d],f=o[d+1],v=o[d+2],g=o[d+3],m=1/0,p=i[0];for(let S of i){let E=Math.sqrt(Math.pow(n-S.r,2)+Math.pow(f-S.g,2)+Math.pow(v-S.b,2));E<m&&(m=E,p=S)}l[d]=p.r,l[d+1]=p.g,l[d+2]=p.b,l[d+3]=g}return h}function rt(e,t){let o=e.data,r=new ImageData(e.width,e.height),c=r.data;for(let a=0;a<o.length;a+=4)c[a]=Math.max(0,Math.min(255,Math.round((o[a]-128)*t+128))),c[a+1]=Math.max(0,Math.min(255,Math.round((o[a+1]-128)*t+128))),c[a+2]=Math.max(0,Math.min(255,Math.round((o[a+2]-128)*t+128))),c[a+3]=o[a+3];return r}function De(e){if(e instanceof ImageData)return e;let t=document.createElement("canvas");if(e instanceof HTMLCanvasElement)t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0);else if(e instanceof HTMLImageElement){let o=e.naturalWidth||e.width,r=e.naturalHeight||e.height;t.width=o,t.height=r,t.getContext("2d").drawImage(e,0,0)}else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");return t.getContext("2d").getImageData(0,0,t.width,t.height)}async function st(e,t={}){let{edgeSharpness:o=.8,onProgress:r=null}=t,{width:c,height:a}=e,s=null,i=!1;try{if(s=Ie(e,{edgeSharpness:o}),i=s!==null,s)if(s.length!==c*a)console.warn("WebGL edge map size mismatch, falling back to CPU"),s=null,i=!1;else{let h=0,l=Math.min(1e4,s.length),d=Math.max(1,Math.floor(s.length/l));for(let n=0;n<s.length;n+=d)s[n]>0&&h++;if(h===0&&l>100){console.warn("WebGL edge map has no edges in sample, trying CPU");let n=se(e,{edgeSharpness:o}),f=0,v=Math.max(1,Math.floor(n.length/l));for(let g=0;g<n.length;g+=v)n[g]>0&&f++;f>0&&(s=n,i=!1)}}}catch(h){console.error("WebGL edge detection error:",h),s=null,i=!1}return s||(s=se(e,{edgeSharpness:o})),r&&r({usingGPU:i}),{edgeMap:s,usingGPU:i}}function it(e,t){return Ae(e.width,e.height,t)}function lt(e,t={}){let{grid:o,edgeMap:r,imageData:c}=e,{searchSteps:a=9,numIterations:s=2,stepSize:i=1,edgeSharpness:h=.8,useSplines:l=!1,splineDegree:d=2,splineSmoothness:n=.3}=t;if(!o||!r||!c)throw new Error("optimizeGridStep requires grid, edgeMap, and imageData in context");let{width:f,height:v}=c,g=Math.max(a,Math.floor(9+h*16)),m=Math.max(s,Math.floor(2+h*3));return Be(o,r,f,v,{searchSteps:g,numIterations:m,stepSize:i||1,edgeSharpness:h,useSplines:l,splineDegree:d,splineSmoothness:n})}function ct(e,t,o,r){return nt(e,t,o,r)}function Fe(e,t){return t===1?e:rt(e,t)}function ze(e,t){return!t||t<=0?e:at(e,t)}function ut(e,t=!1){if(!t)return e;let o=document.createElement("canvas");return o.width=e.width,o.height=e.height,o.getContext("2d").putImageData(e,0,0),o}function dt(e,t){let o,r;if(e instanceof ImageData)o=e.width,r=e.height;else if(e instanceof HTMLCanvasElement)o=e.width,r=e.height;else if(e instanceof HTMLImageElement)o=e.naturalWidth||e.width,r=e.naturalHeight||e.height;else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");let c=Math.max(1,Math.floor(o/t)),a=Math.max(1,Math.floor(r/t)),s=document.createElement("canvas");s.width=c,s.height=a;let i=s.getContext("2d");if(i.imageSmoothingEnabled=!1,e instanceof ImageData){let l=document.createElement("canvas");l.width=o,l.height=r,l.getContext("2d").putImageData(e,0,0),i.drawImage(l,0,0,c,a)}else i.drawImage(e,0,0,c,a);return{scaledImageData:i.getImageData(0,0,c,a),originalSize:{width:o,height:r},scaledCanvas:s}}function ht(e){let{scaledImageData:t,originalSize:o,scaledCanvas:r}=e;if(!t||!o||!r)throw new Error("upscaleImageStep requires scaledImageData, originalSize, and scaledCanvas from downscaleImageStep");let c=document.createElement("canvas");c.width=o.width,c.height=o.height;let a=c.getContext("2d");return a.imageSmoothingEnabled=!1,a.drawImage(r,0,0,o.width,o.height),c}async function Ue(e,t,o={}){let{returnCanvas:r=!1,searchSteps:c=9,numIterations:a=2,onProgress:s=null,colorLimit:i=null,contrast:h=1,edgeSharpness:l=.8,captureIntermediates:d=!1,useSplines:n=!1,splineDegree:f=2,splineSmoothness:v=.3}=o,g=d?[]:null,m=De(e),{width:p,height:S}=m;d&&g.push({name:"Original",canvas:ee(m)});let E=await st(m,{edgeSharpness:l,onProgress:s}),{edgeMap:x,usingGPU:y}=E,M=null;if(d){let O=function(W,Y,j,Z,q){let $=pe(W,Y,j),X=document.createElement("canvas");X.width=Z,X.height=q;let Q=X.getContext("2d");return Q.imageSmoothingEnabled=!1,Q.drawImage($,0,0,Y,j,0,0,Z,q),X};g.push({name:"Grayscale",canvas:Ge(m)});let P=Math.min(1,800/Math.max(p,S)),D=Math.round(p*P),G=Math.round(S*P),k=m;if(P<1){let W=document.createElement("canvas");W.width=D,W.height=G;let Y=W.getContext("2d"),j=ee(m);Y.drawImage(j,0,0,D,G),k=Y.getImageData(0,0,D,G)}let V=se(k,{edgeSharpness:l,captureIntermediates:!0});if(g.push({name:"Gradient Magnitude",canvas:O(V.intermediates.magnitude,D,G,p,S)}),g.push({name:"After NMS",canvas:O(V.intermediates.afterNMS,D,G,p,S)}),x&&x.length===p*S){let W=0;for(let Y=0;Y<x.length;Y++)x[Y]>0&&W++;W>0?(M=pe(x,p,S),g.push({name:"Edge Map",canvas:M})):(console.warn("Full-res edge map has no edges, using downscaled version for visualization"),M=O(V.intermediates.afterThreshold,D,G,p,S),g.push({name:"Edge Map",canvas:M}))}else console.warn("Full-res edge map invalid, using downscaled version for visualization"),M=O(V.intermediates.afterThreshold,D,G,p,S),g.push({name:"Edge Map",canvas:M})}let I=it(m,t),b=0;for(let R=0;R<x.length;R++)x[R]>0&&b++;let w=(b/x.length*100).toFixed(2);if(d){let R=ee(m);g.push({name:"Initial Grid",canvas:xe(R,I,"rgba(255, 0, 0, 1.0)",2)})}let A=.5+l*1.5,C=Math.max(1,t*.3*A),T=Math.max(c,Math.floor(9+l*16)),_=Math.max(a,Math.floor(2+l*3)),z=null;d&&(z={corners:I.corners.map(R=>R.map(P=>({x:P.x,y:P.y})))}),b===0&&console.warn("Edge map has no edges - grid optimization will have no effect");let U=d?Math.max(C,t*.5):C,H=d?Math.max(T,25):T,F=d?Math.max(_,4):_;if(lt({grid:I,edgeMap:x,imageData:m},{searchSteps:H,numIterations:F,stepSize:U,edgeSharpness:l,useSplines:n,splineDegree:f,splineSmoothness:v}),d){let R=I.corners.length,P=I.corners[0].length,D=Math.ceil(t);if(b>0)for(let G=1;G<R-1;G++)for(let k=1;k<P-1;k++){let V=I.corners[G][k],O=Math.floor(V.x),W=Math.floor(V.y),Y=0,j=0,Z=1/0;for(let q=1;q<=D;q++)for(let $=-q;$<=q;$++)for(let X=-q;X<=q;X++){let Q=O+X,ue=W+$;if(Q>=0&&Q<p&&ue>=0&&ue<S){let Je=ue*p+Q;if(x[Je]>0){let Ee=Math.sqrt(X*X+$*$);Ee<Z&&(Z=Ee,Y=X,j=$)}}}Z<1/0&&Z>0&&(V.x=O+Y,V.y=W+j)}}if(d){let R=ee(m);g.push({name:"Optimized Grid",canvas:xe(R,I,"rgba(0, 255, 0, 1.0)",2)})}s&&s({usingGPU:y});let L;n?L=Le(I,m,x,l,n,f):L=ct(m,x,t,l),L=Fe(L,h),L=ze(L,i);let N=ut(L,!0);return N._usingGPU=y,d?(g.push({name:"Final Result",canvas:N}),{canvas:N,intermediates:g,usingGPU:y}):r?N:L}function Xe(e){return new Promise((t,o)=>{let r=new Image;if(r.onload=()=>t(r),r.onerror=()=>o(new Error("Failed to load image")),e instanceof File){let c=new FileReader;c.onload=a=>{r.src=a.target.result},c.onerror=()=>o(new Error("Failed to read file")),c.readAsDataURL(e)}else r.src=e})}function ve(e,t,o={}){let{interpolation:r="nearest",fillMode:c="constant",fillValue:a=0,returnCanvas:s=!1}=o;if(t.length!==8)throw new Error("Transform matrix must have 8 elements [a1, a2, a3, b1, b2, b3, c1, c2]");let[i,h,l,d,n,f,v,g]=t,m,p,S;if(e instanceof ImageData)m=e.width,p=e.height,S=e.data;else{let I=document.createElement("canvas");if(e instanceof HTMLCanvasElement)I.width=e.width,I.height=e.height,I.getContext("2d").drawImage(e,0,0);else if(e instanceof HTMLImageElement)I.width=e.naturalWidth||e.width,I.height=e.naturalHeight||e.height,I.getContext("2d").drawImage(e,0,0);else throw new Error("Unsupported image type");m=I.width,p=I.height,S=I.getContext("2d").getImageData(0,0,m,p).data}let E=document.createElement("canvas");E.width=m,E.height=p;let x=E.getContext("2d"),y=x.createImageData(m,p),M=y.data;for(let I=0;I<p;I++)for(let b=0;b<m;b++){let w=b,A=I,C=v*w+g*A+1;if(Math.abs(C)<1e-4){let P=(I*m+b)*4;M[P]=a,M[P+1]=a,M[P+2]=a,M[P+3]=255;continue}let T=(i*w+h*A+l)/C,_=(d*w+n*A+f)/C,z=Ye(T,m,c),U=Ye(_,p,c),H,F,L,N;if(r==="nearest"){let P=Math.round(z),D=Math.round(U),G=te(S,P,D,m,p,a);H=G.r,F=G.g,L=G.b,N=G.a}else{let P=Math.floor(z),D=Math.floor(U),G=P+1,k=D+1,V=te(S,P,D,m,p,a),O=te(S,G,D,m,p,a),W=te(S,P,k,m,p,a),Y=te(S,G,k,m,p,a),j=z-P,Z=U-D,q=ye(V,O,j),$=ye(W,Y,j),X=ye(q,$,Z);H=X.r,F=X.g,L=X.b,N=X.a}let R=(I*m+b)*4;M[R]=H,M[R+1]=F,M[R+2]=L,M[R+3]=N}return x.putImageData(y,0,0),s?E:y}function Ye(e,t,o){if(o==="constant")return e;if(o==="reflect"){if(e<0){if(t<=1)return 0;let r=2*t;e<-r&&(e=e+r*Math.floor(-e/r)),e=e<-t?e+r:-e-1}else if(e>t-1){if(t<=1)return 0;let r=2*t;e=e-r*Math.floor(e/r),e>=t&&(e=r-e-1)}return Math.max(0,Math.min(t-1,e))}else if(o==="wrap"){if(e<0){if(t<=1)return 0;let r=t-1;e=e+t*(Math.floor(-e/r)+1)}else if(e>t-1){if(t<=1)return 0;let r=t-1;e=e-t*Math.floor(e/r)}return Math.max(0,Math.min(t-1,e))}else if(o==="nearest")return Math.max(0,Math.min(t-1,e));return e}function te(e,t,o,r,c,a){if(t>=0&&t<r&&o>=0&&o<c){let s=(o*r+t)*4;return{r:e[s],g:e[s+1],b:e[s+2],a:e[s+3]}}else return{r:a,g:a,b:a,a:255}}function ye(e,t,o){return{r:Math.round(e.r+(t.r-e.r)*o),g:Math.round(e.g+(t.g-e.g)*o),b:Math.round(e.b+(t.b-e.b)*o),a:Math.round(e.a+(t.a-e.a)*o)}}function ke(e,t,o){let r=Math.cos(e),c=Math.sin(e),a=t-t*r+o*c,s=o-t*c-o*r;return[r,-c,a,c,r,s,0,0]}function Ve(e,t,o,r){return[e,0,o*(1-e),0,t,r*(1-t),0,0]}var u={imageInput:document.getElementById("imageInput"),pixelSizeSlider:document.getElementById("pixelSize"),pixelSizeNumber:document.getElementById("pixelSizeNumber"),pixelSizeValue:document.getElementById("pixelSizeValue"),colorLimitSlider:document.getElementById("colorLimit"),colorLimitNumber:document.getElementById("colorLimitNumber"),colorLimitValue:document.getElementById("colorLimitValue"),colorLimitGroup:document.getElementById("colorLimitGroup"),useColorLimit:document.getElementById("useColorLimit"),useEdgeAware:document.getElementById("useEdgeAware"),gpuIndicator:document.getElementById("gpuIndicator"),gpuStatus:document.getElementById("gpuStatus"),edgeSharpnessGroup:document.getElementById("edgeSharpnessGroup"),edgeSharpnessSlider:document.getElementById("edgeSharpness"),edgeSharpnessNumber:document.getElementById("edgeSharpnessNumber"),edgeSharpnessValue:document.getElementById("edgeSharpnessValue"),gridResolutionGroup:document.getElementById("gridResolutionGroup"),gridResolutionSlider:document.getElementById("gridResolution"),gridResolutionNumber:document.getElementById("gridResolutionNumber"),gridResolutionValue:document.getElementById("gridResolutionValue"),currentGridResolution:document.getElementById("currentGridResolution"),numPassesGroup:document.getElementById("numPassesGroup"),numPassesSlider:document.getElementById("numPasses"),numPassesNumber:document.getElementById("numPassesNumber"),numPassesValue:document.getElementById("numPassesValue"),showStepsGroup:document.getElementById("showStepsGroup"),showAlgorithmSteps:document.getElementById("showAlgorithmSteps"),useSplinesGroup:document.getElementById("useSplinesGroup"),useSplines:document.getElementById("useSplines"),splineSmoothnessGroup:document.getElementById("splineSmoothnessGroup"),splineSmoothnessSlider:document.getElementById("splineSmoothness"),splineSmoothnessNumber:document.getElementById("splineSmoothnessNumber"),splineSmoothnessValue:document.getElementById("splineSmoothnessValue"),stepNavigation:document.getElementById("stepNavigation"),stepLabel:document.getElementById("stepLabel"),stepCounter:document.getElementById("stepCounter"),stepPrev:document.getElementById("stepPrev"),stepNext:document.getElementById("stepNext"),contrastGroup:document.getElementById("contrastGroup"),contrastSlider:document.getElementById("contrast"),contrastNumber:document.getElementById("contrastNumber"),contrastValue:document.getElementById("contrastValue"),useProjection:document.getElementById("useProjection"),rotationGroup:document.getElementById("rotationGroup"),rotationAngleSlider:document.getElementById("rotationAngle"),rotationAngleNumber:document.getElementById("rotationAngleNumber"),rotationAngleValue:document.getElementById("rotationAngleValue"),useScaling:document.getElementById("useScaling"),scalingGroup:document.getElementById("scalingGroup"),scalingGroupY:document.getElementById("scalingGroupY"),scaleXSlider:document.getElementById("scaleX"),scaleXNumber:document.getElementById("scaleXNumber"),scaleXValue:document.getElementById("scaleXValue"),scaleYSlider:document.getElementById("scaleY"),scaleYNumber:document.getElementById("scaleYNumber"),scaleYValue:document.getElementById("scaleYValue"),pixelateBtn:document.getElementById("pixelateBtn"),mainCanvas:document.getElementById("mainCanvas"),canvasTitle:document.getElementById("canvasTitle")},B={intermediates:[],currentStep:0},oe=u.mainCanvas.getContext("2d"),K=null,ne=null;function le(e,t,o,r,c,a){let s=()=>{let h=e.value;t.value=h,o.textContent=h},i=h=>{let l=Math.max(r,Math.min(c,parseInt(h.target.value)||a));e.value=l,t.value=l,o.textContent=l};e.addEventListener("input",s),t.addEventListener("input",i),s()}le(u.colorLimitSlider,u.colorLimitNumber,u.colorLimitValue,2,256,32);le(u.numPassesSlider,u.numPassesNumber,u.numPassesValue,1,10,3);function re(e,t,o,r,c,a){let s=()=>{let h=parseFloat(e.value);t.value=h.toFixed(1),o.textContent=h.toFixed(1)},i=h=>{let l=Math.max(r,Math.min(c,parseFloat(h.target.value)||a));e.value=l,t.value=l.toFixed(1),o.textContent=l.toFixed(1)};e.addEventListener("input",s),t.addEventListener("input",i),s()}re(u.edgeSharpnessSlider,u.edgeSharpnessNumber,u.edgeSharpnessValue,0,1,.8);re(u.contrastSlider,u.contrastNumber,u.contrastValue,.5,2,1);le(u.rotationAngleSlider,u.rotationAngleNumber,u.rotationAngleValue,0,360,0);re(u.scaleXSlider,u.scaleXNumber,u.scaleXValue,.1,3,1);re(u.scaleYSlider,u.scaleYNumber,u.scaleYValue,.1,3,1);re(u.splineSmoothnessSlider,u.splineSmoothnessNumber,u.splineSmoothnessValue,0,1,.3);var Se=!1,Me=!1;function ae(){if(!K){u.currentGridResolution.textContent="-";return}let e=parseInt(u.pixelSizeSlider.value),t=Math.ceil(K.width/e),o=Math.ceil(K.height/e);if(u.currentGridResolution.textContent=`${t} \xD7 ${o}`,!Me){Se=!0;let r=Math.round((t+o)/2),c=Math.max(10,Math.min(500,r));u.gridResolutionSlider.value=c,u.gridResolutionNumber.value=c,u.gridResolutionValue.textContent=c,Se=!1}}function We(){if(!K||Se)return;Me=!0;let e=parseInt(u.gridResolutionSlider.value),t=Math.max(K.width,K.height),o=Math.max(2,Math.ceil(t/e)),r=Math.max(2,Math.min(128,o));u.pixelSizeSlider.value=r,u.pixelSizeNumber.value=r,u.pixelSizeValue.textContent=r,ae(),Me=!1}le(u.gridResolutionSlider,u.gridResolutionNumber,u.gridResolutionValue,10,500,100);(function(){let e=()=>{let o=u.pixelSizeSlider.value;u.pixelSizeNumber.value=o,u.pixelSizeValue.textContent=o,ae()},t=o=>{let r=Math.max(2,Math.min(128,parseInt(o.target.value)||3));u.pixelSizeSlider.value=r,u.pixelSizeNumber.value=r,u.pixelSizeValue.textContent=r,ae()};u.pixelSizeSlider.addEventListener("input",e),u.pixelSizeNumber.addEventListener("input",t),e()})();u.gridResolutionSlider.addEventListener("input",()=>{let e=parseInt(u.gridResolutionSlider.value);u.gridResolutionNumber.value=e,u.gridResolutionValue.textContent=e,We()});u.gridResolutionNumber.addEventListener("input",()=>{let e=Math.max(10,Math.min(500,parseInt(u.gridResolutionNumber.value)||100));u.gridResolutionSlider.value=e,u.gridResolutionValue.textContent=e,We()});function He(){let e=u.useSplines.checked;u.splineSmoothnessGroup.style.display=e?"flex":"none"}function Oe(){let e=u.useEdgeAware.checked;u.edgeSharpnessGroup.style.display=e?"flex":"none",u.gridResolutionGroup.style.display=e?"flex":"none",u.numPassesGroup.style.display=e?"flex":"none",u.showStepsGroup.style.display=e?"flex":"none",u.useSplinesGroup.style.display=e?"flex":"none",u.gpuIndicator.style.display=e?"block":"none",e||(u.gpuStatus.textContent="",u.stepNavigation.classList.remove("active"),B.intermediates=[]),He(),ae()}function qe(){let e=u.useColorLimit.checked;u.colorLimitGroup.style.display=e?"flex":"none"}function je(){let e=u.useProjection.checked;u.rotationGroup.style.display=e?"flex":"none"}function $e(){let e=u.useScaling.checked;u.scalingGroup.style.display=e?"flex":"none",u.scalingGroupY.style.display=e?"flex":"none"}function ie(e){let t=e,o=e.width/2,r=e.height/2;if(u.useScaling.checked){let c=parseFloat(u.scaleXSlider.value),a=parseFloat(u.scaleYSlider.value),s=Ve(c,a,o,r);t=ve(t,s,{returnCanvas:!0,interpolation:"nearest"})}if(u.useProjection.checked){let c=parseFloat(u.rotationAngleSlider.value)*Math.PI/180,a=ke(c,o,r);t=ve(t,a,{returnCanvas:!0,interpolation:"nearest"})}return t}function ce(e){if(!B.intermediates.length)return;B.currentStep=Math.max(0,Math.min(e,B.intermediates.length-1));let t=B.intermediates[B.currentStep],o=t.canvas;if(t.name==="Final Result"){let r=t.originalCanvas||t.canvas;o=ie(r)}u.mainCanvas.width=o.width,u.mainCanvas.height=o.height,oe.drawImage(o,0,0),u.canvasTitle.textContent=t.name,u.stepLabel.textContent=t.name,u.stepCounter.textContent=`Step ${B.currentStep+1} of ${B.intermediates.length}`}function Ke(){if(!B.intermediates.length)return;let e=(B.currentStep+1)%B.intermediates.length;ce(e)}function Ze(){if(!B.intermediates.length)return;let e=(B.currentStep-1+B.intermediates.length)%B.intermediates.length;ce(e)}function mt(e){B.intermediates=e,B.currentStep=e.length-1,u.stepNavigation.classList.add("active"),ce(B.currentStep)}u.stepPrev.addEventListener("click",Ze);u.stepNext.addEventListener("click",Ke);document.addEventListener("keydown",e=>{B.intermediates.length!==0&&(e.key==="ArrowLeft"?Ze():e.key==="ArrowRight"&&Ke())});qe();Oe();je();$e();u.useColorLimit.addEventListener("change",qe);u.useEdgeAware.addEventListener("change",Oe);u.useSplines.addEventListener("change",He);u.useProjection.addEventListener("change",je);u.useScaling.addEventListener("change",$e);u.imageInput.addEventListener("change",async e=>{let t=e.target.files[0];if(!t){u.pixelateBtn.disabled=!0;return}try{u.pixelateBtn.disabled=!0,u.pixelateBtn.textContent="Loading...";let o=await Xe(t);K=o,u.mainCanvas.width=o.width,u.mainCanvas.height=o.height,oe.drawImage(o,0,0),u.canvasTitle.textContent="Original Image",u.stepNavigation.classList.remove("active"),B.intermediates=[],ae(),u.pixelateBtn.disabled=!1,u.pixelateBtn.textContent="Pixelate Image"}catch(o){alert("Failed to load image: "+o.message),u.pixelateBtn.disabled=!0,u.pixelateBtn.textContent="Pixelate Image"}});u.pixelateBtn.addEventListener("click",async()=>{if(u.pixelateBtn.disabled)return;if(u.pixelateBtn.disabled=!0,!K){alert("Please upload an image first."),u.pixelateBtn.disabled=!1;return}let e=parseInt(u.pixelSizeSlider.value),t=u.useColorLimit.checked?parseInt(u.colorLimitSlider.value):null,o=u.useEdgeAware.checked;try{u.pixelateBtn.textContent=o?"Processing (Edge-Aware)...":"Processing...",await new Promise(c=>setTimeout(c,0));let r;if(o){let c=parseFloat(u.contrastSlider.value),a=parseFloat(u.edgeSharpnessSlider.value),s=parseInt(u.numPassesSlider.value),i=u.showAlgorithmSteps.checked;u.gpuStatus.textContent="Processing...";let h=u.useSplines.checked,l=parseFloat(u.splineSmoothnessSlider.value),d=await Ue(K,e,{returnCanvas:!0,searchSteps:9,numIterations:s,colorLimit:t,contrast:c,edgeSharpness:a,useSplines:h,splineDegree:2,splineSmoothness:l,captureIntermediates:i,onProgress:n=>{n.usingGPU?(u.gpuStatus.textContent="\u2713 Using GPU acceleration",u.gpuStatus.style.color="#4caf50"):(u.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",u.gpuStatus.style.color="#ff9800")}});if(i&&d.intermediates){if(r=d.canvas,d.intermediates.length>0){let n=d.intermediates[d.intermediates.length-1];n.name==="Final Result"&&(n.originalCanvas=n.canvas)}mt(d.intermediates),d.usingGPU?(u.gpuStatus.textContent="\u2713 Using GPU acceleration",u.gpuStatus.style.color="#4caf50"):(u.gpuStatus.textContent="\u26A0 Using CPU (for visualization)",u.gpuStatus.style.color="#ff9800")}else{r=d,ne=r,u.stepNavigation.classList.remove("active"),B.intermediates=[];let n=ie(r);u.mainCanvas.width=n.width,u.mainCanvas.height=n.height,oe.drawImage(n,0,0),u.canvasTitle.textContent="Pixelated Image",d._usingGPU!==void 0&&(d._usingGPU?(u.gpuStatus.textContent="\u2713 Using GPU acceleration",u.gpuStatus.style.color="#4caf50"):(u.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",u.gpuStatus.style.color="#ff9800"))}}else{let c=parseFloat(u.contrastSlider.value);await new Promise(s=>requestAnimationFrame(s)),r=_e(K,e,{returnCanvas:!0,colorLimit:t,contrast:c}),u.stepNavigation.classList.remove("active"),B.intermediates=[],ne=r;let a=ie(r);u.mainCanvas.width=a.width,u.mainCanvas.height=a.height,oe.drawImage(a,0,0),u.canvasTitle.textContent="Pixelated Image"}u.pixelateBtn.disabled=!1,u.pixelateBtn.textContent="Pixelate Image"}catch(r){alert("Failed to pixelate image: "+r.message),u.pixelateBtn.disabled=!1,u.pixelateBtn.textContent="Pixelate Image"}});function J(){if(!(!ne&&!B.intermediates.length)){if(B.intermediates.length>0)ce(B.currentStep);else if(ne){let e=ie(ne);u.mainCanvas.width=e.width,u.mainCanvas.height=e.height,oe.drawImage(e,0,0)}}}u.rotationAngleSlider.addEventListener("input",J);u.rotationAngleNumber.addEventListener("input",J);u.useProjection.addEventListener("change",J);u.scaleXSlider.addEventListener("input",J);u.scaleXNumber.addEventListener("input",J);u.scaleYSlider.addEventListener("input",J);u.scaleYNumber.addEventListener("input",J);u.useScaling.addEventListener("change",J);</script></body></html>