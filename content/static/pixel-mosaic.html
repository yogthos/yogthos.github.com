<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pixel Mosaic - Demo</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:30px}.control-section{background:#f8f9fa;border-radius:6px;padding:12px;border:1px solid #e9ecef}.control-section-title{font-size:.8em;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #dee2e6}.control-section-grid{display:grid;grid-template-columns:1fr;gap:12px}.control-group{display:flex;flex-direction:column;gap:6px;min-height:50px;transition:opacity .2s ease}.control-group[style*="display: none"]{min-height:0;opacity:0}label{font-weight:600;color:#555;font-size:.85em}input[type=checkbox]{margin-right:8px;cursor:pointer;width:18px;height:18px;accent-color:#667eea}label:has(input[type=checkbox]){display:flex;align-items:center;cursor:pointer;user-select:none}input[type=range]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:0;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;transition:background .2s}input[type=range]::-webkit-slider-thumb:hover{background:#5568d3}input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;border:none;transition:background .2s}input[type=range]::-moz-range-thumb:hover{background:#5568d3}input[type=number]{width:70px;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:.85em}input[type=number]:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.1)}input[type=file]{padding:10px;border:2px dashed #667eea;border-radius:4px;cursor:pointer;background:#fff;transition:all .2s}input[type=file]:hover{border-color:#5568d3;background:#f8f9ff}button{padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:6px;font-size:.9em;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 4px rgba(102,126,234,.2)}button:hover:not(:disabled){background:#5568d3;box-shadow:0 4px 8px rgba(102,126,234,.3);transform:translateY(-1px)}button:active:not(:disabled){transform:translateY(0);box-shadow:0 2px 4px rgba(102,126,234,.2)}button:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;transform:none}.canvas-container{display:flex;flex-direction:column;align-items:center;margin-top:20px;margin-bottom:20px}.canvas-wrapper{text-align:center;width:100%}.canvas-wrapper h2{margin-bottom:12px;color:#333;font-size:1.1em}canvas{max-width:100%;height:auto;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}.info{margin-top:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;color:#1565c0}.step-navigation{display:none;justify-content:center;align-items:center;gap:15px;margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px}.step-navigation.active{display:flex}.step-navigation button{padding:8px 16px;font-size:.9em;min-width:90px}.step-label{font-weight:600;color:#333;font-size:1em;min-width:180px;text-align:center}.step-counter{color:#666;font-size:.85em}.github-link{margin-top:30px;text-align:center;padding:20px}.github-link a{display:inline-flex;align-items:center;gap:8px;color:#667eea;text-decoration:none;font-weight:600;font-size:1.1em;transition:color .3s}.github-link a:hover{color:#5568d3}.github-link a::before{content:'üîó';font-size:1.2em}</style></head><body><div class=container><h1>üé® Pixel Mosaic</h1><div class=control-section style="max-width:400px;margin:0 auto 20px"><div class=control-section-title>üì§ Image Upload</div><div class=control-section-grid><div class=control-group><label for=imageInput>Upload Image</label> <input type=file id=imageInput accept=image/*></div></div></div><div class=canvas-container><div class=canvas-wrapper><h2 id=canvasTitle>Upload an image to begin</h2><canvas id=mainCanvas></canvas><div style=margin-top:15px><button id=pixelateBtn disabled=disabled>Pixelate Image</button></div><div class=step-navigation id=stepNavigation><button id=stepPrev>‚Üê Previous</button><div><div class=step-label id=stepLabel>Original</div><div class=step-counter id=stepCounter></div></div><button id=stepNext>Next ‚Üí</button></div></div></div><div class=controls><div class=control-section><div class=control-section-title>üé® Pixelation</div><div class=control-section-grid><div class=control-group><label for=pixelSize>Pixel Size: <span id=pixelSizeValue>3</span></label> <input type=range id=pixelSize min=2 max=128 value=3> <input type=number id=pixelSizeNumber min=2 max=128 value=3></div><div class=control-group><label for=contrast>Contrast: <span id=contrastValue>1.0</span></label> <input type=range id=contrast min=0.5 max=2 step=0.1 value=1.0> <input type=number id=contrastNumber min=0.5 max=2 step=0.1 value=1.0></div><div class=control-group><label><input type=checkbox id=useColorLimit checked=checked> Enable Color Limiting</label></div><div class=control-group id=colorLimitGroup><label for=colorLimit>Color Limit: <span id=colorLimitValue>32</span></label> <input type=range id=colorLimit min=2 max=256 value=32> <input type=number id=colorLimitNumber min=2 max=256 value=32></div></div></div><div class=control-section><div class=control-section-title>üîç Edge-Aware</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useEdgeAware> Enable Edge-Aware</label><div id=gpuIndicator style=display:none;margin-top:4px;font-size:.75em;color:#666><span id=gpuStatus>Checking GPU...</span></div></div><div class=control-group id=edgeSharpnessGroup style=display:none><label for=edgeSharpness>Edge Sharpness: <span id=edgeSharpnessValue>0.8</span></label> <input type=range id=edgeSharpness min=0 max=1 step=0.1 value=0.8> <input type=number id=edgeSharpnessNumber min=0 max=1 step=0.1 value=0.8></div><div class=control-group id=numPassesGroup style=display:none><label for=numPasses>Optimization Passes: <span id=numPassesValue>3</span></label> <input type=range id=numPasses min=1 max=10 value=3> <input type=number id=numPassesNumber min=1 max=10 value=3></div><div class=control-group id=showStepsGroup style=display:none><label><input type=checkbox id=showAlgorithmSteps> Show Algorithm Steps</label></div></div></div><div class=control-section><div class=control-section-title>üîÑ Transform</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useProjection> Apply Rotation</label></div><div class=control-group id=rotationGroup style=display:none><label for=rotationAngle>Rotation: <span id=rotationAngleValue>0</span>¬∞</label> <input type=range id=rotationAngle min=0 max=360 value=0> <input type=number id=rotationAngleNumber min=0 max=360 value=0></div><div class=control-group><label><input type=checkbox id=useScaling> Apply Scaling</label></div><div class=control-group id=scalingGroup style=display:none><label for=scaleX>Scale X: <span id=scaleXValue>1.0</span></label> <input type=range id=scaleX min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleXNumber min=0.1 max=3 step=0.1 value=1.0></div><div class=control-group id=scalingGroupY style=display:none><label for=scaleY>Scale Y: <span id=scaleYValue>1.0</span></label> <input type=range id=scaleY min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleYNumber min=0.1 max=3 step=0.1 value=1.0></div></div></div></div><div class=info><strong>How to use:</strong> Upload an image, adjust the pixel size and color limit, then click "Pixelate Image". Enable "Edge-Aware Pixelation" for adaptive grid optimization with adjustable edge sharpness. Check "Show Algorithm Steps" to visualize the edge detection process.</div><div class=github-link><a href=https://github.com/yogthos/pixel-mosaic target=_blank rel="noopener noreferrer">View on GitHub</a></div></div><script type=module>function lt(t,e,o,a){let c=new Float32Array(o*a);for(let r=1;r<a-1;r++)for(let s=1;s<o-1;s++){let l=r*o+s,u=t[l],i=e[l];if(u===0){c[l]=0;continue}let d=i;for(;d<0;)d+=2*Math.PI;for(;d>=2*Math.PI;)d-=2*Math.PI;let n,m;d>=0&&d<Math.PI/8||d>=15*Math.PI/8&&d<2*Math.PI||d>=7*Math.PI/8&&d<9*Math.PI/8?(n=t[l-1],m=t[l+1]):d>=Math.PI/8&&d<3*Math.PI/8||d>=9*Math.PI/8&&d<11*Math.PI/8?(n=t[(r-1)*o+(s+1)],m=t[(r+1)*o+(s-1)]):d>=3*Math.PI/8&&d<5*Math.PI/8||d>=11*Math.PI/8&&d<13*Math.PI/8?(n=t[(r-1)*o+s],m=t[(r+1)*o+s]):(n=t[(r-1)*o+(s-1)],m=t[(r+1)*o+(s+1)]),u>=n&&u>=m?c[l]=u:c[l]=0}return c}function ct(t,e,o,a={}){let{threshold:c=.1,highThreshold:r=null,lowThreshold:s=null,usePercentile:l=!0,binarize:u=!0}=a,i=new Float32Array(t.length),d=c;if(l&&c>0){let n=[];for(let m=0;m<t.length;m++)t[m]>0&&n.push(t[m]);if(n.length>0){n.sort((p,f)=>p-f);let m=c,x=Math.ceil(n.length*m),g=Math.min(n.length-1,Math.max(0,x));d=n[g]}}if(r!==null&&s!==null&&r>s){let n=r,m=s;if(l){let p=[];for(let f=0;f<t.length;f++)t[f]>0&&p.push(t[f]);if(p.length>0){p.sort((M,I)=>M-I);let f=1-r,E=1-s,v=Math.floor(p.length*f),y=Math.floor(p.length*E);n=p[Math.max(0,v-1)]||0,m=p[Math.max(0,y-1)]||0}}let x=new Set,g=new Set;for(let p=0;p<t.length;p++)t[p]>=n?(x.add(p),i[p]=u?1:t[p]):(t[p]>=m&&g.add(p),i[p]=0);for(let p=0;p<t.length;p++)if(g.has(p)){let f=!1,E=p%e,v=Math.floor(p/e);for(let y=-1;y<=1&&!f;y++)for(let M=-1;M<=1&&!f;M++){if(M===0&&y===0)continue;let I=E+M,b=v+y;if(I>=0&&I<e&&b>=0&&b<o){let S=b*e+I;x.has(S)&&(f=!0)}}f&&(i[p]=u?1:t[p])}}else for(let n=0;n<t.length;n++)t[n]>=d?i[n]=u?1:t[n]:i[n]=0;return i}function nt(t,e={}){let{applyNMS:o=!0,threshold:a=null,edgeSharpness:c=.8,highThreshold:r=null,lowThreshold:s=null,captureIntermediates:l=!1}=e;a===null&&(a=.1+c*.5);let{data:u,width:i,height:d}=t,n=new Float32Array(i*d),m=new Float32Array(i*d),x=null;l&&(x=new Float32Array(i*d));let g=[-1,0,1,-2,0,2,-1,0,1],p=[-1,-2,-1,0,0,0,1,2,1];for(let M=1;M<d-1;M++)for(let I=1;I<i-1;I++){let b=0,S=0;for(let A=-1;A<=1;A++)for(let U=-1;U<=1;U++){let Y=((M+A)*i+(I+U))*4,R=(u[Y]+u[Y+1]+u[Y+2])/3,B=(A+1)*3+(U+1);b+=R*g[B],S+=R*p[B],l&&A===0&&U===0&&(x[M*i+I]=R/255)}let C=Math.sqrt(b*b+S*S);n[M*i+I]=C;let P=Math.atan2(S,b)+Math.PI/2;m[M*i+I]=P}if(l){for(let M=0;M<d;M++)for(let I=0;I<i;I++)if(M===0||M===d-1||I===0||I===i-1){let b=(M*i+I)*4,S=(u[b]+u[b+1]+u[b+2])/3;x[M*i+I]=S/255}}let f=0;for(let M=0;M<n.length;M++)n[M]>f&&(f=n[M]);if(f>0)for(let M=0;M<n.length;M++)n[M]/=f;let E=null;l&&(E=new Float32Array(n));let v=n,y=null;return o&&(v=lt(n,m,i,d),l&&(y=new Float32Array(v))),v=ct(v,i,d,{threshold:a,highThreshold:r,lowThreshold:s}),l?{edgeMap:v,intermediates:{grayscale:x,magnitude:E,afterNMS:y||E,afterThreshold:v},width:i,height:d}:v}function ut(t,e,o,a,c,r=!1){if(a=Math.max(0,Math.min(e-1,a)),c=Math.max(0,Math.min(o-1,c)),!r){let b=Math.round(a),C=Math.round(c)*e+b;return t[C]||0}let s=Math.floor(a),l=Math.floor(c),u=Math.min(e-1,s+1),i=Math.min(o-1,l+1),d=a-s,n=c-l,m=l*e+s,x=i*e+s,g=l*e+u,p=i*e+u,f=t[m]||0,E=t[x]||0,v=t[g]||0,y=t[p]||0,M=f*(1-d)+v*d,I=E*(1-d)+y*d;return M*(1-n)+I*n}function zt(t){let e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return null;let o=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;

    void main() {
      gl_Position = vec4(a_position, 0.0, 1.0);
      v_texCoord = a_texCoord;
    }
  `,a=`
    precision mediump float;
    uniform sampler2D u_image;
    uniform vec2 u_textureSize;
    varying vec2 v_texCoord;

    void main() {
      vec2 onePixel = vec2(1.0) / u_textureSize;

      // Sample neighboring pixels for Sobel operator
      float tl = texture2D(u_image, v_texCoord + vec2(-onePixel.x, -onePixel.y)).r;
      float tm = texture2D(u_image, v_texCoord + vec2( 0.0, -onePixel.y)).r;
      float tr = texture2D(u_image, v_texCoord + vec2( onePixel.x, -onePixel.y)).r;
      float ml = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  0.0)).r;
      float mr = texture2D(u_image, v_texCoord + vec2( onePixel.x,  0.0)).r;
      float bl = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  onePixel.y)).r;
      float bm = texture2D(u_image, v_texCoord + vec2( 0.0,  onePixel.y)).r;
      float br = texture2D(u_image, v_texCoord + vec2( onePixel.x,  onePixel.y)).r;

      // Sobel X kernel: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
      float sobelX = -tl + tr - 2.0 * ml + 2.0 * mr - bl + br;

      // Sobel Y kernel: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
      float sobelY = -tl - 2.0 * tm - tr + bl + 2.0 * bm + br;

      // Calculate gradient magnitude
      float magnitude = sqrt(sobelX * sobelX + sobelY * sobelY);

      // Normalize magnitude to [0, 1] range
      // Max theoretical magnitude for normalized [0,1] input with Sobel is ~5.66
      // Use 6.0 as divisor to ensure we stay in [0, 1] range
      float magnitudeNormalized = magnitude / 6.0;

      // Calculate edge direction (perpendicular to gradient)
      // atan2 returns [-\u03C0, \u03C0], we add \u03C0/2 and normalize to [0, 2\u03C0)
      float direction = atan(sobelY, sobelX) + 3.14159265359 / 2.0;
      if (direction < 0.0) direction += 2.0 * 3.14159265359;

      // Normalize direction to [0, 1] for storage in texture
      float directionNormalized = direction / (2.0 * 3.14159265359);

      // Output: R = magnitude (normalized), G = direction (normalized), B = unused, A = 1.0
      gl_FragColor = vec4(magnitudeNormalized, directionNormalized, 0.0, 1.0);
    }
  `;function c(n,m,x){let g=n.createShader(m);return n.shaderSource(g,x),n.compileShader(g),n.getShaderParameter(g,n.COMPILE_STATUS)?g:(console.error("Shader compile error:",n.getShaderInfoLog(g)),n.deleteShader(g),null)}function r(n,m,x){let g=n.createProgram();return n.attachShader(g,m),n.attachShader(g,x),n.linkProgram(g),n.getProgramParameter(g,n.LINK_STATUS)?g:(console.error("Program link error:",n.getProgramInfoLog(g)),n.deleteProgram(g),null)}let s=c(e,e.VERTEX_SHADER,o),l=c(e,e.FRAGMENT_SHADER,a);if(!s||!l)return null;let u=r(e,s,l);if(!u)return null;let i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);let d=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),{gl:e,program:u,positionBuffer:i,texCoordBuffer:d}}function kt(t,e){let{width:o,height:a,data:c}=e,r=new Uint8Array(o*a);for(let l=0;l<c.length;l+=4){let u=Math.round(.299*c[l]+.587*c[l+1]+.114*c[l+2]);r[l/4]=u}let s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,o,a,0,t.LUMINANCE,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),s}function vt(t,e={}){let{applyNMS:o=!0,threshold:a=null,edgeSharpness:c=.8,highThreshold:r=null,lowThreshold:s=null}=e;a===null&&(a=.02+c*.18);let{width:l,height:u}=t,i=document.createElement("canvas");i.width=l,i.height=u;let d=zt(i);if(!d)return console.warn("WebGL not available, falling back to CPU"),null;let{gl:n,program:m,positionBuffer:x,texCoordBuffer:g}=d,p=kt(n,t);n.viewport(0,0,l,u),n.useProgram(m);let f=n.getAttribLocation(m,"a_position"),E=n.getAttribLocation(m,"a_texCoord");n.bindBuffer(n.ARRAY_BUFFER,x),n.enableVertexAttribArray(f),n.vertexAttribPointer(f,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,g),n.enableVertexAttribArray(E),n.vertexAttribPointer(E,2,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,p),n.uniform1i(n.getUniformLocation(m,"u_image"),0),n.uniform2f(n.getUniformLocation(m,"u_textureSize"),l,u);let v=n.createTexture();n.bindTexture(n.TEXTURE_2D,v),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,l,u,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);let y=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,y),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,v,0);let M=n.checkFramebufferStatus(n.FRAMEBUFFER);if(M!==n.FRAMEBUFFER_COMPLETE)return console.error("WebGL framebuffer incomplete:",M),n.deleteTexture(p),n.deleteTexture(v),n.deleteFramebuffer(y),null;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,p),n.drawArrays(n.TRIANGLES,0,6);let I=n.getError();if(I!==n.NO_ERROR)return console.error("WebGL error during rendering:",I),n.deleteTexture(p),n.deleteTexture(v),n.deleteFramebuffer(y),null;let b=new Uint8Array(l*u*4);n.readPixels(0,0,l,u,n.RGBA,n.UNSIGNED_BYTE,b);let S=new Float32Array(l*u),C=new Float32Array(l*u);for(let A=0;A<l*u;A++){S[A]=b[A*4]/255;let U=b[A*4+1]/255;C[A]=U*2*Math.PI}let P=S;return o&&(P=lt(S,C,l,u)),P=ct(P,l,u,{threshold:a,highThreshold:r,lowThreshold:s}),n.deleteTexture(p),n.deleteTexture(v),n.deleteFramebuffer(y),P}function Et(t,e,o){let a=[[o[0],o[1]],[o[1],o[2]],[o[2],o[3]],[o[3],o[0]]],c=null;for(let[r,s]of a){let l=s.x-r.x,u=s.y-r.y,i=t-r.x,d=e-r.y,n=l*d-u*i;if(Math.abs(n)<1e-10)continue;let m=n>0?"left":"right";if(c===null)c=m;else if(c!==m)return!1}return!0}var dt=class{constructor(e,o){this.x=e,this.y=o,this.originalX=e,this.originalY=o}reset(){this.x=this.originalX,this.y=this.originalY}},ht=class{constructor(e){this.corners=e}getBounds(){let e=1/0,o=1/0,a=-1/0,c=-1/0;for(let r of this.corners)e=Math.min(e,r.x),o=Math.min(o,r.y),a=Math.max(a,r.x),c=Math.max(c,r.y);return{minX:e,minY:o,maxX:a,maxY:c}}getAverageColor(e){let{data:o,width:a}=e,c=this.getBounds(),r=Math.max(0,Math.floor(c.minX)),s=Math.max(0,Math.floor(c.minY)),l=Math.min(a-1,Math.floor(c.maxX)),u=Math.min(e.height-1,Math.floor(c.maxY)),i=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],d=Math.max(1,Math.floor(Math.min((l-r)/10,(u-s)/10,4))),n=0,m=0,x=0,g=0,p=0;for(let f=s;f<=u;f+=d)for(let E=r;E<=l;E+=d){let v=E+.5,y=f+.5;if(Et(v,y,i)){let M=(f*a+E)*4;n+=o[M],m+=o[M+1],x+=o[M+2],g+=o[M+3],p++}}if(p===0)for(let f=s;f<=u;f++)for(let E=r;E<=l;E++){let v=(f*a+E)*4;n+=o[v],m+=o[v+1],x+=o[v+2],g+=o[v+3],p++}return p===0?{r:0,g:0,b:0,a:255}:{r:Math.round(n/p),g:Math.round(m/p),b:Math.round(x/p),a:Math.round(g/p)}}getBlendedColor(e,o){let{data:a,width:c}=e,r=this.getBounds(),s=Math.max(0,Math.floor(r.minX)),l=Math.max(0,Math.floor(r.minY)),u=Math.min(c-1,Math.floor(r.maxX)),i=Math.min(e.height-1,Math.floor(r.maxY)),d=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],n=Math.max(1,Math.floor(Math.min((u-s)/15,(i-l)/15,2))),m=[],x=0,g=0,p=0,f=0;for(let C=l;C<=i;C+=n)for(let P=s;P<=u;P+=n){let A=P+.5,U=C+.5;if(Et(A,U,d)){let Y=(C*c+P)*4,R=a[Y],B=a[Y+1],_=a[Y+2],w=a[Y+3];m.push({r:R,g:B,b:_,a:w}),x+=R,g+=B,p+=_,f+=w}}if(m.length===0)return this.getAverageColor(e);let E=m.length;x=Math.round(x/E),g=Math.round(g/E),p=Math.round(p/E),f=Math.round(f/E),m.sort((C,P)=>C.r+C.g+C.b-(P.r+P.g+P.b));let v=Math.floor(m.length/2),y=m[v].r,M=m[v].g,I=m[v].b,b=m[v].a,S=o;return{r:Math.round(x*(1-S)+y*S),g:Math.round(g*(1-S)+M*S),b:Math.round(p*(1-S)+I*S),a:Math.round(f*(1-S)+b*S)}}};function It(t,e,o){let a=Math.ceil(t/o),c=Math.ceil(e/o),r=[],s=[];for(let l=0;l<=c;l++){let u=[];for(let i=0;i<=a;i++){let d=i*t/a,n=l*e/c;u.push(new dt(d,n))}r.push(u)}for(let l=0;l<c;l++)for(let u=0;u<a;u++){let i=new ht([r[l][u],r[l][u+1],r[l+1][u+1],r[l+1][u]]);s.push(i)}return{corners:r,cells:s,cols:a,rows:c}}function Mt(t,e,o,a,c,r,s){let l=r-a,u=s-c,i=Math.sqrt(l*l+u*u);if(i<1)return 0;let d=Math.max(3,Math.ceil(i*1.5)),n=0,m=0,x=0;for(let E=0;E<=d;E++){let v=E/d,y=a+l*v,M=c+u*v,I=Math.max(0,Math.min(e-1,y)),b=Math.max(0,Math.min(o-1,M));ut(t,e,o,I,b,!1)>0?(n++,m++,x=Math.max(x,m)):m=0}let g=n/(d+1),p=x/(d+1),f=ut(t,e,o,Math.max(0,Math.min(e-1,a)),Math.max(0,Math.min(o-1,c)),!1)>0?.2:0;return g*.4+p*.4+f}function yt(t,e,o,a,c,r=3){let s=0,l=0;for(let u=-r;u<=r;u++)for(let i=-r;i<=r;i++){let d=Math.floor(a+i),n=Math.floor(c+u);if(d>=0&&d<e&&n>=0&&n<o){l++;let m=n*e+d;t[m]>0&&s++}}return l>0?s/l:0}function bt(t,e,o,a,c={}){let{searchSteps:r=9,numIterations:s=2,stepSize:l=1,edgeSharpness:u=.8}=c;if(!e||e.length!==o*a)return console.warn("Invalid edge map for grid optimization"),t;let{corners:i,cells:d}=t,n=i.length,m=i[0].length,x=.3+u*.5,g=.2*(1-u*.5);for(let p=0;p<s;p++)for(let f=1;f<n-1;f++)for(let E=1;E<m-1;E++){let v=i[f][E],y=v.x,M=v.y,I=[];f>0&&I.push(i[f-1][E]),f<n-1&&I.push(i[f+1][E]),E>0&&I.push(i[f][E-1]),E<m-1&&I.push(i[f][E+1]);let b=yt(e,o,a,v.x,v.y,Math.ceil(l));for(let R of I)b+=Mt(e,o,a,v.x,v.y,R.x,R.y);let S=Math.floor(Math.sqrt(r)),C=Math.floor(S/2);for(let R=-C;R<=C;R++)for(let B=-C;B<=C;B++){if(B===0&&R===0)continue;let _=v.x+B*l,w=v.y+R*l;if(_<0||_>=o||w<0||w>=a)continue;let D=yt(e,o,a,_,w,Math.ceil(l));for(let F of I)D+=Mt(e,o,a,_,w,F.x,F.y);D>b&&(b=D,y=_,M=w)}let P=p/Math.max(1,s-1),A=x+g*(1-P),U=y-v.x,Y=M-v.y;v.x+=U*A,v.y+=Y*A}return t}function mt(t,e,o){let a=document.createElement("canvas");a.width=e,a.height=o;let c=a.getContext("2d"),r=c.createImageData(e,o),s=r.data;if(t.length!==e*o){console.warn(`Edge map size mismatch: expected ${e*o}, got ${t.length}`);for(let i=0;i<s.length;i+=4)s[i]=255,s[i+1]=0,s[i+2]=0,s[i+3]=255;return c.putImageData(r,0,0),a}let l=!1,u=0;for(let i=0;i<t.length;i++)t[i]>0&&(l=!0,u=Math.max(u,t[i]));if(l)for(let i=0;i<t.length;i++){let d=t[i],n=i*4;if(d>0){let m=Math.round(d*255);s[n]=m,s[n+1]=m,s[n+2]=m}else s[n]=0,s[n+1]=0,s[n+2]=0;s[n+3]=255}else for(let i=0;i<s.length;i+=4)s[i]=32,s[i+1]=32,s[i+2]=32,s[i+3]=255;return c.putImageData(r,0,0),a}function St(t){let{width:e,height:o,data:a}=t,c=document.createElement("canvas");c.width=e,c.height=o;let r=c.getContext("2d"),s=r.createImageData(e,o),l=s.data;for(let u=0;u<a.length;u+=4){let i=Math.round(.299*a[u]+.587*a[u+1]+.114*a[u+2]);l[u]=i,l[u+1]=i,l[u+2]=i,l[u+3]=a[u+3]}return r.putImageData(s,0,0),c}function ft(t,e,o="rgba(255, 0, 0, 0.7)",a=1){let c=document.createElement("canvas");c.width=t.width,c.height=t.height;let r=c.getContext("2d");r.drawImage(t,0,0),r.strokeStyle=o,r.lineWidth=a,r.lineCap="round",r.lineJoin="round";let{corners:s}=e,l=s.length,u=s[0].length,i=t.width/(u-1),d=t.height/(l-1),n=Math.min(i,d),m=n<20?Math.ceil(20/n):1;for(let x=0;x<l;x+=m){r.beginPath(),r.moveTo(s[x][0].x,s[x][0].y);for(let g=1;g<u;g++)r.lineTo(s[x][g].x,s[x][g].y);r.stroke()}if(m>1&&l>1){let x=l-1;r.beginPath(),r.moveTo(s[x][0].x,s[x][0].y);for(let g=1;g<u;g++)r.lineTo(s[x][g].x,s[x][g].y);r.stroke()}for(let x=0;x<u;x+=m){r.beginPath(),r.moveTo(s[0][x].x,s[0][x].y);for(let g=1;g<l;g++)r.lineTo(s[g][x].x,s[g][x].y);r.stroke()}if(m>1&&u>1){let x=u-1;r.beginPath(),r.moveTo(s[0][x].x,s[0][x].y);for(let g=1;g<l;g++)r.lineTo(s[g][x].x,s[g][x].y);r.stroke()}return c}function K(t){let e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e}function wt(t,e,o={}){let{returnCanvas:a=!1,colorLimit:c=null,contrast:r=1}=o,s=t instanceof ImageData?t:Tt(t),l=Kt(t,e),u=l.scaledImageData;c&&c>0&&(u=At(u,c),l.scaledCanvas.getContext("2d").putImageData(u,0,0),l.scaledImageData=u);let i=Qt(l);if(r!==1){let d=i.getContext("2d").getImageData(0,0,i.width,i.height);d=Pt(d,r),i.getContext("2d").putImageData(d,0,0)}return a?i:i.getContext("2d").getImageData(0,0,i.width,i.height)}function Vt(t,e,o,a){let{width:c,height:r,data:s}=t,l=new ImageData(c,r),u=l.data;for(let i=0;i<r;i+=o)for(let d=0;d<c;d+=o){let n=Math.min(d+o,c),m=Math.min(i+o,r),x=[],g=!1,p=0;for(let E=i;E<m;E++)for(let v=d;v<n;v++){let y=(E*c+v)*4;x.push({r:s[y],g:s[y+1],b:s[y+2],a:s[y+3]});let M=E*c+v;e[M]>0&&(g=!0,p=Math.max(p,e[M]))}let f;if(g&&a>0){let E=Wt(x);if(a>=1)f=E;else{let v=Ct(x),y=a*p;f={r:Math.round(v.r*(1-y)+E.r*y),g:Math.round(v.g*(1-y)+E.g*y),b:Math.round(v.b*(1-y)+E.b*y),a:Math.round(v.a*(1-y)+E.a*y)}}}else f=Ct(x);for(let E=i;E<m;E++)for(let v=d;v<n;v++){let y=(E*c+v)*4;u[y]=f.r,u[y+1]=f.g,u[y+2]=f.b,u[y+3]=f.a}}return l}function Ct(t){let e=0,o=0,a=0,c=0;for(let s of t)e+=s.r,o+=s.g,a+=s.b,c+=s.a;let r=t.length;return{r:Math.round(e/r),g:Math.round(o/r),b:Math.round(a/r),a:Math.round(c/r)}}function Wt(t){if(t.length===0)return{r:0,g:0,b:0,a:255};if(t.length===1)return t[0];let e=[...t].sort((o,a)=>{let c=.299*o.r+.587*o.g+.114*o.b,r=.299*a.r+.587*a.g+.114*a.b;return c-r});return e[Math.floor(e.length/2)]}function Ht(t,e){let o=new Uint8ClampedArray(t.data),a=t.width,c=t.height,r=Math.max(1,Math.floor(Math.sqrt(a*c)/100)),s=[];for(let d=0;d<o.length;d+=4*r){let n=o[d],m=o[d+1],x=o[d+2];s.push({r:n,g:m,b:x})}let l=[];if(s.length<=e){let d=new Map;for(let n of s){let m=`${n.r},${n.g},${n.b}`;if(!d.has(m)&&(d.set(m,n),d.size>=e))break}l.push(...Array.from(d.values()))}else{let d=new Map;for(let m of s){let x=`${m.r},${m.g},${m.b}`;d.set(x,(d.get(x)||0)+1)}let n=Array.from(d.entries()).sort((m,x)=>x[1]-m[1]).map(([m])=>{let[x,g,p]=m.split(",").map(Number);return{r:x,g,b:p}});for(l.push(n[0]);l.length<e&&l.length<n.length;){let m=-1,x=null;for(let g of n){if(l.some(f=>f.r===g.r&&f.g===g.g&&f.b===g.b))continue;let p=1/0;for(let f of l){let E=Math.sqrt(Math.pow(g.r-f.r,2)+Math.pow(g.g-f.g,2)+Math.pow(g.b-f.b,2));E<p&&(p=E)}p>m&&(m=p,x=g)}if(x)l.push(x);else{for(let g of n){if(l.length>=e)break;l.some(p=>p.r===g.r&&p.g===g.g&&p.b===g.b)||l.push(g)}break}}}l.length===0&&l.push({r:128,g:128,b:128});let u=new ImageData(a,c),i=u.data;for(let d=0;d<o.length;d+=4){let n=o[d],m=o[d+1],x=o[d+2],g=o[d+3],p=1/0,f=l[0];for(let E of l){let v=Math.sqrt(Math.pow(n-E.r,2)+Math.pow(m-E.g,2)+Math.pow(x-E.b,2));v<p&&(p=v,f=E)}i[d]=f.r,i[d+1]=f.g,i[d+2]=f.b,i[d+3]=g}return u}function Ot(t,e){let o=t.data,a=new ImageData(t.width,t.height),c=a.data;for(let r=0;r<o.length;r+=4)c[r]=Math.max(0,Math.min(255,Math.round((o[r]-128)*e+128))),c[r+1]=Math.max(0,Math.min(255,Math.round((o[r+1]-128)*e+128))),c[r+2]=Math.max(0,Math.min(255,Math.round((o[r+2]-128)*e+128))),c[r+3]=o[r+3];return a}function Tt(t){if(t instanceof ImageData)return t;let e=document.createElement("canvas");if(t instanceof HTMLCanvasElement)e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement){let o=t.naturalWidth||t.width,a=t.naturalHeight||t.height;e.width=o,e.height=a,e.getContext("2d").drawImage(t,0,0)}else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");return e.getContext("2d").getImageData(0,0,e.width,e.height)}async function qt(t,e={}){let{edgeSharpness:o=.8,onProgress:a=null}=e,{width:c,height:r}=t,s=null,l=!1;try{if(s=vt(t,{edgeSharpness:o}),l=s!==null,s)if(s.length!==c*r)console.warn("WebGL edge map size mismatch, falling back to CPU"),s=null,l=!1;else{let u=0,i=Math.min(1e4,s.length),d=Math.max(1,Math.floor(s.length/i));for(let n=0;n<s.length;n+=d)s[n]>0&&u++;if(u===0&&i>100){console.warn("WebGL edge map has no edges in sample, trying CPU");let n=nt(t,{edgeSharpness:o}),m=0,x=Math.max(1,Math.floor(n.length/i));for(let g=0;g<n.length;g+=x)n[g]>0&&m++;m>0&&(s=n,l=!1)}}}catch(u){console.error("WebGL edge detection error:",u),s=null,l=!1}return s||(s=nt(t,{edgeSharpness:o})),a&&a({usingGPU:l}),{edgeMap:s,usingGPU:l}}function jt(t,e){return It(t.width,t.height,e)}function $t(t,e={}){let{grid:o,edgeMap:a,imageData:c}=t,{searchSteps:r=9,numIterations:s=2,stepSize:l=1,edgeSharpness:u=.8}=e;if(!o||!a||!c)throw new Error("optimizeGridStep requires grid, edgeMap, and imageData in context");let{width:i,height:d}=c,n=Math.max(r,Math.floor(9+u*16)),m=Math.max(s,Math.floor(2+u*3));return bt(o,a,i,d,{searchSteps:n,numIterations:m,stepSize:l||1,edgeSharpness:u})}function Zt(t,e,o,a){return Vt(t,e,o,a)}function Pt(t,e){return e===1?t:Ot(t,e)}function At(t,e){return!e||e<=0?t:Ht(t,e)}function Jt(t,e=!1){if(!e)return t;let o=document.createElement("canvas");return o.width=t.width,o.height=t.height,o.getContext("2d").putImageData(t,0,0),o}function Kt(t,e){let o,a;if(t instanceof ImageData)o=t.width,a=t.height;else if(t instanceof HTMLCanvasElement)o=t.width,a=t.height;else if(t instanceof HTMLImageElement)o=t.naturalWidth||t.width,a=t.naturalHeight||t.height;else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");let c=Math.max(1,Math.floor(o/e)),r=Math.max(1,Math.floor(a/e)),s=document.createElement("canvas");s.width=c,s.height=r;let l=s.getContext("2d");if(l.imageSmoothingEnabled=!1,t instanceof ImageData){let i=document.createElement("canvas");i.width=o,i.height=a,i.getContext("2d").putImageData(t,0,0),l.drawImage(i,0,0,c,r)}else l.drawImage(t,0,0,c,r);return{scaledImageData:l.getImageData(0,0,c,r),originalSize:{width:o,height:a},scaledCanvas:s}}function Qt(t){let{scaledImageData:e,originalSize:o,scaledCanvas:a}=t;if(!e||!o||!a)throw new Error("upscaleImageStep requires scaledImageData, originalSize, and scaledCanvas from downscaleImageStep");let c=document.createElement("canvas");c.width=o.width,c.height=o.height;let r=c.getContext("2d");return r.imageSmoothingEnabled=!1,r.drawImage(a,0,0,o.width,o.height),c}async function Bt(t,e,o={}){let{returnCanvas:a=!1,searchSteps:c=9,numIterations:r=2,onProgress:s=null,colorLimit:l=null,contrast:u=1,edgeSharpness:i=.8,captureIntermediates:d=!1}=o,n=d?[]:null,m=Tt(t),{width:x,height:g}=m;d&&n.push({name:"Original",canvas:K(m)});let p=await qt(m,{edgeSharpness:i,onProgress:s}),{edgeMap:f,usingGPU:E}=p,v=null;if(d){let N=function(z,k,O,q,W){let H=mt(z,k,O),V=document.createElement("canvas");V.width=q,V.height=W;let j=V.getContext("2d");return j.imageSmoothingEnabled=!1,j.drawImage(H,0,0,k,O,0,0,q,W),V};n.push({name:"Grayscale",canvas:St(m)});let D=Math.min(1,800/Math.max(x,g)),F=Math.round(x*D),G=Math.round(g*D),L=m;if(D<1){let z=document.createElement("canvas");z.width=F,z.height=G;let k=z.getContext("2d"),O=K(m);k.drawImage(O,0,0,F,G),L=k.getImageData(0,0,F,G)}let X=nt(L,{edgeSharpness:i,captureIntermediates:!0});if(n.push({name:"Gradient Magnitude",canvas:N(X.intermediates.magnitude,F,G,x,g)}),n.push({name:"After NMS",canvas:N(X.intermediates.afterNMS,F,G,x,g)}),f&&f.length===x*g){let z=0;for(let k=0;k<f.length;k++)f[k]>0&&z++;z>0?(v=mt(f,x,g),n.push({name:"Edge Map",canvas:v})):(console.warn("Full-res edge map has no edges, using downscaled version for visualization"),v=N(X.intermediates.afterThreshold,F,G,x,g),n.push({name:"Edge Map",canvas:v}))}else console.warn("Full-res edge map invalid, using downscaled version for visualization"),v=N(X.intermediates.afterThreshold,F,G,x,g),n.push({name:"Edge Map",canvas:v})}let y=jt(m,e),M=0;for(let w=0;w<f.length;w++)f[w]>0&&M++;let I=(M/f.length*100).toFixed(2);if(d){let w=K(m);n.push({name:"Initial Grid",canvas:ft(w,y,"rgba(255, 0, 0, 1.0)",2)})}let b=.5+i*1.5,S=Math.max(1,e*.3*b),C=Math.max(c,Math.floor(9+i*16)),P=Math.max(r,Math.floor(2+i*3)),A=null;d&&(A={corners:y.corners.map(w=>w.map(D=>({x:D.x,y:D.y})))}),M===0&&console.warn("Edge map has no edges - grid optimization will have no effect");let U=d?Math.max(S,e*.5):S,Y=d?Math.max(C,25):C,R=d?Math.max(P,4):P;if($t({grid:y,edgeMap:f,imageData:m},{searchSteps:Y,numIterations:R,stepSize:U,edgeSharpness:i}),d){let w=y.corners.length,D=y.corners[0].length,F=Math.ceil(e);if(M>0)for(let G=1;G<w-1;G++)for(let L=1;L<D-1;L++){let X=y.corners[G][L],N=Math.floor(X.x),z=Math.floor(X.y),k=0,O=0,q=1/0;for(let W=1;W<=F;W++)for(let H=-W;H<=W;H++)for(let V=-W;V<=W;V++){let j=N+V,J=z+H;if(j>=0&&j<x&&J>=0&&J<g){let Z=J*x+j;if(f[Z]>0){let xt=Math.sqrt(V*V+H*H);xt<q&&(q=xt,k=V,O=H)}}}q<1/0&&q>0&&(X.x=N+k,X.y=z+O)}}if(d){let w=K(m);n.push({name:"Optimized Grid",canvas:ft(w,y,"rgba(0, 255, 0, 1.0)",2)})}s&&s({usingGPU:E});let B=Zt(m,f,e,i);B=Pt(B,u),B=At(B,l);let _=Jt(B,!0);return _._usingGPU=E,d?(n.push({name:"Final Result",canvas:_}),{canvas:_,intermediates:n,usingGPU:E}):a?_:B}function Rt(t){return new Promise((e,o)=>{let a=new Image;if(a.onload=()=>e(a),a.onerror=()=>o(new Error("Failed to load image")),t instanceof File){let c=new FileReader;c.onload=r=>{a.src=r.target.result},c.onerror=()=>o(new Error("Failed to read file")),c.readAsDataURL(t)}else a.src=t})}function pt(t,e,o={}){let{interpolation:a="nearest",fillMode:c="constant",fillValue:r=0,returnCanvas:s=!1}=o;if(e.length!==8)throw new Error("Transform matrix must have 8 elements [a1, a2, a3, b1, b2, b3, c1, c2]");let[l,u,i,d,n,m,x,g]=e,p,f,E;if(t instanceof ImageData)p=t.width,f=t.height,E=t.data;else{let b=document.createElement("canvas");if(t instanceof HTMLCanvasElement)b.width=t.width,b.height=t.height,b.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement)b.width=t.naturalWidth||t.width,b.height=t.naturalHeight||t.height,b.getContext("2d").drawImage(t,0,0);else throw new Error("Unsupported image type");p=b.width,f=b.height,E=b.getContext("2d").getImageData(0,0,p,f).data}let v=document.createElement("canvas");v.width=p,v.height=f;let y=v.getContext("2d"),M=y.createImageData(p,f),I=M.data;for(let b=0;b<f;b++)for(let S=0;S<p;S++){let C=S,P=b,A=x*C+g*P+1;if(Math.abs(A)<1e-4){let L=(b*p+S)*4;I[L]=r,I[L+1]=r,I[L+2]=r,I[L+3]=255;continue}let U=(l*C+u*P+i)/A,Y=(d*C+n*P+m)/A,R=Lt(U,p,c),B=Lt(Y,f,c),_,w,D,F;if(a==="nearest"){let L=Math.round(R),X=Math.round(B),N=Q(E,L,X,p,f,r);_=N.r,w=N.g,D=N.b,F=N.a}else{let L=Math.floor(R),X=Math.floor(B),N=L+1,z=X+1,k=Q(E,L,X,p,f,r),O=Q(E,N,X,p,f,r),q=Q(E,L,z,p,f,r),W=Q(E,N,z,p,f,r),H=R-L,V=B-X,j=gt(k,O,H),J=gt(q,W,H),Z=gt(j,J,V);_=Z.r,w=Z.g,D=Z.b,F=Z.a}let G=(b*p+S)*4;I[G]=_,I[G+1]=w,I[G+2]=D,I[G+3]=F}return y.putImageData(M,0,0),s?v:M}function Lt(t,e,o){if(o==="constant")return t;if(o==="reflect"){if(t<0){if(e<=1)return 0;let a=2*e;t<-a&&(t=t+a*Math.floor(-t/a)),t=t<-e?t+a:-t-1}else if(t>e-1){if(e<=1)return 0;let a=2*e;t=t-a*Math.floor(t/a),t>=e&&(t=a-t-1)}return Math.max(0,Math.min(e-1,t))}else if(o==="wrap"){if(t<0){if(e<=1)return 0;let a=e-1;t=t+e*(Math.floor(-t/a)+1)}else if(t>e-1){if(e<=1)return 0;let a=e-1;t=t-e*Math.floor(t/a)}return Math.max(0,Math.min(e-1,t))}else if(o==="nearest")return Math.max(0,Math.min(e-1,t));return t}function Q(t,e,o,a,c,r){if(e>=0&&e<a&&o>=0&&o<c){let s=(o*a+e)*4;return{r:t[s],g:t[s+1],b:t[s+2],a:t[s+3]}}else return{r,g:r,b:r,a:255}}function gt(t,e,o){return{r:Math.round(t.r+(e.r-t.r)*o),g:Math.round(t.g+(e.g-t.g)*o),b:Math.round(t.b+(e.b-t.b)*o),a:Math.round(t.a+(e.a-t.a)*o)}}function _t(t,e,o){let a=Math.cos(t),c=Math.sin(t),r=e-e*a+o*c,s=o-e*c-o*a;return[a,-c,r,c,a,s,0,0]}function Dt(t,e,o,a){return[t,0,o*(1-t),0,e,a*(1-e),0,0]}var h={imageInput:document.getElementById("imageInput"),pixelSizeSlider:document.getElementById("pixelSize"),pixelSizeNumber:document.getElementById("pixelSizeNumber"),pixelSizeValue:document.getElementById("pixelSizeValue"),colorLimitSlider:document.getElementById("colorLimit"),colorLimitNumber:document.getElementById("colorLimitNumber"),colorLimitValue:document.getElementById("colorLimitValue"),colorLimitGroup:document.getElementById("colorLimitGroup"),useColorLimit:document.getElementById("useColorLimit"),useEdgeAware:document.getElementById("useEdgeAware"),gpuIndicator:document.getElementById("gpuIndicator"),gpuStatus:document.getElementById("gpuStatus"),edgeSharpnessGroup:document.getElementById("edgeSharpnessGroup"),edgeSharpnessSlider:document.getElementById("edgeSharpness"),edgeSharpnessNumber:document.getElementById("edgeSharpnessNumber"),edgeSharpnessValue:document.getElementById("edgeSharpnessValue"),numPassesGroup:document.getElementById("numPassesGroup"),numPassesSlider:document.getElementById("numPasses"),numPassesNumber:document.getElementById("numPassesNumber"),numPassesValue:document.getElementById("numPassesValue"),showStepsGroup:document.getElementById("showStepsGroup"),showAlgorithmSteps:document.getElementById("showAlgorithmSteps"),stepNavigation:document.getElementById("stepNavigation"),stepLabel:document.getElementById("stepLabel"),stepCounter:document.getElementById("stepCounter"),stepPrev:document.getElementById("stepPrev"),stepNext:document.getElementById("stepNext"),contrastGroup:document.getElementById("contrastGroup"),contrastSlider:document.getElementById("contrast"),contrastNumber:document.getElementById("contrastNumber"),contrastValue:document.getElementById("contrastValue"),useProjection:document.getElementById("useProjection"),rotationGroup:document.getElementById("rotationGroup"),rotationAngleSlider:document.getElementById("rotationAngle"),rotationAngleNumber:document.getElementById("rotationAngleNumber"),rotationAngleValue:document.getElementById("rotationAngleValue"),useScaling:document.getElementById("useScaling"),scalingGroup:document.getElementById("scalingGroup"),scalingGroupY:document.getElementById("scalingGroupY"),scaleXSlider:document.getElementById("scaleX"),scaleXNumber:document.getElementById("scaleXNumber"),scaleXValue:document.getElementById("scaleXValue"),scaleYSlider:document.getElementById("scaleY"),scaleYNumber:document.getElementById("scaleYNumber"),scaleYValue:document.getElementById("scaleYValue"),pixelateBtn:document.getElementById("pixelateBtn"),mainCanvas:document.getElementById("mainCanvas"),canvasTitle:document.getElementById("canvasTitle")},T={intermediates:[],currentStep:0},et=h.mainCanvas.getContext("2d"),ot=null,tt=null;function rt(t,e,o,a,c,r){let s=()=>{let u=t.value;e.value=u,o.textContent=u},l=u=>{let i=Math.max(a,Math.min(c,parseInt(u.target.value)||r));t.value=i,e.value=i,o.textContent=i};t.addEventListener("input",s),e.addEventListener("input",l),s()}rt(h.pixelSizeSlider,h.pixelSizeNumber,h.pixelSizeValue,2,128,3);rt(h.colorLimitSlider,h.colorLimitNumber,h.colorLimitValue,2,256,32);rt(h.numPassesSlider,h.numPassesNumber,h.numPassesValue,1,10,3);function st(t,e,o,a,c,r){let s=()=>{let u=parseFloat(t.value);e.value=u.toFixed(1),o.textContent=u.toFixed(1)},l=u=>{let i=Math.max(a,Math.min(c,parseFloat(u.target.value)||r));t.value=i,e.value=i.toFixed(1),o.textContent=i.toFixed(1)};t.addEventListener("input",s),e.addEventListener("input",l),s()}st(h.edgeSharpnessSlider,h.edgeSharpnessNumber,h.edgeSharpnessValue,0,1,.8);st(h.contrastSlider,h.contrastNumber,h.contrastValue,.5,2,1);rt(h.rotationAngleSlider,h.rotationAngleNumber,h.rotationAngleValue,0,360,0);st(h.scaleXSlider,h.scaleXNumber,h.scaleXValue,.1,3,1);st(h.scaleYSlider,h.scaleYNumber,h.scaleYValue,.1,3,1);function Ft(){let t=h.useEdgeAware.checked;h.edgeSharpnessGroup.style.display=t?"flex":"none",h.numPassesGroup.style.display=t?"flex":"none",h.showStepsGroup.style.display=t?"flex":"none",h.gpuIndicator.style.display=t?"block":"none",t||(h.gpuStatus.textContent="",h.stepNavigation.classList.remove("active"),T.intermediates=[])}function Gt(){let t=h.useColorLimit.checked;h.colorLimitGroup.style.display=t?"flex":"none"}function Xt(){let t=h.useProjection.checked;h.rotationGroup.style.display=t?"flex":"none"}function Ut(){let t=h.useScaling.checked;h.scalingGroup.style.display=t?"flex":"none",h.scalingGroupY.style.display=t?"flex":"none"}function at(t){let e=t,o=t.width/2,a=t.height/2;if(h.useScaling.checked){let c=parseFloat(h.scaleXSlider.value),r=parseFloat(h.scaleYSlider.value),s=Dt(c,r,o,a);e=pt(e,s,{returnCanvas:!0,interpolation:"nearest"})}if(h.useProjection.checked){let c=parseFloat(h.rotationAngleSlider.value)*Math.PI/180,r=_t(c,o,a);e=pt(e,r,{returnCanvas:!0,interpolation:"nearest"})}return e}function it(t){if(!T.intermediates.length)return;T.currentStep=Math.max(0,Math.min(t,T.intermediates.length-1));let e=T.intermediates[T.currentStep],o=e.canvas;if(e.name==="Final Result"){let a=e.originalCanvas||e.canvas;o=at(a)}h.mainCanvas.width=o.width,h.mainCanvas.height=o.height,et.drawImage(o,0,0),h.canvasTitle.textContent=e.name,h.stepLabel.textContent=e.name,h.stepCounter.textContent=`Step ${T.currentStep+1} of ${T.intermediates.length}`}function Nt(){if(!T.intermediates.length)return;let t=(T.currentStep+1)%T.intermediates.length;it(t)}function Yt(){if(!T.intermediates.length)return;let t=(T.currentStep-1+T.intermediates.length)%T.intermediates.length;it(t)}function te(t){T.intermediates=t,T.currentStep=t.length-1,h.stepNavigation.classList.add("active"),it(T.currentStep)}h.stepPrev.addEventListener("click",Yt);h.stepNext.addEventListener("click",Nt);document.addEventListener("keydown",t=>{T.intermediates.length!==0&&(t.key==="ArrowLeft"?Yt():t.key==="ArrowRight"&&Nt())});Gt();Ft();Xt();Ut();h.useColorLimit.addEventListener("change",Gt);h.useEdgeAware.addEventListener("change",Ft);h.useProjection.addEventListener("change",Xt);h.useScaling.addEventListener("change",Ut);h.imageInput.addEventListener("change",async t=>{let e=t.target.files[0];if(!e){h.pixelateBtn.disabled=!0;return}try{h.pixelateBtn.disabled=!0,h.pixelateBtn.textContent="Loading...";let o=await Rt(e);ot=o,h.mainCanvas.width=o.width,h.mainCanvas.height=o.height,et.drawImage(o,0,0),h.canvasTitle.textContent="Original Image",h.stepNavigation.classList.remove("active"),T.intermediates=[],h.pixelateBtn.disabled=!1,h.pixelateBtn.textContent="Pixelate Image"}catch(o){alert("Failed to load image: "+o.message),h.pixelateBtn.disabled=!0,h.pixelateBtn.textContent="Pixelate Image"}});h.pixelateBtn.addEventListener("click",async()=>{if(h.pixelateBtn.disabled)return;if(h.pixelateBtn.disabled=!0,!ot){alert("Please upload an image first."),h.pixelateBtn.disabled=!1;return}let t=parseInt(h.pixelSizeSlider.value),e=h.useColorLimit.checked?parseInt(h.colorLimitSlider.value):null,o=h.useEdgeAware.checked;try{h.pixelateBtn.textContent=o?"Processing (Edge-Aware)...":"Processing...",await new Promise(c=>setTimeout(c,0));let a;if(o){let c=parseFloat(h.contrastSlider.value),r=parseFloat(h.edgeSharpnessSlider.value),s=parseInt(h.numPassesSlider.value),l=h.showAlgorithmSteps.checked;h.gpuStatus.textContent="Processing...";let u=await Bt(ot,t,{returnCanvas:!0,searchSteps:9,numIterations:s,colorLimit:e,contrast:c,edgeSharpness:r,captureIntermediates:l,onProgress:i=>{i.usingGPU?(h.gpuStatus.textContent="\u2713 Using GPU acceleration",h.gpuStatus.style.color="#4caf50"):(h.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",h.gpuStatus.style.color="#ff9800")}});if(l&&u.intermediates){if(a=u.canvas,u.intermediates.length>0){let i=u.intermediates[u.intermediates.length-1];i.name==="Final Result"&&(i.originalCanvas=i.canvas)}te(u.intermediates),u.usingGPU?(h.gpuStatus.textContent="\u2713 Using GPU acceleration",h.gpuStatus.style.color="#4caf50"):(h.gpuStatus.textContent="\u26A0 Using CPU (for visualization)",h.gpuStatus.style.color="#ff9800")}else{a=u,tt=a,h.stepNavigation.classList.remove("active"),T.intermediates=[];let i=at(a);h.mainCanvas.width=i.width,h.mainCanvas.height=i.height,et.drawImage(i,0,0),h.canvasTitle.textContent="Pixelated Image",u._usingGPU!==void 0&&(u._usingGPU?(h.gpuStatus.textContent="\u2713 Using GPU acceleration",h.gpuStatus.style.color="#4caf50"):(h.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",h.gpuStatus.style.color="#ff9800"))}}else{let c=parseFloat(h.contrastSlider.value);await new Promise(s=>requestAnimationFrame(s)),a=wt(ot,t,{returnCanvas:!0,colorLimit:e,contrast:c}),h.stepNavigation.classList.remove("active"),T.intermediates=[],tt=a;let r=at(a);h.mainCanvas.width=r.width,h.mainCanvas.height=r.height,et.drawImage(r,0,0),h.canvasTitle.textContent="Pixelated Image"}h.pixelateBtn.disabled=!1,h.pixelateBtn.textContent="Pixelate Image"}catch(a){alert("Failed to pixelate image: "+a.message),h.pixelateBtn.disabled=!1,h.pixelateBtn.textContent="Pixelate Image"}});function $(){if(!(!tt&&!T.intermediates.length)){if(T.intermediates.length>0)it(T.currentStep);else if(tt){let t=at(tt);h.mainCanvas.width=t.width,h.mainCanvas.height=t.height,et.drawImage(t,0,0)}}}h.rotationAngleSlider.addEventListener("input",$);h.rotationAngleNumber.addEventListener("input",$);h.useProjection.addEventListener("change",$);h.scaleXSlider.addEventListener("input",$);h.scaleXNumber.addEventListener("input",$);h.scaleYSlider.addEventListener("input",$);h.scaleYNumber.addEventListener("input",$);h.useScaling.addEventListener("change",$);</script></body></html>