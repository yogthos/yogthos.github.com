<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pixel Mosaic - Demo</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:30px}.control-section{background:#f8f9fa;border-radius:6px;padding:12px;border:1px solid #e9ecef}.control-section-title{font-size:.8em;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #dee2e6}.control-section-grid{display:grid;grid-template-columns:1fr;gap:12px}.control-group{display:flex;flex-direction:column;gap:6px;min-height:50px;transition:opacity .2s ease}.control-group[style*="display: none"]{min-height:0;opacity:0}label{font-weight:600;color:#555;font-size:.85em}input[type=checkbox]{margin-right:8px;cursor:pointer;width:18px;height:18px;accent-color:#667eea}label:has(input[type=checkbox]){display:flex;align-items:center;cursor:pointer;user-select:none}input[type=range]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:0;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;transition:background .2s}input[type=range]::-webkit-slider-thumb:hover{background:#5568d3}input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;border:none;transition:background .2s}input[type=range]::-moz-range-thumb:hover{background:#5568d3}input[type=number]{width:70px;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:.85em}input[type=number]:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.1)}input[type=file]{padding:10px;border:2px dashed #667eea;border-radius:4px;cursor:pointer;background:#fff;transition:all .2s}input[type=file]:hover{border-color:#5568d3;background:#f8f9ff}button{padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:6px;font-size:.9em;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 4px rgba(102,126,234,.2)}button:hover:not(:disabled){background:#5568d3;box-shadow:0 4px 8px rgba(102,126,234,.3);transform:translateY(-1px)}button:active:not(:disabled){transform:translateY(0);box-shadow:0 2px 4px rgba(102,126,234,.2)}button:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;transform:none}.canvas-container{display:flex;flex-direction:column;align-items:center;margin-top:20px;margin-bottom:20px}.canvas-wrapper{text-align:center;width:100%}.canvas-wrapper h2{margin-bottom:12px;color:#333;font-size:1.1em}canvas{max-width:100%;height:auto;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}.info{margin-top:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;color:#1565c0}.step-navigation{display:none;justify-content:center;align-items:center;gap:15px;margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px}.step-navigation.active{display:flex}.step-navigation button{padding:8px 16px;font-size:.9em;min-width:90px}.step-label{font-weight:600;color:#333;font-size:1em;min-width:180px;text-align:center}.step-counter{color:#666;font-size:.85em}.github-link{margin-top:30px;text-align:center;padding:20px}.github-link a{display:inline-flex;align-items:center;gap:8px;color:#667eea;text-decoration:none;font-weight:600;font-size:1.1em;transition:color .3s}.github-link a:hover{color:#5568d3}.github-link a::before{content:'üîó';font-size:1.2em}</style></head><body><div class=container><h1>üé® Pixel Mosaic</h1><div class=control-section style="max-width:400px;margin:0 auto 20px"><div class=control-section-title>üì§ Image Upload</div><div class=control-section-grid><div class=control-group><label for=imageInput>Upload Image</label> <input type=file id=imageInput accept=image/*></div></div></div><div class=canvas-container><div class=canvas-wrapper><h2 id=canvasTitle>Upload an image to begin</h2><canvas id=mainCanvas></canvas><div style=margin-top:15px><button id=pixelateBtn disabled=disabled>Pixelate Image</button></div><div class=step-navigation id=stepNavigation><button id=stepPrev>‚Üê Previous</button><div><div class=step-label id=stepLabel>Original</div><div class=step-counter id=stepCounter></div></div><button id=stepNext>Next ‚Üí</button></div></div></div><div class=controls><div class=control-section><div class=control-section-title>üé® Pixelation</div><div class=control-section-grid><div class=control-group><label for=pixelSize>Pixel Size: <span id=pixelSizeValue>3</span></label> <input type=range id=pixelSize min=2 max=128 value=3> <input type=number id=pixelSizeNumber min=2 max=128 value=3></div><div class=control-group><label for=contrast>Contrast: <span id=contrastValue>1.0</span></label> <input type=range id=contrast min=0.5 max=2 step=0.1 value=1.0> <input type=number id=contrastNumber min=0.5 max=2 step=0.1 value=1.0></div><div class=control-group><label><input type=checkbox id=useColorLimit checked=checked> Enable Color Limiting</label></div><div class=control-group id=colorLimitGroup><label for=colorLimit>Color Limit: <span id=colorLimitValue>32</span></label> <input type=range id=colorLimit min=2 max=256 value=32> <input type=number id=colorLimitNumber min=2 max=256 value=32></div></div></div><div class=control-section><div class=control-section-title>üîç Edge-Aware</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useEdgeAware> Enable Edge-Aware</label><div id=gpuIndicator style=display:none;margin-top:4px;font-size:.75em;color:#666><span id=gpuStatus>Checking GPU...</span></div></div><div class=control-group id=edgeSharpnessGroup style=display:none><label for=edgeSharpness>Edge Sharpness: <span id=edgeSharpnessValue>0.8</span></label> <input type=range id=edgeSharpness min=0 max=1 step=0.1 value=0.8> <input type=number id=edgeSharpnessNumber min=0 max=1 step=0.1 value=0.8></div><div class=control-group id=numPassesGroup style=display:none><label for=numPasses>Optimization Passes: <span id=numPassesValue>3</span></label> <input type=range id=numPasses min=1 max=10 value=3> <input type=number id=numPassesNumber min=1 max=10 value=3></div><div class=control-group id=showStepsGroup style=display:none><label><input type=checkbox id=showAlgorithmSteps> Show Algorithm Steps</label></div><div class=control-group id=useSplinesGroup style=display:none><label><input type=checkbox id=useSplines> Use B-Splines</label></div><div class=control-group id=splineSmoothnessGroup style=display:none><label for=splineSmoothness>Spline Smoothness: <span id=splineSmoothnessValue>0.3</span></label> <input type=range id=splineSmoothness min=0 max=1 step=0.01 value=0.3> <input type=number id=splineSmoothnessNumber min=0 max=1 step=0.01 value=0.3></div></div></div><div class=control-section><div class=control-section-title>üîÑ Transform</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useProjection> Apply Rotation</label></div><div class=control-group id=rotationGroup style=display:none><label for=rotationAngle>Rotation: <span id=rotationAngleValue>0</span>¬∞</label> <input type=range id=rotationAngle min=0 max=360 value=0> <input type=number id=rotationAngleNumber min=0 max=360 value=0></div><div class=control-group><label><input type=checkbox id=useScaling> Apply Scaling</label></div><div class=control-group id=scalingGroup style=display:none><label for=scaleX>Scale X: <span id=scaleXValue>1.0</span></label> <input type=range id=scaleX min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleXNumber min=0.1 max=3 step=0.1 value=1.0></div><div class=control-group id=scalingGroupY style=display:none><label for=scaleY>Scale Y: <span id=scaleYValue>1.0</span></label> <input type=range id=scaleY min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleYNumber min=0.1 max=3 step=0.1 value=1.0></div></div></div></div><div class=info><strong>How to use:</strong> Upload an image, adjust the pixel size and color limit, then click "Pixelate Image". Enable "Edge-Aware Pixelation" for adaptive grid optimization with adjustable edge sharpness. Check "Show Algorithm Steps" to visualize the edge detection process.</div><div class=github-link><a href=https://github.com/yogthos/pixel-mosaic target=_blank rel="noopener noreferrer">View on GitHub</a></div></div><script type=module>function ue(e,t,a,s){let c=new Float32Array(a*s);for(let o=1;o<s-1;o++)for(let r=1;r<a-1;r++){let i=o*a+r,d=e[i],l=t[i];if(d===0){c[i]=0;continue}let u=l;for(;u<0;)u+=2*Math.PI;for(;u>=2*Math.PI;)u-=2*Math.PI;let n,f;u>=0&&u<Math.PI/8||u>=15*Math.PI/8&&u<2*Math.PI||u>=7*Math.PI/8&&u<9*Math.PI/8?(n=e[i-1],f=e[i+1]):u>=Math.PI/8&&u<3*Math.PI/8||u>=9*Math.PI/8&&u<11*Math.PI/8?(n=e[(o-1)*a+(r+1)],f=e[(o+1)*a+(r-1)]):u>=3*Math.PI/8&&u<5*Math.PI/8||u>=11*Math.PI/8&&u<13*Math.PI/8?(n=e[(o-1)*a+r],f=e[(o+1)*a+r]):(n=e[(o-1)*a+(r-1)],f=e[(o+1)*a+(r+1)]),d>=n&&d>=f?c[i]=d:c[i]=0}return c}function de(e,t,a,s={}){let{threshold:c=.1,highThreshold:o=null,lowThreshold:r=null,usePercentile:i=!0,binarize:d=!0}=s,l=new Float32Array(e.length),u=c;if(i&&c>0){let n=[];for(let f=0;f<e.length;f++)e[f]>0&&n.push(e[f]);if(n.length>0){n.sort((h,p)=>h-p);let f=c,E=Math.ceil(n.length*f),g=Math.min(n.length-1,Math.max(0,E));u=n[g]}}if(o!==null&&r!==null&&o>r){let n=o,f=r;if(i){let h=[];for(let p=0;p<e.length;p++)e[p]>0&&h.push(e[p]);if(h.length>0){h.sort((y,v)=>y-v);let p=1-o,M=1-r,S=Math.floor(h.length*p),x=Math.floor(h.length*M);n=h[Math.max(0,S-1)]||0,f=h[Math.max(0,x-1)]||0}}let E=new Set,g=new Set;for(let h=0;h<e.length;h++)e[h]>=n?(E.add(h),l[h]=d?1:e[h]):(e[h]>=f&&g.add(h),l[h]=0);for(let h=0;h<e.length;h++)if(g.has(h)){let p=!1,M=h%t,S=Math.floor(h/t);for(let x=-1;x<=1&&!p;x++)for(let y=-1;y<=1&&!p;y++){if(y===0&&x===0)continue;let v=M+y,I=S+x;if(v>=0&&v<t&&I>=0&&I<a){let b=I*t+v;E.has(b)&&(p=!0)}}p&&(l[h]=d?1:e[h])}}else for(let n=0;n<e.length;n++)e[n]>=u?l[n]=d?1:e[n]:l[n]=0;return l}function ae(e,t={}){let{applyNMS:a=!0,threshold:s=null,edgeSharpness:c=.8,highThreshold:o=null,lowThreshold:r=null,captureIntermediates:i=!1}=t;s===null&&(s=.1+c*.5);let{data:d,width:l,height:u}=e,n=new Float32Array(l*u),f=new Float32Array(l*u),E=null;i&&(E=new Float32Array(l*u));let g=[-1,0,1,-2,0,2,-1,0,1],h=[-1,-2,-1,0,0,0,1,2,1];for(let y=1;y<u-1;y++)for(let v=1;v<l-1;v++){let I=0,b=0;for(let C=-1;C<=1;C++)for(let T=-1;T<=1;T++){let G=((y+C)*l+(v+T))*4,U=(d[G]+d[G+1]+d[G+2])/3,X=(C+1)*3+(T+1);I+=U*g[X],b+=U*h[X],i&&C===0&&T===0&&(E[y*l+v]=U/255)}let w=Math.sqrt(I*I+b*b);n[y*l+v]=w;let B=Math.atan2(b,I)+Math.PI/2;f[y*l+v]=B}if(i){for(let y=0;y<u;y++)for(let v=0;v<l;v++)if(y===0||y===u-1||v===0||v===l-1){let I=(y*l+v)*4,b=(d[I]+d[I+1]+d[I+2])/3;E[y*l+v]=b/255}}let p=0;for(let y=0;y<n.length;y++)n[y]>p&&(p=n[y]);if(p>0)for(let y=0;y<n.length;y++)n[y]/=p;let M=null;i&&(M=new Float32Array(n));let S=n,x=null;return a&&(S=ue(n,f,l,u),i&&(x=new Float32Array(S))),S=de(S,l,u,{threshold:s,highThreshold:o,lowThreshold:r}),i?{edgeMap:S,intermediates:{grayscale:E,magnitude:M,afterNMS:x||M,afterThreshold:S},width:l,height:u}:S}function he(e,t,a,s,c,o=!1){if(s=Math.max(0,Math.min(t-1,s)),c=Math.max(0,Math.min(a-1,c)),!o){let I=Math.round(s),w=Math.round(c)*t+I;return e[w]||0}let r=Math.floor(s),i=Math.floor(c),d=Math.min(t-1,r+1),l=Math.min(a-1,i+1),u=s-r,n=c-i,f=i*t+r,E=l*t+r,g=i*t+d,h=l*t+d,p=e[f]||0,M=e[E]||0,S=e[g]||0,x=e[h]||0,y=p*(1-u)+S*u,v=M*(1-u)+x*u;return y*(1-n)+v*n}function $e(e){let t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return null;let a=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;

    void main() {
      gl_Position = vec4(a_position, 0.0, 1.0);
      v_texCoord = a_texCoord;
    }
  `,s=`
    precision mediump float;
    uniform sampler2D u_image;
    uniform vec2 u_textureSize;
    varying vec2 v_texCoord;

    void main() {
      vec2 onePixel = vec2(1.0) / u_textureSize;

      // Sample neighboring pixels for Sobel operator
      float tl = texture2D(u_image, v_texCoord + vec2(-onePixel.x, -onePixel.y)).r;
      float tm = texture2D(u_image, v_texCoord + vec2( 0.0, -onePixel.y)).r;
      float tr = texture2D(u_image, v_texCoord + vec2( onePixel.x, -onePixel.y)).r;
      float ml = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  0.0)).r;
      float mr = texture2D(u_image, v_texCoord + vec2( onePixel.x,  0.0)).r;
      float bl = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  onePixel.y)).r;
      float bm = texture2D(u_image, v_texCoord + vec2( 0.0,  onePixel.y)).r;
      float br = texture2D(u_image, v_texCoord + vec2( onePixel.x,  onePixel.y)).r;

      // Sobel X kernel: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
      float sobelX = -tl + tr - 2.0 * ml + 2.0 * mr - bl + br;

      // Sobel Y kernel: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
      float sobelY = -tl - 2.0 * tm - tr + bl + 2.0 * bm + br;

      // Calculate gradient magnitude
      float magnitude = sqrt(sobelX * sobelX + sobelY * sobelY);

      // Normalize magnitude to [0, 1] range
      // Max theoretical magnitude for normalized [0,1] input with Sobel is ~5.66
      // Use 6.0 as divisor to ensure we stay in [0, 1] range
      float magnitudeNormalized = magnitude / 6.0;

      // Calculate edge direction (perpendicular to gradient)
      // atan2 returns [-\u03C0, \u03C0], we add \u03C0/2 and normalize to [0, 2\u03C0)
      float direction = atan(sobelY, sobelX) + 3.14159265359 / 2.0;
      if (direction < 0.0) direction += 2.0 * 3.14159265359;

      // Normalize direction to [0, 1] for storage in texture
      float directionNormalized = direction / (2.0 * 3.14159265359);

      // Output: R = magnitude (normalized), G = direction (normalized), B = unused, A = 1.0
      gl_FragColor = vec4(magnitudeNormalized, directionNormalized, 0.0, 1.0);
    }
  `;function c(n,f,E){let g=n.createShader(f);return n.shaderSource(g,E),n.compileShader(g),n.getShaderParameter(g,n.COMPILE_STATUS)?g:(console.error("Shader compile error:",n.getShaderInfoLog(g)),n.deleteShader(g),null)}function o(n,f,E){let g=n.createProgram();return n.attachShader(g,f),n.attachShader(g,E),n.linkProgram(g),n.getProgramParameter(g,n.LINK_STATUS)?g:(console.error("Program link error:",n.getProgramInfoLog(g)),n.deleteProgram(g),null)}let r=c(t,t.VERTEX_SHADER,a),i=c(t,t.FRAGMENT_SHADER,s);if(!r||!i)return null;let d=o(t,r,i);if(!d)return null;let l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW);let u=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,u),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),{gl:t,program:d,positionBuffer:l,texCoordBuffer:u}}function Ke(e,t){let{width:a,height:s,data:c}=t,o=new Uint8Array(a*s);for(let i=0;i<c.length;i+=4){let d=Math.round(.299*c[i]+.587*c[i+1]+.114*c[i+2]);o[i/4]=d}let r=e.createTexture();return e.bindTexture(e.TEXTURE_2D,r),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,a,s,0,e.LUMINANCE,e.UNSIGNED_BYTE,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),r}function Me(e,t={}){let{applyNMS:a=!0,threshold:s=null,edgeSharpness:c=.8,highThreshold:o=null,lowThreshold:r=null}=t;s===null&&(s=.02+c*.18);let{width:i,height:d}=e,l=document.createElement("canvas");l.width=i,l.height=d;let u=$e(l);if(!u)return console.warn("WebGL not available, falling back to CPU"),null;let{gl:n,program:f,positionBuffer:E,texCoordBuffer:g}=u,h=Ke(n,e);n.viewport(0,0,i,d),n.useProgram(f);let p=n.getAttribLocation(f,"a_position"),M=n.getAttribLocation(f,"a_texCoord");n.bindBuffer(n.ARRAY_BUFFER,E),n.enableVertexAttribArray(p),n.vertexAttribPointer(p,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,g),n.enableVertexAttribArray(M),n.vertexAttribPointer(M,2,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,h),n.uniform1i(n.getUniformLocation(f,"u_image"),0),n.uniform2f(n.getUniformLocation(f,"u_textureSize"),i,d);let S=n.createTexture();n.bindTexture(n.TEXTURE_2D,S),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,d,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);let x=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,x),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,S,0);let y=n.checkFramebufferStatus(n.FRAMEBUFFER);if(y!==n.FRAMEBUFFER_COMPLETE)return console.error("WebGL framebuffer incomplete:",y),n.deleteTexture(h),n.deleteTexture(S),n.deleteFramebuffer(x),null;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,h),n.drawArrays(n.TRIANGLES,0,6);let v=n.getError();if(v!==n.NO_ERROR)return console.error("WebGL error during rendering:",v),n.deleteTexture(h),n.deleteTexture(S),n.deleteFramebuffer(x),null;let I=new Uint8Array(i*d*4);n.readPixels(0,0,i,d,n.RGBA,n.UNSIGNED_BYTE,I);let b=new Float32Array(i*d),w=new Float32Array(i*d);for(let C=0;C<i*d;C++){b[C]=I[C*4]/255;let T=I[C*4+1]/255;w[C]=T*2*Math.PI}let B=b;return a&&(B=ue(b,w,i,d)),B=de(B,i,d,{threshold:s,highThreshold:o,lowThreshold:r}),n.deleteTexture(h),n.deleteTexture(S),n.deleteFramebuffer(x),B}function Ce(e,t,a=2){if(t.length<a+1)return t.length===2?{x:t[0].x+(t[1].x-t[0].x)*e,y:t[0].y+(t[1].y-t[0].y)*e}:{x:t[0].x,y:t[0].y};if(a===2){let s=t[0],c=t[1],o=t[2],r=e*e,i=1-e,l=.5*(i*i),u=.5*(1+2*e-2*r),n=.5*r;return{x:l*s.x+u*c.x+n*o.x,y:l*s.y+u*c.y+n*o.y}}if(a===3){let s=t[0],c=t[1],o=t[2],r=t[3],i=e*e,d=i*e,l=1-e,f=l*l*l/6,E=(3*d-6*i+4)/6,g=(-3*d+3*i+3*e+1)/6,h=d/6;return{x:f*s.x+E*c.x+g*o.x+h*r.x,y:f*s.y+E*c.y+g*o.y+h*r.y}}return{x:t[0].x+(t[1].x-t[0].x)*e,y:t[0].y+(t[1].y-t[0].y)*e}}function we(e,t,a=null,s=null,c=.3){let o=[e];if(a&&s){let r=(e.x+t.x)/2,i=(e.y+t.y)/2,d=c,l=r+(a.x+s.x-2*r)*d,u=i+(a.y+s.y-2*i)*d;o.push({x:l,y:u})}else o.push({x:(e.x+t.x)/2,y:(e.y+t.y)/2});return o.push(t),o}function ve(e,t,a,s,c=2){let o=a.corners,r=o[0].x,i=o[0].x,d=o[0].y,l=o[0].y;for(let h=1;h<4;h++)r=Math.min(r,o[h].x),i=Math.max(i,o[h].x),d=Math.min(d,o[h].y),l=Math.max(l,o[h].y);let u=Math.max(i-r,l-d)*.1;if(e<r-u||e>i+u||t<d-u||t>l+u)return!1;let n=4,f=[];for(let h=0;h<4;h++){let p=o[h],M=o[(h+1)%4],S=(p.x+M.x)/2,x=(p.y+M.y)/2;for(let y=0;y<n;y++){let v=y/n,I=v*v,b=1-v,B=.5*(b*b),C=.5*(1+2*v-2*I),T=.5*I;f.push({x:B*p.x+C*S+T*M.x,y:B*p.y+C*x+T*M.y})}}let E=0,g=f.length;for(let h=0;h<g;h++){let p=f[h],M=f[(h+1)%g];p.y<=t?M.y>t&&(M.x-p.x)*(t-p.y)-(e-p.x)*(M.y-p.y)>0&&E++:M.y<=t&&(M.x-p.x)*(t-p.y)-(e-p.x)*(M.y-p.y)<0&&E--}return E!==0}function Se(e,t,a){let s=[[a[0],a[1]],[a[1],a[2]],[a[2],a[3]],[a[3],a[0]]],c=null;for(let[o,r]of s){let i=r.x-o.x,d=r.y-o.y,l=e-o.x,u=t-o.y,n=i*u-d*l;if(Math.abs(n)<1e-10)continue;let f=n>0?"left":"right";if(c===null)c=f;else if(c!==f)return!1}return!0}var me=class{constructor(t,a){this.x=t,this.y=a,this.originalX=t,this.originalY=a}reset(){this.x=this.originalX,this.y=this.originalY}},fe=class{constructor(t){this.corners=t}getBounds(t=!1,a=2){let s=1/0,c=1/0,o=-1/0,r=-1/0;for(let i of this.corners)s=Math.min(s,i.x),c=Math.min(c,i.y),o=Math.max(o,i.x),r=Math.max(r,i.y);if(t){let i=[[this.corners[0],this.corners[1]],[this.corners[1],this.corners[2]],[this.corners[2],this.corners[3]],[this.corners[3],this.corners[0]]];for(let[d,l]of i){let u=we(d,l);for(let n=0;n<=1;n+=.1){let f=Ce(n,u,a);s=Math.min(s,f.x),c=Math.min(c,f.y),o=Math.max(o,f.x),r=Math.max(r,f.y)}}}return{minX:s,minY:c,maxX:o,maxY:r}}getAverageColor(t,a=!1,s=null,c=2){let{data:o,width:r}=t,i=this.getBounds(a,c),d=Math.max(0,Math.floor(i.minX)),l=Math.max(0,Math.floor(i.minY)),u=Math.min(r-1,Math.floor(i.maxX)),n=Math.min(t.height-1,Math.floor(i.maxY)),f=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],E=Math.max(1,Math.floor(Math.min((u-d)/10,(n-l)/10,4))),g=0,h=0,p=0,M=0,S=0;for(let x=l;x<=n;x+=E)for(let y=d;y<=u;y+=E){let v=y+.5,I=x+.5,b=!1;if(a&&s?b=ve(v,I,this,s,c):b=Se(v,I,f),b){let w=(x*r+y)*4;g+=o[w],h+=o[w+1],p+=o[w+2],M+=o[w+3],S++}}if(S===0)for(let x=l;x<=n;x++)for(let y=d;y<=u;y++){let v=(x*r+y)*4;g+=o[v],h+=o[v+1],p+=o[v+2],M+=o[v+3],S++}return S===0?{r:0,g:0,b:0,a:255}:{r:Math.round(g/S),g:Math.round(h/S),b:Math.round(p/S),a:Math.round(M/S)}}getBlendedColor(t,a,s=!1,c=null,o=2){let{data:r,width:i}=t,d=this.getBounds(s,o),l=Math.max(0,Math.floor(d.minX)),u=Math.max(0,Math.floor(d.minY)),n=Math.min(i-1,Math.floor(d.maxX)),f=Math.min(t.height-1,Math.floor(d.maxY)),E=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],g=Math.max(1,Math.floor(Math.min((n-l)/15,(f-u)/15,2))),h=[],p=0,M=0,S=0,x=0;for(let T=u;T<=f;T+=g)for(let G=l;G<=n;G+=g){let U=G+.5,X=T+.5,H=!1;if(s&&c?H=ve(U,X,this,c,o):H=Se(U,X,E),H){let N=(T*i+G)*4,R=r[N],D=r[N+1],P=r[N+2],A=r[N+3];h.push({r:R,g:D,b:P,a:A}),p+=R,M+=D,S+=P,x+=A}}if(h.length===0)return this.getAverageColor(t,s,c,o);let y=h.length;p=Math.round(p/y),M=Math.round(M/y),S=Math.round(S/y),x=Math.round(x/y),h.sort((T,G)=>T.r+T.g+T.b-(G.r+G.g+G.b));let v=Math.floor(h.length/2),I=h[v].r,b=h[v].g,w=h[v].b,B=h[v].a,C=a;return{r:Math.round(p*(1-C)+I*C),g:Math.round(M*(1-C)+b*C),b:Math.round(S*(1-C)+w*C),a:Math.round(x*(1-C)+B*C)}}};function Te(e,t,a){let s=Math.ceil(e/a),c=Math.ceil(t/a),o=[],r=[];for(let i=0;i<=c;i++){let d=[];for(let l=0;l<=s;l++){let u=l*e/s,n=i*t/c;d.push(new me(u,n))}o.push(d)}for(let i=0;i<c;i++)for(let d=0;d<s;d++){let l=new fe([o[i][d],o[i][d+1],o[i+1][d+1],o[i+1][d]]);r.push(l)}return{corners:o,cells:r,cols:s,rows:c}}function Ze(e,t,a){let{width:s,height:c}=t,{cols:o,rows:r}=e,i=new ImageData(s,c),d=i.data,l=s/o,u=c/r;for(let n=0;n<r;n++)for(let f=0;f<o;f++){let E=n*o+f,g=a[E],h=Math.floor(f*l),p=Math.floor((f+1)*l),M=Math.floor(n*u),S=Math.floor((n+1)*u);for(let x=M;x<S&&x<c;x++)for(let y=h;y<p&&y<s;y++){let v=(x*s+y)*4;d[v]=g.r,d[v+1]=g.g,d[v+2]=g.b,d[v+3]=255}}return i}function Ie(e,t,a,s,c,o,r,i=!1,d=null,l=null,u=2,n=.3){let f=o-s,E=r-c,g=Math.sqrt(f*f+E*E);if(g<1)return 0;let h=Math.max(3,Math.ceil(g*1.5)),p=0,M=0,S=0,x=null;i&&(x=we({x:s,y:c},{x:o,y:r},d,l,n));for(let b=0;b<=h;b++){let w=b/h,B,C;if(i&&x){let X=Ce(w,x,u);B=X.x,C=X.y}else B=s+f*w,C=c+E*w;let T=Math.max(0,Math.min(t-1,B)),G=Math.max(0,Math.min(a-1,C));he(e,t,a,T,G,!1)>0?(p++,M++,S=Math.max(S,M)):M=0}let y=p/(h+1),v=S/(h+1),I=he(e,t,a,Math.max(0,Math.min(t-1,s)),Math.max(0,Math.min(a-1,c)),!1)>0?.2:0;return y*.4+v*.4+I}function be(e,t,a,s,c,o=3){let r=0,i=0;for(let d=-o;d<=o;d++)for(let l=-o;l<=o;l++){let u=Math.floor(s+l),n=Math.floor(c+d);if(u>=0&&u<t&&n>=0&&n<a){i++;let f=n*t+u;e[f]>0&&r++}}return i>0?r/i:0}function Pe(e,t,a,s,c={}){let{searchSteps:o=9,numIterations:r=2,stepSize:i=1,edgeSharpness:d=.8,useSplines:l=!1,splineDegree:u=2,splineSmoothness:n=.3}=c;if(!t||t.length!==a*s)return console.warn("Invalid edge map for grid optimization"),e;let{corners:f,cells:E}=e,g=f.length,h=f[0].length,p=.3+d*.5,M=.2*(1-d*.5);for(let S=0;S<r;S++)for(let x=1;x<g-1;x++)for(let y=1;y<h-1;y++){let v=f[x][y],I=v.x,b=v.y,w=[];x>0&&w.push(f[x-1][y]),x<g-1&&w.push(f[x+1][y]),y>0&&w.push(f[x][y-1]),y<h-1&&w.push(f[x][y+1]);let B=be(t,a,s,v.x,v.y,Math.ceil(i));for(let N of w){let R=null,D=null;if(l){let P=N.x-v.x,A=N.y-v.y;Math.abs(P)>Math.abs(A)?(x>0&&(R=f[x-1][y]),x<g-1&&(D=f[x+1][y])):(y>0&&(R=f[x][y-1]),y<h-1&&(D=f[x][y+1]))}B+=Ie(t,a,s,v.x,v.y,N.x,N.y,l,R,D,u,n)}let C=Math.floor(Math.sqrt(o)),T=Math.floor(C/2);for(let N=-T;N<=T;N++)for(let R=-T;R<=T;R++){if(R===0&&N===0)continue;let D=v.x+R*i,P=v.y+N*i;if(D<0||D>=a||P<0||P>=s)continue;let A=be(t,a,s,D,P,Math.ceil(i));for(let F of w){let _=null,k=null;if(l){let V=F.x-D,O=F.y-P;Math.abs(V)>Math.abs(O)?(x>0&&(_=f[x-1][y]),x<g-1&&(k=f[x+1][y])):(y>0&&(_=f[x][y-1]),y<h-1&&(k=f[x][y+1]))}A+=Ie(t,a,s,D,P,F.x,F.y,l,_,k,u,n)}A>B&&(B=A,I=D,b=P)}let G=S/Math.max(1,r-1),U=p+M*(1-G),X=I-v.x,H=b-v.y;v.x+=X*U,v.y+=H*U}return e}function Ae(e,t,a=null,s=.8,c=!1,o=2){let{width:r,height:i}=t,d=[];for(let l=0;l<e.cells.length;l++)d.push(e.cells[l].getBlendedColor(t,s,c,e,o));return Ze(e,t,d)}function ge(e,t,a){let s=document.createElement("canvas");s.width=t,s.height=a;let c=s.getContext("2d"),o=c.createImageData(t,a),r=o.data;if(e.length!==t*a){console.warn(`Edge map size mismatch: expected ${t*a}, got ${e.length}`);for(let l=0;l<r.length;l+=4)r[l]=255,r[l+1]=0,r[l+2]=0,r[l+3]=255;return c.putImageData(o,0,0),s}let i=!1,d=0;for(let l=0;l<e.length;l++)e[l]>0&&(i=!0,d=Math.max(d,e[l]));if(i)for(let l=0;l<e.length;l++){let u=e[l],n=l*4;if(u>0){let f=Math.round(u*255);r[n]=f,r[n+1]=f,r[n+2]=f}else r[n]=0,r[n+1]=0,r[n+2]=0;r[n+3]=255}else for(let l=0;l<r.length;l+=4)r[l]=32,r[l+1]=32,r[l+2]=32,r[l+3]=255;return c.putImageData(o,0,0),s}function Be(e){let{width:t,height:a,data:s}=e,c=document.createElement("canvas");c.width=t,c.height=a;let o=c.getContext("2d"),r=o.createImageData(t,a),i=r.data;for(let d=0;d<s.length;d+=4){let l=Math.round(.299*s[d]+.587*s[d+1]+.114*s[d+2]);i[d]=l,i[d+1]=l,i[d+2]=l,i[d+3]=s[d+3]}return o.putImageData(r,0,0),c}function pe(e,t,a="rgba(255, 0, 0, 0.7)",s=1){let c=document.createElement("canvas");c.width=e.width,c.height=e.height;let o=c.getContext("2d");o.drawImage(e,0,0),o.strokeStyle=a,o.lineWidth=s,o.lineCap="round",o.lineJoin="round";let{corners:r}=t,i=r.length,d=r[0].length,l=e.width/(d-1),u=e.height/(i-1),n=Math.min(l,u),f=n<20?Math.ceil(20/n):1;for(let E=0;E<i;E+=f){o.beginPath(),o.moveTo(r[E][0].x,r[E][0].y);for(let g=1;g<d;g++)o.lineTo(r[E][g].x,r[E][g].y);o.stroke()}if(f>1&&i>1){let E=i-1;o.beginPath(),o.moveTo(r[E][0].x,r[E][0].y);for(let g=1;g<d;g++)o.lineTo(r[E][g].x,r[E][g].y);o.stroke()}for(let E=0;E<d;E+=f){o.beginPath(),o.moveTo(r[0][E].x,r[0][E].y);for(let g=1;g<i;g++)o.lineTo(r[g][E].x,r[g][E].y);o.stroke()}if(f>1&&d>1){let E=d-1;o.beginPath(),o.moveTo(r[0][E].x,r[0][E].y);for(let g=1;g<i;g++)o.lineTo(r[g][E].x,r[g][E].y);o.stroke()}return c}function Q(e){let t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),t}function Re(e,t,a={}){let{returnCanvas:s=!1,colorLimit:c=null,contrast:o=1}=a,r=e instanceof ImageData?e:_e(e),i=it(e,t),d=i.scaledImageData;c&&c>0&&(d=Ge(d,c),i.scaledCanvas.getContext("2d").putImageData(d,0,0),i.scaledImageData=d);let l=lt(i);if(o!==1){let u=l.getContext("2d").getImageData(0,0,l.width,l.height);u=De(u,o),l.getContext("2d").putImageData(u,0,0)}return s?l:l.getContext("2d").getImageData(0,0,l.width,l.height)}function Je(e,t,a,s){let{width:c,height:o,data:r}=e,i=new ImageData(c,o),d=i.data;for(let l=0;l<o;l+=a)for(let u=0;u<c;u+=a){let n=Math.min(u+a,c),f=Math.min(l+a,o),E=[],g=!1,h=0;for(let M=l;M<f;M++)for(let S=u;S<n;S++){let x=(M*c+S)*4;E.push({r:r[x],g:r[x+1],b:r[x+2],a:r[x+3]});let y=M*c+S;t[y]>0&&(g=!0,h=Math.max(h,t[y]))}let p;if(g&&s>0){let M=Qe(E);if(s>=1)p=M;else{let S=Le(E),x=s*h;p={r:Math.round(S.r*(1-x)+M.r*x),g:Math.round(S.g*(1-x)+M.g*x),b:Math.round(S.b*(1-x)+M.b*x),a:Math.round(S.a*(1-x)+M.a*x)}}}else p=Le(E);for(let M=l;M<f;M++)for(let S=u;S<n;S++){let x=(M*c+S)*4;d[x]=p.r,d[x+1]=p.g,d[x+2]=p.b,d[x+3]=p.a}}return i}function Le(e){let t=0,a=0,s=0,c=0;for(let r of e)t+=r.r,a+=r.g,s+=r.b,c+=r.a;let o=e.length;return{r:Math.round(t/o),g:Math.round(a/o),b:Math.round(s/o),a:Math.round(c/o)}}function Qe(e){if(e.length===0)return{r:0,g:0,b:0,a:255};if(e.length===1)return e[0];let t=[...e].sort((a,s)=>{let c=.299*a.r+.587*a.g+.114*a.b,o=.299*s.r+.587*s.g+.114*s.b;return c-o});return t[Math.floor(t.length/2)]}function et(e,t){let a=new Uint8ClampedArray(e.data),s=e.width,c=e.height,o=Math.max(1,Math.floor(Math.sqrt(s*c)/100)),r=[];for(let u=0;u<a.length;u+=4*o){let n=a[u],f=a[u+1],E=a[u+2];r.push({r:n,g:f,b:E})}let i=[];if(r.length<=t){let u=new Map;for(let n of r){let f=`${n.r},${n.g},${n.b}`;if(!u.has(f)&&(u.set(f,n),u.size>=t))break}i.push(...Array.from(u.values()))}else{let u=new Map;for(let f of r){let E=`${f.r},${f.g},${f.b}`;u.set(E,(u.get(E)||0)+1)}let n=Array.from(u.entries()).sort((f,E)=>E[1]-f[1]).map(([f])=>{let[E,g,h]=f.split(",").map(Number);return{r:E,g,b:h}});for(i.push(n[0]);i.length<t&&i.length<n.length;){let f=-1,E=null;for(let g of n){if(i.some(p=>p.r===g.r&&p.g===g.g&&p.b===g.b))continue;let h=1/0;for(let p of i){let M=Math.sqrt(Math.pow(g.r-p.r,2)+Math.pow(g.g-p.g,2)+Math.pow(g.b-p.b,2));M<h&&(h=M)}h>f&&(f=h,E=g)}if(E)i.push(E);else{for(let g of n){if(i.length>=t)break;i.some(h=>h.r===g.r&&h.g===g.g&&h.b===g.b)||i.push(g)}break}}}i.length===0&&i.push({r:128,g:128,b:128});let d=new ImageData(s,c),l=d.data;for(let u=0;u<a.length;u+=4){let n=a[u],f=a[u+1],E=a[u+2],g=a[u+3],h=1/0,p=i[0];for(let M of i){let S=Math.sqrt(Math.pow(n-M.r,2)+Math.pow(f-M.g,2)+Math.pow(E-M.b,2));S<h&&(h=S,p=M)}l[u]=p.r,l[u+1]=p.g,l[u+2]=p.b,l[u+3]=g}return d}function tt(e,t){let a=e.data,s=new ImageData(e.width,e.height),c=s.data;for(let o=0;o<a.length;o+=4)c[o]=Math.max(0,Math.min(255,Math.round((a[o]-128)*t+128))),c[o+1]=Math.max(0,Math.min(255,Math.round((a[o+1]-128)*t+128))),c[o+2]=Math.max(0,Math.min(255,Math.round((a[o+2]-128)*t+128))),c[o+3]=a[o+3];return s}function _e(e){if(e instanceof ImageData)return e;let t=document.createElement("canvas");if(e instanceof HTMLCanvasElement)t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0);else if(e instanceof HTMLImageElement){let a=e.naturalWidth||e.width,s=e.naturalHeight||e.height;t.width=a,t.height=s,t.getContext("2d").drawImage(e,0,0)}else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");return t.getContext("2d").getImageData(0,0,t.width,t.height)}async function nt(e,t={}){let{edgeSharpness:a=.8,onProgress:s=null}=t,{width:c,height:o}=e,r=null,i=!1;try{if(r=Me(e,{edgeSharpness:a}),i=r!==null,r)if(r.length!==c*o)console.warn("WebGL edge map size mismatch, falling back to CPU"),r=null,i=!1;else{let d=0,l=Math.min(1e4,r.length),u=Math.max(1,Math.floor(r.length/l));for(let n=0;n<r.length;n+=u)r[n]>0&&d++;if(d===0&&l>100){console.warn("WebGL edge map has no edges in sample, trying CPU");let n=ae(e,{edgeSharpness:a}),f=0,E=Math.max(1,Math.floor(n.length/l));for(let g=0;g<n.length;g+=E)n[g]>0&&f++;f>0&&(r=n,i=!1)}}}catch(d){console.error("WebGL edge detection error:",d),r=null,i=!1}return r||(r=ae(e,{edgeSharpness:a})),s&&s({usingGPU:i}),{edgeMap:r,usingGPU:i}}function ot(e,t){return Te(e.width,e.height,t)}function at(e,t={}){let{grid:a,edgeMap:s,imageData:c}=e,{searchSteps:o=9,numIterations:r=2,stepSize:i=1,edgeSharpness:d=.8,useSplines:l=!1,splineDegree:u=2,splineSmoothness:n=.3}=t;if(!a||!s||!c)throw new Error("optimizeGridStep requires grid, edgeMap, and imageData in context");let{width:f,height:E}=c,g=Math.max(o,Math.floor(9+d*16)),h=Math.max(r,Math.floor(2+d*3));return Pe(a,s,f,E,{searchSteps:g,numIterations:h,stepSize:i||1,edgeSharpness:d,useSplines:l,splineDegree:u,splineSmoothness:n})}function st(e,t,a,s){return Je(e,t,a,s)}function De(e,t){return t===1?e:tt(e,t)}function Ge(e,t){return!t||t<=0?e:et(e,t)}function rt(e,t=!1){if(!t)return e;let a=document.createElement("canvas");return a.width=e.width,a.height=e.height,a.getContext("2d").putImageData(e,0,0),a}function it(e,t){let a,s;if(e instanceof ImageData)a=e.width,s=e.height;else if(e instanceof HTMLCanvasElement)a=e.width,s=e.height;else if(e instanceof HTMLImageElement)a=e.naturalWidth||e.width,s=e.naturalHeight||e.height;else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");let c=Math.max(1,Math.floor(a/t)),o=Math.max(1,Math.floor(s/t)),r=document.createElement("canvas");r.width=c,r.height=o;let i=r.getContext("2d");if(i.imageSmoothingEnabled=!1,e instanceof ImageData){let l=document.createElement("canvas");l.width=a,l.height=s,l.getContext("2d").putImageData(e,0,0),i.drawImage(l,0,0,c,o)}else i.drawImage(e,0,0,c,o);return{scaledImageData:i.getImageData(0,0,c,o),originalSize:{width:a,height:s},scaledCanvas:r}}function lt(e){let{scaledImageData:t,originalSize:a,scaledCanvas:s}=e;if(!t||!a||!s)throw new Error("upscaleImageStep requires scaledImageData, originalSize, and scaledCanvas from downscaleImageStep");let c=document.createElement("canvas");c.width=a.width,c.height=a.height;let o=c.getContext("2d");return o.imageSmoothingEnabled=!1,o.drawImage(s,0,0,a.width,a.height),c}async function Fe(e,t,a={}){let{returnCanvas:s=!1,searchSteps:c=9,numIterations:o=2,onProgress:r=null,colorLimit:i=null,contrast:d=1,edgeSharpness:l=.8,captureIntermediates:u=!1,useSplines:n=!1,splineDegree:f=2,splineSmoothness:E=.3}=a,g=u?[]:null,h=_e(e),{width:p,height:M}=h;u&&g.push({name:"Original",canvas:Q(h)});let S=await nt(h,{edgeSharpness:l,onProgress:r}),{edgeMap:x,usingGPU:y}=S,v=null;if(u){let O=function(W,Y,j,K,q){let $=ge(W,Y,j),z=document.createElement("canvas");z.width=K,z.height=q;let J=z.getContext("2d");return J.imageSmoothingEnabled=!1,J.drawImage($,0,0,Y,j,0,0,K,q),z};g.push({name:"Grayscale",canvas:Be(h)});let A=Math.min(1,800/Math.max(p,M)),F=Math.round(p*A),_=Math.round(M*A),k=h;if(A<1){let W=document.createElement("canvas");W.width=F,W.height=_;let Y=W.getContext("2d"),j=Q(h);Y.drawImage(j,0,0,F,_),k=Y.getImageData(0,0,F,_)}let V=ae(k,{edgeSharpness:l,captureIntermediates:!0});if(g.push({name:"Gradient Magnitude",canvas:O(V.intermediates.magnitude,F,_,p,M)}),g.push({name:"After NMS",canvas:O(V.intermediates.afterNMS,F,_,p,M)}),x&&x.length===p*M){let W=0;for(let Y=0;Y<x.length;Y++)x[Y]>0&&W++;W>0?(v=ge(x,p,M),g.push({name:"Edge Map",canvas:v})):(console.warn("Full-res edge map has no edges, using downscaled version for visualization"),v=O(V.intermediates.afterThreshold,F,_,p,M),g.push({name:"Edge Map",canvas:v}))}else console.warn("Full-res edge map invalid, using downscaled version for visualization"),v=O(V.intermediates.afterThreshold,F,_,p,M),g.push({name:"Edge Map",canvas:v})}let I=ot(h,t),b=0;for(let P=0;P<x.length;P++)x[P]>0&&b++;let w=(b/x.length*100).toFixed(2);if(u){let P=Q(h);g.push({name:"Initial Grid",canvas:pe(P,I,"rgba(255, 0, 0, 1.0)",2)})}let B=.5+l*1.5,C=Math.max(1,t*.3*B),T=Math.max(c,Math.floor(9+l*16)),G=Math.max(o,Math.floor(2+l*3)),U=null;u&&(U={corners:I.corners.map(P=>P.map(A=>({x:A.x,y:A.y})))}),b===0&&console.warn("Edge map has no edges - grid optimization will have no effect");let X=u?Math.max(C,t*.5):C,H=u?Math.max(T,25):T,N=u?Math.max(G,4):G;if(at({grid:I,edgeMap:x,imageData:h},{searchSteps:H,numIterations:N,stepSize:X,edgeSharpness:l,useSplines:n,splineDegree:f,splineSmoothness:E}),u){let P=I.corners.length,A=I.corners[0].length,F=Math.ceil(t);if(b>0)for(let _=1;_<P-1;_++)for(let k=1;k<A-1;k++){let V=I.corners[_][k],O=Math.floor(V.x),W=Math.floor(V.y),Y=0,j=0,K=1/0;for(let q=1;q<=F;q++)for(let $=-q;$<=q;$++)for(let z=-q;z<=q;z++){let J=O+z,ce=W+$;if(J>=0&&J<p&&ce>=0&&ce<M){let je=ce*p+J;if(x[je]>0){let Ee=Math.sqrt(z*z+$*$);Ee<K&&(K=Ee,Y=z,j=$)}}}K<1/0&&K>0&&(V.x=O+Y,V.y=W+j)}}if(u){let P=Q(h);g.push({name:"Optimized Grid",canvas:pe(P,I,"rgba(0, 255, 0, 1.0)",2)})}r&&r({usingGPU:y});let R;n?R=Ae(I,h,x,l,n,f):R=st(h,x,t,l),R=De(R,d),R=Ge(R,i);let D=rt(R,!0);return D._usingGPU=y,u?(g.push({name:"Final Result",canvas:D}),{canvas:D,intermediates:g,usingGPU:y}):s?D:R}function Ne(e){return new Promise((t,a)=>{let s=new Image;if(s.onload=()=>t(s),s.onerror=()=>a(new Error("Failed to load image")),e instanceof File){let c=new FileReader;c.onload=o=>{s.src=o.target.result},c.onerror=()=>a(new Error("Failed to read file")),c.readAsDataURL(e)}else s.src=e})}function ye(e,t,a={}){let{interpolation:s="nearest",fillMode:c="constant",fillValue:o=0,returnCanvas:r=!1}=a;if(t.length!==8)throw new Error("Transform matrix must have 8 elements [a1, a2, a3, b1, b2, b3, c1, c2]");let[i,d,l,u,n,f,E,g]=t,h,p,M;if(e instanceof ImageData)h=e.width,p=e.height,M=e.data;else{let I=document.createElement("canvas");if(e instanceof HTMLCanvasElement)I.width=e.width,I.height=e.height,I.getContext("2d").drawImage(e,0,0);else if(e instanceof HTMLImageElement)I.width=e.naturalWidth||e.width,I.height=e.naturalHeight||e.height,I.getContext("2d").drawImage(e,0,0);else throw new Error("Unsupported image type");h=I.width,p=I.height,M=I.getContext("2d").getImageData(0,0,h,p).data}let S=document.createElement("canvas");S.width=h,S.height=p;let x=S.getContext("2d"),y=x.createImageData(h,p),v=y.data;for(let I=0;I<p;I++)for(let b=0;b<h;b++){let w=b,B=I,C=E*w+g*B+1;if(Math.abs(C)<1e-4){let A=(I*h+b)*4;v[A]=o,v[A+1]=o,v[A+2]=o,v[A+3]=255;continue}let T=(i*w+d*B+l)/C,G=(u*w+n*B+f)/C,U=Ue(T,h,c),X=Ue(G,p,c),H,N,R,D;if(s==="nearest"){let A=Math.round(U),F=Math.round(X),_=ee(M,A,F,h,p,o);H=_.r,N=_.g,R=_.b,D=_.a}else{let A=Math.floor(U),F=Math.floor(X),_=A+1,k=F+1,V=ee(M,A,F,h,p,o),O=ee(M,_,F,h,p,o),W=ee(M,A,k,h,p,o),Y=ee(M,_,k,h,p,o),j=U-A,K=X-F,q=xe(V,O,j),$=xe(W,Y,j),z=xe(q,$,K);H=z.r,N=z.g,R=z.b,D=z.a}let P=(I*h+b)*4;v[P]=H,v[P+1]=N,v[P+2]=R,v[P+3]=D}return x.putImageData(y,0,0),r?S:y}function Ue(e,t,a){if(a==="constant")return e;if(a==="reflect"){if(e<0){if(t<=1)return 0;let s=2*t;e<-s&&(e=e+s*Math.floor(-e/s)),e=e<-t?e+s:-e-1}else if(e>t-1){if(t<=1)return 0;let s=2*t;e=e-s*Math.floor(e/s),e>=t&&(e=s-e-1)}return Math.max(0,Math.min(t-1,e))}else if(a==="wrap"){if(e<0){if(t<=1)return 0;let s=t-1;e=e+t*(Math.floor(-e/s)+1)}else if(e>t-1){if(t<=1)return 0;let s=t-1;e=e-t*Math.floor(e/s)}return Math.max(0,Math.min(t-1,e))}else if(a==="nearest")return Math.max(0,Math.min(t-1,e));return e}function ee(e,t,a,s,c,o){if(t>=0&&t<s&&a>=0&&a<c){let r=(a*s+t)*4;return{r:e[r],g:e[r+1],b:e[r+2],a:e[r+3]}}else return{r:o,g:o,b:o,a:255}}function xe(e,t,a){return{r:Math.round(e.r+(t.r-e.r)*a),g:Math.round(e.g+(t.g-e.g)*a),b:Math.round(e.b+(t.b-e.b)*a),a:Math.round(e.a+(t.a-e.a)*a)}}function Xe(e,t,a){let s=Math.cos(e),c=Math.sin(e),o=t-t*s+a*c,r=a-t*c-a*s;return[s,-c,o,c,s,r,0,0]}function ze(e,t,a,s){return[e,0,a*(1-e),0,t,s*(1-t),0,0]}var m={imageInput:document.getElementById("imageInput"),pixelSizeSlider:document.getElementById("pixelSize"),pixelSizeNumber:document.getElementById("pixelSizeNumber"),pixelSizeValue:document.getElementById("pixelSizeValue"),colorLimitSlider:document.getElementById("colorLimit"),colorLimitNumber:document.getElementById("colorLimitNumber"),colorLimitValue:document.getElementById("colorLimitValue"),colorLimitGroup:document.getElementById("colorLimitGroup"),useColorLimit:document.getElementById("useColorLimit"),useEdgeAware:document.getElementById("useEdgeAware"),gpuIndicator:document.getElementById("gpuIndicator"),gpuStatus:document.getElementById("gpuStatus"),edgeSharpnessGroup:document.getElementById("edgeSharpnessGroup"),edgeSharpnessSlider:document.getElementById("edgeSharpness"),edgeSharpnessNumber:document.getElementById("edgeSharpnessNumber"),edgeSharpnessValue:document.getElementById("edgeSharpnessValue"),numPassesGroup:document.getElementById("numPassesGroup"),numPassesSlider:document.getElementById("numPasses"),numPassesNumber:document.getElementById("numPassesNumber"),numPassesValue:document.getElementById("numPassesValue"),showStepsGroup:document.getElementById("showStepsGroup"),showAlgorithmSteps:document.getElementById("showAlgorithmSteps"),useSplinesGroup:document.getElementById("useSplinesGroup"),useSplines:document.getElementById("useSplines"),splineSmoothnessGroup:document.getElementById("splineSmoothnessGroup"),splineSmoothnessSlider:document.getElementById("splineSmoothness"),splineSmoothnessNumber:document.getElementById("splineSmoothnessNumber"),splineSmoothnessValue:document.getElementById("splineSmoothnessValue"),stepNavigation:document.getElementById("stepNavigation"),stepLabel:document.getElementById("stepLabel"),stepCounter:document.getElementById("stepCounter"),stepPrev:document.getElementById("stepPrev"),stepNext:document.getElementById("stepNext"),contrastGroup:document.getElementById("contrastGroup"),contrastSlider:document.getElementById("contrast"),contrastNumber:document.getElementById("contrastNumber"),contrastValue:document.getElementById("contrastValue"),useProjection:document.getElementById("useProjection"),rotationGroup:document.getElementById("rotationGroup"),rotationAngleSlider:document.getElementById("rotationAngle"),rotationAngleNumber:document.getElementById("rotationAngleNumber"),rotationAngleValue:document.getElementById("rotationAngleValue"),useScaling:document.getElementById("useScaling"),scalingGroup:document.getElementById("scalingGroup"),scalingGroupY:document.getElementById("scalingGroupY"),scaleXSlider:document.getElementById("scaleX"),scaleXNumber:document.getElementById("scaleXNumber"),scaleXValue:document.getElementById("scaleXValue"),scaleYSlider:document.getElementById("scaleY"),scaleYNumber:document.getElementById("scaleYNumber"),scaleYValue:document.getElementById("scaleYValue"),pixelateBtn:document.getElementById("pixelateBtn"),mainCanvas:document.getElementById("mainCanvas"),canvasTitle:document.getElementById("canvasTitle")},L={intermediates:[],currentStep:0},ne=m.mainCanvas.getContext("2d"),se=null,te=null;function ie(e,t,a,s,c,o){let r=()=>{let d=e.value;t.value=d,a.textContent=d},i=d=>{let l=Math.max(s,Math.min(c,parseInt(d.target.value)||o));e.value=l,t.value=l,a.textContent=l};e.addEventListener("input",r),t.addEventListener("input",i),r()}ie(m.pixelSizeSlider,m.pixelSizeNumber,m.pixelSizeValue,2,128,3);ie(m.colorLimitSlider,m.colorLimitNumber,m.colorLimitValue,2,256,32);ie(m.numPassesSlider,m.numPassesNumber,m.numPassesValue,1,10,3);function oe(e,t,a,s,c,o){let r=()=>{let d=parseFloat(e.value);t.value=d.toFixed(1),a.textContent=d.toFixed(1)},i=d=>{let l=Math.max(s,Math.min(c,parseFloat(d.target.value)||o));e.value=l,t.value=l.toFixed(1),a.textContent=l.toFixed(1)};e.addEventListener("input",r),t.addEventListener("input",i),r()}oe(m.edgeSharpnessSlider,m.edgeSharpnessNumber,m.edgeSharpnessValue,0,1,.8);oe(m.contrastSlider,m.contrastNumber,m.contrastValue,.5,2,1);ie(m.rotationAngleSlider,m.rotationAngleNumber,m.rotationAngleValue,0,360,0);oe(m.scaleXSlider,m.scaleXNumber,m.scaleXValue,.1,3,1);oe(m.scaleYSlider,m.scaleYNumber,m.scaleYValue,.1,3,1);oe(m.splineSmoothnessSlider,m.splineSmoothnessNumber,m.splineSmoothnessValue,0,1,.3);function Ye(){let e=m.useSplines.checked;m.splineSmoothnessGroup.style.display=e?"flex":"none"}function ke(){let e=m.useEdgeAware.checked;m.edgeSharpnessGroup.style.display=e?"flex":"none",m.numPassesGroup.style.display=e?"flex":"none",m.showStepsGroup.style.display=e?"flex":"none",m.useSplinesGroup.style.display=e?"flex":"none",m.gpuIndicator.style.display=e?"block":"none",e||(m.gpuStatus.textContent="",m.stepNavigation.classList.remove("active"),L.intermediates=[]),Ye()}function Ve(){let e=m.useColorLimit.checked;m.colorLimitGroup.style.display=e?"flex":"none"}function We(){let e=m.useProjection.checked;m.rotationGroup.style.display=e?"flex":"none"}function He(){let e=m.useScaling.checked;m.scalingGroup.style.display=e?"flex":"none",m.scalingGroupY.style.display=e?"flex":"none"}function re(e){let t=e,a=e.width/2,s=e.height/2;if(m.useScaling.checked){let c=parseFloat(m.scaleXSlider.value),o=parseFloat(m.scaleYSlider.value),r=ze(c,o,a,s);t=ye(t,r,{returnCanvas:!0,interpolation:"nearest"})}if(m.useProjection.checked){let c=parseFloat(m.rotationAngleSlider.value)*Math.PI/180,o=Xe(c,a,s);t=ye(t,o,{returnCanvas:!0,interpolation:"nearest"})}return t}function le(e){if(!L.intermediates.length)return;L.currentStep=Math.max(0,Math.min(e,L.intermediates.length-1));let t=L.intermediates[L.currentStep],a=t.canvas;if(t.name==="Final Result"){let s=t.originalCanvas||t.canvas;a=re(s)}m.mainCanvas.width=a.width,m.mainCanvas.height=a.height,ne.drawImage(a,0,0),m.canvasTitle.textContent=t.name,m.stepLabel.textContent=t.name,m.stepCounter.textContent=`Step ${L.currentStep+1} of ${L.intermediates.length}`}function Oe(){if(!L.intermediates.length)return;let e=(L.currentStep+1)%L.intermediates.length;le(e)}function qe(){if(!L.intermediates.length)return;let e=(L.currentStep-1+L.intermediates.length)%L.intermediates.length;le(e)}function ct(e){L.intermediates=e,L.currentStep=e.length-1,m.stepNavigation.classList.add("active"),le(L.currentStep)}m.stepPrev.addEventListener("click",qe);m.stepNext.addEventListener("click",Oe);document.addEventListener("keydown",e=>{L.intermediates.length!==0&&(e.key==="ArrowLeft"?qe():e.key==="ArrowRight"&&Oe())});Ve();ke();We();He();m.useColorLimit.addEventListener("change",Ve);m.useEdgeAware.addEventListener("change",ke);m.useSplines.addEventListener("change",Ye);m.useProjection.addEventListener("change",We);m.useScaling.addEventListener("change",He);m.imageInput.addEventListener("change",async e=>{let t=e.target.files[0];if(!t){m.pixelateBtn.disabled=!0;return}try{m.pixelateBtn.disabled=!0,m.pixelateBtn.textContent="Loading...";let a=await Ne(t);se=a,m.mainCanvas.width=a.width,m.mainCanvas.height=a.height,ne.drawImage(a,0,0),m.canvasTitle.textContent="Original Image",m.stepNavigation.classList.remove("active"),L.intermediates=[],m.pixelateBtn.disabled=!1,m.pixelateBtn.textContent="Pixelate Image"}catch(a){alert("Failed to load image: "+a.message),m.pixelateBtn.disabled=!0,m.pixelateBtn.textContent="Pixelate Image"}});m.pixelateBtn.addEventListener("click",async()=>{if(m.pixelateBtn.disabled)return;if(m.pixelateBtn.disabled=!0,!se){alert("Please upload an image first."),m.pixelateBtn.disabled=!1;return}let e=parseInt(m.pixelSizeSlider.value),t=m.useColorLimit.checked?parseInt(m.colorLimitSlider.value):null,a=m.useEdgeAware.checked;try{m.pixelateBtn.textContent=a?"Processing (Edge-Aware)...":"Processing...",await new Promise(c=>setTimeout(c,0));let s;if(a){let c=parseFloat(m.contrastSlider.value),o=parseFloat(m.edgeSharpnessSlider.value),r=parseInt(m.numPassesSlider.value),i=m.showAlgorithmSteps.checked;m.gpuStatus.textContent="Processing...";let d=m.useSplines.checked,l=parseFloat(m.splineSmoothnessSlider.value),u=await Fe(se,e,{returnCanvas:!0,searchSteps:9,numIterations:r,colorLimit:t,contrast:c,edgeSharpness:o,useSplines:d,splineDegree:2,splineSmoothness:l,captureIntermediates:i,onProgress:n=>{n.usingGPU?(m.gpuStatus.textContent="\u2713 Using GPU acceleration",m.gpuStatus.style.color="#4caf50"):(m.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",m.gpuStatus.style.color="#ff9800")}});if(i&&u.intermediates){if(s=u.canvas,u.intermediates.length>0){let n=u.intermediates[u.intermediates.length-1];n.name==="Final Result"&&(n.originalCanvas=n.canvas)}ct(u.intermediates),u.usingGPU?(m.gpuStatus.textContent="\u2713 Using GPU acceleration",m.gpuStatus.style.color="#4caf50"):(m.gpuStatus.textContent="\u26A0 Using CPU (for visualization)",m.gpuStatus.style.color="#ff9800")}else{s=u,te=s,m.stepNavigation.classList.remove("active"),L.intermediates=[];let n=re(s);m.mainCanvas.width=n.width,m.mainCanvas.height=n.height,ne.drawImage(n,0,0),m.canvasTitle.textContent="Pixelated Image",u._usingGPU!==void 0&&(u._usingGPU?(m.gpuStatus.textContent="\u2713 Using GPU acceleration",m.gpuStatus.style.color="#4caf50"):(m.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",m.gpuStatus.style.color="#ff9800"))}}else{let c=parseFloat(m.contrastSlider.value);await new Promise(r=>requestAnimationFrame(r)),s=Re(se,e,{returnCanvas:!0,colorLimit:t,contrast:c}),m.stepNavigation.classList.remove("active"),L.intermediates=[],te=s;let o=re(s);m.mainCanvas.width=o.width,m.mainCanvas.height=o.height,ne.drawImage(o,0,0),m.canvasTitle.textContent="Pixelated Image"}m.pixelateBtn.disabled=!1,m.pixelateBtn.textContent="Pixelate Image"}catch(s){alert("Failed to pixelate image: "+s.message),m.pixelateBtn.disabled=!1,m.pixelateBtn.textContent="Pixelate Image"}});function Z(){if(!(!te&&!L.intermediates.length)){if(L.intermediates.length>0)le(L.currentStep);else if(te){let e=re(te);m.mainCanvas.width=e.width,m.mainCanvas.height=e.height,ne.drawImage(e,0,0)}}}m.rotationAngleSlider.addEventListener("input",Z);m.rotationAngleNumber.addEventListener("input",Z);m.useProjection.addEventListener("change",Z);m.scaleXSlider.addEventListener("input",Z);m.scaleXNumber.addEventListener("input",Z);m.scaleYSlider.addEventListener("input",Z);m.scaleYNumber.addEventListener("input",Z);m.useScaling.addEventListener("change",Z);</script></body></html>