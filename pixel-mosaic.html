<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pixel Mosaic - Demo</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:8px}.control-group{display:flex;flex-direction:column;gap:8px}label{font-weight:600;color:#555;font-size:.9em}input[type=range]{width:100%}input[type=number]{width:80px;padding:6px;border:1px solid #ddd;border-radius:4px}input[type=file]{padding:8px;border:2px dashed #667eea;border-radius:4px;cursor:pointer}button{padding:12px 24px;background:#667eea;color:#fff;border:none;border-radius:6px;font-size:1em;font-weight:600;cursor:pointer;transition:background .3s}button:hover{background:#5568d3}button:disabled{background:#ccc;cursor:not-allowed}.canvas-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:30px}.canvas-wrapper{text-align:center}.canvas-wrapper h2{margin-bottom:15px;color:#333;font-size:1.3em}canvas{max-width:100%;height:auto;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}.info{margin-top:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;color:#1565c0}.github-link{margin-top:30px;text-align:center;padding:20px}.github-link a{display:inline-flex;align-items:center;gap:8px;color:#667eea;text-decoration:none;font-weight:600;font-size:1.1em;transition:color .3s}.github-link a:hover{color:#5568d3}.github-link a::before{content:'ðŸ”—';font-size:1.2em}@media (max-width:768px){.canvas-container{grid-template-columns:1fr}}</style></head><body><div class=container><h1>ðŸŽ¨ Pixel Mosaic</h1><div class=controls><div class=control-group><label for=imageInput>Upload Image</label> <input type=file id=imageInput accept=image/*></div><div class=control-group><label for=pixelSize>Pixel Size: <span id=pixelSizeValue>3</span></label> <input type=range id=pixelSize min=2 max=128 value=3> <input type=number id=pixelSizeNumber min=2 max=128 value=3></div><div class=control-group><label for=colorLimit>Color Limit: <span id=colorLimitValue>32</span></label> <input type=range id=colorLimit min=2 max=256 value=32> <input type=number id=colorLimitNumber min=2 max=256 value=32></div><div class=control-group><label><input type=checkbox id=useColorLimit checked=checked> Enable Color Limiting</label></div><div class=control-group><label><input type=checkbox id=useEdgeAware> Edge-Aware Pixelation</label><div id=gpuIndicator style=display:none;margin-top:4px;font-size:.85em;color:#666><span id=gpuStatus>Checking GPU...</span></div></div><div class=control-group id=optimizationIterationsGroup style=display:none><label for=optimizationIterations>Optimization Iterations: <span id=optimizationIterationsValue>2</span></label> <input type=range id=optimizationIterations min=1 max=10 value=2> <input type=number id=optimizationIterationsNumber min=1 max=10 value=2></div><div class=control-group id=edgeSharpnessGroup style=display:none><label for=edgeSharpness>Edge Sharpness: <span id=edgeSharpnessValue>0.8</span></label> <input type=range id=edgeSharpness min=0 max=1 step=0.1 value=0.8> <input type=number id=edgeSharpnessNumber min=0 max=1 step=0.1 value=0.8></div><div class=control-group id=contrastGroup><label for=contrast>Contrast: <span id=contrastValue>1.0</span></label> <input type=range id=contrast min=0.5 max=2 step=0.1 value=1.0> <input type=number id=contrastNumber min=0.5 max=2 step=0.1 value=1.0></div><div class=control-group><label><input type=checkbox id=useProjection> Apply Rotation (Projection)</label></div><div class=control-group><label for=rotationAngle>Rotation Angle: <span id=rotationAngleValue>0</span>Â°</label> <input type=range id=rotationAngle min=0 max=360 value=0> <input type=number id=rotationAngleNumber min=0 max=360 value=0></div><div class=control-group><button id=pixelateBtn disabled=disabled>Pixelate Image</button></div></div><div class=canvas-container><div class=canvas-wrapper><h2>Original Image</h2><canvas id=originalCanvas></canvas></div><div class=canvas-wrapper><h2>Pixelated Image</h2><canvas id=pixelatedCanvas></canvas></div><div class=canvas-wrapper><h2>With Projection</h2><canvas id=projectedCanvas></canvas></div></div><div class=info><strong>How to use:</strong> Upload an image, adjust the pixel size (up to 128) and color limit sliders, then click "Pixelate Image" to see the result. Enable "Edge-Aware Pixelation" for adaptive grid optimization - you can control how many optimization iterations the algorithm performs and adjust edge sharpness (0-1, default: 0.8 for strong edges). Enable "Apply Rotation" to see a projective transformation example.</div><div class=github-link><a href=https://github.com/yogthos/pixel-mosaic target=_blank rel="noopener noreferrer">View on GitHub</a></div></div><script type=module>function j(t,n,a,i){let u=new Float32Array(a*i);for(let l=1;l<i-1;l++)for(let m=1;m<a-1;m++){let r=l*a+m,d=t[r],x=n[r];if(d===0){u[r]=0;continue}let s=x;for(;s<0;)s+=2*Math.PI;for(;s>=2*Math.PI;)s-=2*Math.PI;let e,h;s>=0&&s<Math.PI/8||s>=15*Math.PI/8&&s<2*Math.PI||s>=7*Math.PI/8&&s<9*Math.PI/8?(e=t[r-1],h=t[r+1]):s>=Math.PI/8&&s<3*Math.PI/8||s>=9*Math.PI/8&&s<11*Math.PI/8?(e=t[(l-1)*a+(m+1)],h=t[(l+1)*a+(m-1)]):s>=3*Math.PI/8&&s<5*Math.PI/8||s>=11*Math.PI/8&&s<13*Math.PI/8?(e=t[(l-1)*a+m],h=t[(l+1)*a+m]):(e=t[(l-1)*a+(m-1)],h=t[(l+1)*a+(m+1)]),d>=e&&d>=h?u[r]=d:u[r]=0}return u}function W(t,n,a,i={}){let{threshold:u=.1,highThreshold:l=null,lowThreshold:m=null,usePercentile:r=!0,binarize:d=!0}=i,x=new Float32Array(t.length),s=u;if(r&&u>0){let e=[];for(let h=0;h<t.length;h++)t[h]>0&&e.push(t[h]);if(e.length>0){e.sort((o,c)=>o-c);let h=u,I=Math.ceil(e.length*h),g=Math.min(e.length-1,Math.max(0,I));s=e[g]}}if(l!==null&&m!==null&&l>m){let e=l,h=m;if(r){let o=[];for(let c=0;c<t.length;c++)t[c]>0&&o.push(t[c]);if(o.length>0){o.sort((v,b)=>v-b);let c=1-l,p=1-m,E=Math.floor(o.length*c),C=Math.floor(o.length*p);e=o[Math.max(0,E-1)]||0,h=o[Math.max(0,C-1)]||0}}let I=new Set,g=new Set;for(let o=0;o<t.length;o++)t[o]>=e?(I.add(o),x[o]=d?1:t[o]):(t[o]>=h&&g.add(o),x[o]=0);for(let o=0;o<t.length;o++)if(g.has(o)){let c=!1,p=o%n,E=Math.floor(o/n);for(let C=-1;C<=1&&!c;C++)for(let v=-1;v<=1&&!c;v++){if(v===0&&C===0)continue;let b=p+v,M=E+C;if(b>=0&&b<n&&M>=0&&M<a){let y=M*n+b;I.has(y)&&(c=!0)}}c&&(x[o]=d?1:t[o])}}else for(let e=0;e<t.length;e++)t[e]>=s?x[e]=d?1:t[e]:x[e]=0;return x}function J(t,n={}){let{applyNMS:a=!0,threshold:i=null,edgeSharpness:u=.8,highThreshold:l=null,lowThreshold:m=null}=n;i===null&&(i=.1+u*.5);let{data:r,width:d,height:x}=t,s=new Float32Array(d*x),e=new Float32Array(d*x),h=[-1,0,1,-2,0,2,-1,0,1],I=[-1,-2,-1,0,0,0,1,2,1];for(let c=1;c<x-1;c++)for(let p=1;p<d-1;p++){let E=0,C=0;for(let M=-1;M<=1;M++)for(let y=-1;y<=1;y++){let S=((c+M)*d+(p+y))*4,w=(r[S]+r[S+1]+r[S+2])/3,A=(M+1)*3+(y+1);E+=w*h[A],C+=w*I[A]}let v=Math.sqrt(E*E+C*C);s[c*d+p]=v;let b=Math.atan2(C,E)+Math.PI/2;e[c*d+p]=b}let g=0;for(let c=0;c<s.length;c++)s[c]>g&&(g=s[c]);if(g>0)for(let c=0;c<s.length;c++)s[c]/=g;let o=s;return a&&(o=j(s,e,d,x)),o=W(o,d,x,{threshold:i,highThreshold:l,lowThreshold:m}),o}function q(t,n,a,i,u,l=!1){if(i=Math.max(0,Math.min(n-1,i)),u=Math.max(0,Math.min(a-1,u)),!l){let M=Math.round(i),S=Math.round(u)*n+M;return t[S]||0}let m=Math.floor(i),r=Math.floor(u),d=Math.min(n-1,m+1),x=Math.min(a-1,r+1),s=i-m,e=u-r,h=r*n+m,I=x*n+m,g=r*n+d,o=x*n+d,c=t[h]||0,p=t[I]||0,E=t[g]||0,C=t[o]||0,v=c*(1-s)+E*s,b=p*(1-s)+C*s;return v*(1-e)+b*e}function bt(t){let n=t.getContext("webgl")||t.getContext("experimental-webgl");if(!n)return null;let a=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;

    void main() {
      gl_Position = vec4(a_position, 0.0, 1.0);
      v_texCoord = a_texCoord;
    }
  `,i=`
    precision mediump float;
    uniform sampler2D u_image;
    uniform vec2 u_textureSize;
    varying vec2 v_texCoord;

    void main() {
      vec2 onePixel = vec2(1.0) / u_textureSize;

      // Sample neighboring pixels for Sobel operator
      float tl = texture2D(u_image, v_texCoord + vec2(-onePixel.x, -onePixel.y)).r;
      float tm = texture2D(u_image, v_texCoord + vec2( 0.0, -onePixel.y)).r;
      float tr = texture2D(u_image, v_texCoord + vec2( onePixel.x, -onePixel.y)).r;
      float ml = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  0.0)).r;
      float mr = texture2D(u_image, v_texCoord + vec2( onePixel.x,  0.0)).r;
      float bl = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  onePixel.y)).r;
      float bm = texture2D(u_image, v_texCoord + vec2( 0.0,  onePixel.y)).r;
      float br = texture2D(u_image, v_texCoord + vec2( onePixel.x,  onePixel.y)).r;

      // Sobel X kernel: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
      float sobelX = -tl + tr - 2.0 * ml + 2.0 * mr - bl + br;

      // Sobel Y kernel: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
      float sobelY = -tl - 2.0 * tm - tr + bl + 2.0 * bm + br;

      // Calculate gradient magnitude
      float magnitude = sqrt(sobelX * sobelX + sobelY * sobelY);

      // Calculate edge direction (perpendicular to gradient)
      // atan2 returns [-\u03C0, \u03C0], we add \u03C0/2 and normalize to [0, 2\u03C0)
      float direction = atan(sobelY, sobelX) + 3.14159265359 / 2.0;
      if (direction < 0.0) direction += 2.0 * 3.14159265359;

      // Normalize direction to [0, 1] for storage in texture
      float directionNormalized = direction / (2.0 * 3.14159265359);

      // Output: R = magnitude, G = direction (normalized), B = unused, A = 1.0
      gl_FragColor = vec4(magnitude, directionNormalized, 0.0, 1.0);
    }
  `;function u(e,h,I){let g=e.createShader(h);return e.shaderSource(g,I),e.compileShader(g),e.getShaderParameter(g,e.COMPILE_STATUS)?g:(console.error("Shader compile error:",e.getShaderInfoLog(g)),e.deleteShader(g),null)}function l(e,h,I){let g=e.createProgram();return e.attachShader(g,h),e.attachShader(g,I),e.linkProgram(g),e.getProgramParameter(g,e.LINK_STATUS)?g:(console.error("Program link error:",e.getProgramInfoLog(g)),e.deleteProgram(g),null)}let m=u(n,n.VERTEX_SHADER,a),r=u(n,n.FRAGMENT_SHADER,i);if(!m||!r)return null;let d=l(n,m,r);if(!d)return null;let x=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,x),n.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n.STATIC_DRAW);let s=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,s),n.bufferData(n.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),n.STATIC_DRAW),{gl:n,program:d,positionBuffer:x,texCoordBuffer:s}}function yt(t,n){let{width:a,height:i,data:u}=n,l=new Uint8Array(a*i);for(let r=0;r<u.length;r+=4){let d=Math.round(.299*u[r]+.587*u[r+1]+.114*u[r+2]);l[r/4]=d}let m=t.createTexture();return t.bindTexture(t.TEXTURE_2D,m),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,a,i,0,t.LUMINANCE,t.UNSIGNED_BYTE,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),m}function tt(t,n={}){let{applyNMS:a=!0,threshold:i=null,edgeSharpness:u=.8,highThreshold:l=null,lowThreshold:m=null}=n;i===null&&(i=.1+u*.5);let{width:r,height:d}=t,x=document.createElement("canvas");x.width=r,x.height=d;let s=bt(x);if(!s)return null;let{gl:e,program:h,positionBuffer:I,texCoordBuffer:g}=s,o=yt(e,t);e.viewport(0,0,r,d),e.useProgram(h);let c=e.getAttribLocation(h,"a_position"),p=e.getAttribLocation(h,"a_texCoord");e.bindBuffer(e.ARRAY_BUFFER,I),e.enableVertexAttribArray(c),e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,g),e.enableVertexAttribArray(p),e.vertexAttribPointer(p,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(e.getUniformLocation(h,"u_image"),0),e.uniform2f(e.getUniformLocation(h,"u_textureSize"),r,d);let E=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,E);let C=e.createTexture();e.bindTexture(e.TEXTURE_2D,C),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,r,d,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,C,0),e.drawArrays(e.TRIANGLES,0,6);let v=new Uint8Array(r*d*4);e.readPixels(0,0,r,d,e.RGBA,e.UNSIGNED_BYTE,v);let b=new Float32Array(r*d),M=new Float32Array(r*d),y=0;for(let w=0;w<r*d;w++){let A=v[w*4];b[w]=A,A>y&&(y=A);let D=v[w*4+1]/255;M[w]=D*2*Math.PI}if(y>0)for(let w=0;w<b.length;w++)b[w]/=y;let S=b;return a&&(S=j(b,M,r,d)),S=W(S,r,d,{threshold:i,highThreshold:l,lowThreshold:m}),e.deleteTexture(o),e.deleteTexture(C),e.deleteFramebuffer(E),S}function H(t,n,a){let i=[[a[0],a[1]],[a[1],a[2]],[a[2],a[3]],[a[3],a[0]]],u=null;for(let[l,m]of i){let r=m.x-l.x,d=m.y-l.y,x=t-l.x,s=n-l.y,e=r*s-d*x;if(Math.abs(e)<1e-10)continue;let h=e>0?"left":"right";if(u===null)u=h;else if(u!==h)return!1}return!0}var O=class{constructor(n,a){this.x=n,this.y=a,this.originalX=n,this.originalY=a}reset(){this.x=this.originalX,this.y=this.originalY}},$=class{constructor(n){this.corners=n}getBounds(){let n=1/0,a=1/0,i=-1/0,u=-1/0;for(let l of this.corners)n=Math.min(n,l.x),a=Math.min(a,l.y),i=Math.max(i,l.x),u=Math.max(u,l.y);return{minX:n,minY:a,maxX:i,maxY:u}}getAverageColor(n){let{data:a,width:i}=n,u=this.getBounds(),l=Math.max(0,Math.floor(u.minX)),m=Math.max(0,Math.floor(u.minY)),r=Math.min(i-1,Math.floor(u.maxX)),d=Math.min(n.height-1,Math.floor(u.maxY)),x=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],s=Math.max(1,Math.floor(Math.min((r-l)/10,(d-m)/10,4))),e=0,h=0,I=0,g=0,o=0;for(let c=m;c<=d;c+=s)for(let p=l;p<=r;p+=s){let E=p+.5,C=c+.5;if(H(E,C,x)){let v=(c*i+p)*4;e+=a[v],h+=a[v+1],I+=a[v+2],g+=a[v+3],o++}}if(o===0)for(let c=m;c<=d;c++)for(let p=l;p<=r;p++){let E=(c*i+p)*4;e+=a[E],h+=a[E+1],I+=a[E+2],g+=a[E+3],o++}return o===0?{r:0,g:0,b:0,a:255}:{r:Math.round(e/o),g:Math.round(h/o),b:Math.round(I/o),a:Math.round(g/o)}}getBlendedColor(n,a){let{data:i,width:u}=n,l=this.getBounds(),m=Math.max(0,Math.floor(l.minX)),r=Math.max(0,Math.floor(l.minY)),d=Math.min(u-1,Math.floor(l.maxX)),x=Math.min(n.height-1,Math.floor(l.maxY)),s=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],e=Math.max(1,Math.floor(Math.min((d-m)/15,(x-r)/15,2))),h=[],I=0,g=0,o=0,c=0;for(let S=r;S<=x;S+=e)for(let w=m;w<=d;w+=e){let A=w+.5,D=S+.5;if(H(A,D,s)){let T=(S*u+w)*4,B=i[T],P=i[T+1],_=i[T+2],R=i[T+3];h.push({r:B,g:P,b:_,a:R}),I+=B,g+=P,o+=_,c+=R}}if(h.length===0)return this.getAverageColor(n);let p=h.length;I=Math.round(I/p),g=Math.round(g/p),o=Math.round(o/p),c=Math.round(c/p),h.sort((S,w)=>S.r+S.g+S.b-(w.r+w.g+w.b));let E=Math.floor(h.length/2),C=h[E].r,v=h[E].g,b=h[E].b,M=h[E].a,y=a;return{r:Math.round(I*(1-y)+C*y),g:Math.round(g*(1-y)+v*y),b:Math.round(o*(1-y)+b*y),a:Math.round(c*(1-y)+M*y)}}};function nt(t,n,a){let i=Math.ceil(t/a),u=Math.ceil(n/a),l=[],m=[];for(let r=0;r<=u;r++){let d=[];for(let x=0;x<=i;x++){let s=x*t/i,e=r*n/u;d.push(new O(s,e))}l.push(d)}for(let r=0;r<u;r++)for(let d=0;d<i;d++){let x=new $([l[r][d],l[r][d+1],l[r+1][d+1],l[r+1][d]]);m.push(x)}return{corners:l,cells:m,cols:i,rows:u}}function et(t,n,a,i,u,l,m){let r=l-i,d=m-u,x=Math.sqrt(r*r+d*d);if(x<1)return 0;let s=Math.max(3,Math.ceil(x*1.5)),e=0,h=0,I=0;for(let p=0;p<=s;p++){let E=p/s,C=i+r*E,v=u+d*E,b=Math.max(0,Math.min(n-1,C)),M=Math.max(0,Math.min(a-1,v));q(t,n,a,b,M,!1)>0?(e++,h++,I=Math.max(I,h)):h=0}let g=e/(s+1),o=I/(s+1),c=q(t,n,a,Math.max(0,Math.min(n-1,i)),Math.max(0,Math.min(a-1,u)),!1)>0?.2:0;return g*.4+o*.4+c}function ot(t,n,a,i,u={}){let{searchSteps:l=9,numIterations:m=2,stepSize:r=1,edgeSharpness:d=.8}=u,{corners:x,cells:s}=t,e=x.length,h=x[0].length,I=.3+d*.5,g=.2*(1-d*.5);for(let o=0;o<m;o++)for(let c=1;c<e-1;c++)for(let p=1;p<h-1;p++){let E=x[c][p],C=E.x,v=E.y,b=0,M=[];c>0&&M.push(x[c-1][p]),c<e-1&&M.push(x[c+1][p]),p>0&&M.push(x[c][p-1]),p<h-1&&M.push(x[c][p+1]);for(let B of M)b+=et(n,a,i,E.x,E.y,B.x,B.y);let y=Math.floor(Math.sqrt(l)),S=Math.floor(y/2);for(let B=-S;B<=S;B++)for(let P=-S;P<=S;P++){let _=E.x+P*r,R=E.y+B*r;if(_<0||_>=a||R<0||R>=i)continue;let F=0;for(let N of M)F+=et(n,a,i,_,R,N.x,N.y);F>b&&(b=F,C=_,v=R)}let w=o/Math.max(1,m-1),A=I+g*(1-w),D=C-E.x,T=v-E.y;E.x+=D*A,E.y+=T*A}return t}function at(t,n,a=null,i=.8){let{width:u,height:l}=n,m=new ImageData(u,l),r=m.data,d=[];for(let o=0;o<t.cells.length;o++)d.push(t.cells[o].getBlendedColor(n,i));let x=t.cells.map(o=>o.getBounds()),s=32,e=Math.ceil(u/s),h=Math.ceil(l/s),I=Array(h*e).fill(null).map(()=>[]);for(let o=0;o<t.cells.length;o++){let c=x[o],p=Math.max(0,Math.floor(c.minX/s)),E=Math.min(e-1,Math.floor(c.maxX/s)),C=Math.max(0,Math.floor(c.minY/s)),v=Math.min(h-1,Math.floor(c.maxY/s));for(let b=C;b<=v;b++)for(let M=p;M<=E;M++)I[b*e+M].push(o)}let g=t.cells.map(o=>[o.corners[0],o.corners[1],o.corners[2],o.corners[3]]);for(let o=0;o<l;o++)for(let c=0;c<u;c++){let p=o*u+c,E=c+.5,C=o+.5,v=Math.floor(c/s),M=Math.floor(o/s)*e+v,y=I[M]||[],S=!1,w=0;for(let T of y)if(H(E,C,g[T])){w=T,S=!0;break}if(!S){for(let T=0;T<t.cells.length;T++)if(H(E,C,g[T])){w=T,S=!0;break}}if(!S){let T=1/0;for(let B=0;B<t.cells.length;B++){let P=x[B],_=(P.minX+P.maxX)/2,R=(P.minY+P.maxY)/2,F=Math.sqrt(Math.pow(c-_,2)+Math.pow(o-R,2));F<T&&(T=F,w=B)}}let A=d[w],D=p*4;r[D]=A.r,r[D+1]=A.g,r[D+2]=A.b,r[D+3]=A.a}return m}function rt(t,n,a={}){let{returnCanvas:i=!1,colorLimit:u=null,contrast:l=1}=a,m,r;if(t instanceof ImageData)m=t.width,r=t.height;else if(t instanceof HTMLCanvasElement)m=t.width,r=t.height;else if(t instanceof HTMLImageElement)m=t.naturalWidth||t.width,r=t.naturalHeight||t.height;else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");let d=Math.max(1,Math.floor(m/n)),x=Math.max(1,Math.floor(r/n)),s=document.createElement("canvas");s.width=d,s.height=x;let e=s.getContext("2d");if(e.imageSmoothingEnabled=!1,t instanceof ImageData){let o=document.createElement("canvas");o.width=m,o.height=r,o.getContext("2d").putImageData(t,0,0),e.drawImage(o,0,0,d,x)}else e.drawImage(t,0,0,d,x);let h=e.getImageData(0,0,d,x);u&&u>0&&(h=st(h,u),e.putImageData(h,0,0));let I=document.createElement("canvas");I.width=m,I.height=r;let g=I.getContext("2d");if(g.imageSmoothingEnabled=!1,g.drawImage(s,0,0,m,r),l!==1){let o=g.getImageData(0,0,m,r);o=it(o,l),g.putImageData(o,0,0)}return i?I:g.getImageData(0,0,m,r)}function st(t,n){let a=new Uint8ClampedArray(t.data),i=t.width,u=t.height,l=Math.max(1,Math.floor(Math.sqrt(i*u)/100)),m=[];for(let s=0;s<a.length;s+=4*l){let e=a[s],h=a[s+1],I=a[s+2];m.push({r:e,g:h,b:I})}let r=[];if(m.length<=n){let s=new Map;for(let e of m){let h=`${e.r},${e.g},${e.b}`;if(!s.has(h)&&(s.set(h,e),s.size>=n))break}r.push(...Array.from(s.values()))}else{let s=new Map;for(let h of m){let I=`${h.r},${h.g},${h.b}`;s.set(I,(s.get(I)||0)+1)}let e=Array.from(s.entries()).sort((h,I)=>I[1]-h[1]).map(([h])=>{let[I,g,o]=h.split(",").map(Number);return{r:I,g,b:o}});for(r.push(e[0]);r.length<n&&r.length<e.length;){let h=-1,I=null;for(let g of e){if(r.some(c=>c.r===g.r&&c.g===g.g&&c.b===g.b))continue;let o=1/0;for(let c of r){let p=Math.sqrt(Math.pow(g.r-c.r,2)+Math.pow(g.g-c.g,2)+Math.pow(g.b-c.b,2));p<o&&(o=p)}o>h&&(h=o,I=g)}if(I)r.push(I);else{for(let g of e){if(r.length>=n)break;r.some(o=>o.r===g.r&&o.g===g.g&&o.b===g.b)||r.push(g)}break}}}r.length===0&&r.push({r:128,g:128,b:128});let d=new ImageData(i,u),x=d.data;for(let s=0;s<a.length;s+=4){let e=a[s],h=a[s+1],I=a[s+2],g=a[s+3],o=1/0,c=r[0];for(let p of r){let E=Math.sqrt(Math.pow(e-p.r,2)+Math.pow(h-p.g,2)+Math.pow(I-p.b,2));E<o&&(o=E,c=p)}x[s]=c.r,x[s+1]=c.g,x[s+2]=c.b,x[s+3]=g}return d}function it(t,n){let a=t.data,i=new ImageData(t.width,t.height),u=i.data;for(let l=0;l<a.length;l+=4)u[l]=Math.max(0,Math.min(255,Math.round((a[l]-128)*n+128))),u[l+1]=Math.max(0,Math.min(255,Math.round((a[l+1]-128)*n+128))),u[l+2]=Math.max(0,Math.min(255,Math.round((a[l+2]-128)*n+128))),u[l+3]=a[l+3];return i}async function lt(t,n,a={}){let{returnCanvas:i=!1,searchSteps:u=9,numIterations:l=2,onProgress:m=null,colorLimit:r=null,contrast:d=1,edgeSharpness:x=.8}=a,s,e,h;if(t instanceof ImageData)s=t.width,e=t.height,h=t;else{let M=document.createElement("canvas");if(t instanceof HTMLCanvasElement)M.width=t.width,M.height=t.height,M.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement)s=t.naturalWidth||t.width,e=t.naturalHeight||t.height,M.width=s,M.height=e,M.getContext("2d").drawImage(t,0,0);else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");h=M.getContext("2d").getImageData(0,0,M.width,M.height),s=M.width,e=M.height}let I={edgeSharpness:x},g=tt(h,I),o=!1;g?o=!0:g=J(h,I);let c=nt(s,e,n),p=.5+x*1.5,E=Math.max(1,n*.3*p),C=Math.max(u,Math.floor(9+x*16)),v=Math.max(l,Math.floor(2+x*3));ot(c,g,s,e,{searchSteps:C,numIterations:v,stepSize:E,edgeSharpness:x}),m&&m({usingGPU:o});let b=at(c,h,g,x);if(d!==1&&(b=it(b,d)),r&&r>0&&(b=st(b,r)),i){let M=document.createElement("canvas");return M.width=s,M.height=e,M.getContext("2d").putImageData(b,0,0),M._usingGPU=o,M}else return b}function ct(t){return new Promise((n,a)=>{let i=new Image;if(i.onload=()=>n(i),i.onerror=()=>a(new Error("Failed to load image")),t instanceof File){let u=new FileReader;u.onload=l=>{i.src=l.target.result},u.onerror=()=>a(new Error("Failed to read file")),u.readAsDataURL(t)}else i.src=t})}function dt(t,n,a={}){let{interpolation:i="nearest",fillMode:u="constant",fillValue:l=0,returnCanvas:m=!1}=a;if(n.length!==8)throw new Error("Transform matrix must have 8 elements [a1, a2, a3, b1, b2, b3, c1, c2]");let[r,d,x,s,e,h,I,g]=n,o,c,p;if(t instanceof ImageData)o=t.width,c=t.height,p=t.data;else{let M=document.createElement("canvas");if(t instanceof HTMLCanvasElement)M.width=t.width,M.height=t.height,M.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement)M.width=t.naturalWidth||t.width,M.height=t.naturalHeight||t.height,M.getContext("2d").drawImage(t,0,0);else throw new Error("Unsupported image type");o=M.width,c=M.height,p=M.getContext("2d").getImageData(0,0,o,c).data}let E=document.createElement("canvas");E.width=o,E.height=c;let C=E.getContext("2d"),v=C.createImageData(o,c),b=v.data;for(let M=0;M<c;M++)for(let y=0;y<o;y++){let S=y,w=M,A=I*S+g*w+1;if(Math.abs(A)<1e-4){let L=(M*o+y)*4;b[L]=l,b[L+1]=l,b[L+2]=l,b[L+3]=255;continue}let D=(r*S+d*w+x)/A,T=(s*S+e*w+h)/A,B=ut(D,o,u),P=ut(T,c,u),_,R,F,N;if(i==="nearest"){let L=Math.round(B),Y=Math.round(P),U=z(p,L,Y,o,c,l);_=U.r,R=U.g,F=U.b,N=U.a}else{let L=Math.floor(B),Y=Math.floor(P),U=L+1,K=Y+1,ft=z(p,L,Y,o,c,l),xt=z(p,U,Y,o,c,l),gt=z(p,L,K,o,c,l),pt=z(p,U,K,o,c,l),Q=B-L,Mt=P-Y,It=Z(ft,xt,Q),Et=Z(gt,pt,Q),V=Z(It,Et,Mt);_=V.r,R=V.g,F=V.b,N=V.a}let G=(M*o+y)*4;b[G]=_,b[G+1]=R,b[G+2]=F,b[G+3]=N}return C.putImageData(v,0,0),m?E:v}function ut(t,n,a){if(a==="constant")return t;if(a==="reflect"){if(t<0){if(n<=1)return 0;let i=2*n;t<-i&&(t=t+i*Math.floor(-t/i)),t=t<-n?t+i:-t-1}else if(t>n-1){if(n<=1)return 0;let i=2*n;t=t-i*Math.floor(t/i),t>=n&&(t=i-t-1)}return Math.max(0,Math.min(n-1,t))}else if(a==="wrap"){if(t<0){if(n<=1)return 0;let i=n-1;t=t+n*(Math.floor(-t/i)+1)}else if(t>n-1){if(n<=1)return 0;let i=n-1;t=t-n*Math.floor(t/i)}return Math.max(0,Math.min(n-1,t))}else if(a==="nearest")return Math.max(0,Math.min(n-1,t));return t}function z(t,n,a,i,u,l){if(n>=0&&n<i&&a>=0&&a<u){let m=(a*i+n)*4;return{r:t[m],g:t[m+1],b:t[m+2],a:t[m+3]}}else return{r:l,g:l,b:l,a:255}}function Z(t,n,a){return{r:Math.round(t.r+(n.r-t.r)*a),g:Math.round(t.g+(n.g-t.g)*a),b:Math.round(t.b+(n.b-t.b)*a),a:Math.round(t.a+(n.a-t.a)*a)}}function ht(t,n,a){let i=Math.cos(t),u=Math.sin(t),l=n-n*i+a*u,m=a-n*u-a*i;return[i,-u,l,u,i,m,0,0]}var f={imageInput:document.getElementById("imageInput"),pixelSizeSlider:document.getElementById("pixelSize"),pixelSizeNumber:document.getElementById("pixelSizeNumber"),pixelSizeValue:document.getElementById("pixelSizeValue"),colorLimitSlider:document.getElementById("colorLimit"),colorLimitNumber:document.getElementById("colorLimitNumber"),colorLimitValue:document.getElementById("colorLimitValue"),useColorLimit:document.getElementById("useColorLimit"),useEdgeAware:document.getElementById("useEdgeAware"),gpuIndicator:document.getElementById("gpuIndicator"),gpuStatus:document.getElementById("gpuStatus"),optimizationIterationsGroup:document.getElementById("optimizationIterationsGroup"),optimizationIterationsSlider:document.getElementById("optimizationIterations"),optimizationIterationsNumber:document.getElementById("optimizationIterationsNumber"),optimizationIterationsValue:document.getElementById("optimizationIterationsValue"),edgeSharpnessGroup:document.getElementById("edgeSharpnessGroup"),edgeSharpnessSlider:document.getElementById("edgeSharpness"),edgeSharpnessNumber:document.getElementById("edgeSharpnessNumber"),edgeSharpnessValue:document.getElementById("edgeSharpnessValue"),contrastGroup:document.getElementById("contrastGroup"),contrastSlider:document.getElementById("contrast"),contrastNumber:document.getElementById("contrastNumber"),contrastValue:document.getElementById("contrastValue"),useProjection:document.getElementById("useProjection"),rotationAngleSlider:document.getElementById("rotationAngle"),rotationAngleNumber:document.getElementById("rotationAngleNumber"),rotationAngleValue:document.getElementById("rotationAngleValue"),pixelateBtn:document.getElementById("pixelateBtn"),originalCanvas:document.getElementById("originalCanvas"),pixelatedCanvas:document.getElementById("pixelatedCanvas"),projectedCanvas:document.getElementById("projectedCanvas")},Ct=f.originalCanvas.getContext("2d"),vt=f.pixelatedCanvas.getContext("2d"),St=f.projectedCanvas.getContext("2d"),X=null;function k(t,n,a,i,u,l){let m=()=>{let d=t.value;n.value=d,a.textContent=d},r=d=>{let x=Math.max(i,Math.min(u,parseInt(d.target.value)||l));t.value=x,n.value=x,a.textContent=x};t.addEventListener("input",m),n.addEventListener("input",r),m()}k(f.pixelSizeSlider,f.pixelSizeNumber,f.pixelSizeValue,2,128,3);k(f.colorLimitSlider,f.colorLimitNumber,f.colorLimitValue,2,256,32);k(f.optimizationIterationsSlider,f.optimizationIterationsNumber,f.optimizationIterationsValue,1,10,2);function wt(t,n,a,i,u,l,m=.1){let r=()=>{let x=parseFloat(t.value);n.value=x.toFixed(1),a.textContent=x.toFixed(1)},d=x=>{let s=Math.max(i,Math.min(u,parseFloat(x.target.value)||l));t.value=s,n.value=s.toFixed(1),a.textContent=s.toFixed(1)};t.addEventListener("input",r),n.addEventListener("input",d),r()}wt(f.edgeSharpnessSlider,f.edgeSharpnessNumber,f.edgeSharpnessValue,0,1,.8,.1);k(f.contrastSlider,f.contrastNumber,f.contrastValue,.5,2,1);k(f.rotationAngleSlider,f.rotationAngleNumber,f.rotationAngleValue,0,360,0);function mt(){let t=f.useEdgeAware.checked;f.optimizationIterationsGroup.style.display=t?"block":"none",f.edgeSharpnessGroup.style.display=t?"block":"none",f.gpuIndicator.style.display=t?"block":"none",t||(f.gpuStatus.textContent="")}mt();f.useEdgeAware.addEventListener("change",mt);f.imageInput.addEventListener("change",async t=>{let n=t.target.files[0];if(!n){f.pixelateBtn.disabled=!0;return}try{f.pixelateBtn.disabled=!0,f.pixelateBtn.textContent="Loading...";let a=await ct(n);X=a,f.originalCanvas.width=a.width,f.originalCanvas.height=a.height,Ct.drawImage(a,0,0),f.pixelateBtn.disabled=!1,f.pixelateBtn.textContent="Pixelate Image"}catch(a){alert("Failed to load image: "+a.message),f.pixelateBtn.disabled=!0,f.pixelateBtn.textContent="Pixelate Image"}});f.pixelateBtn.addEventListener("click",async()=>{if(f.pixelateBtn.disabled)return;if(f.pixelateBtn.disabled=!0,!X){alert("Please upload an image first."),f.pixelateBtn.disabled=!1;return}let t=parseInt(f.pixelSizeSlider.value),n=f.useColorLimit.checked?parseInt(f.colorLimitSlider.value):null,a=f.useEdgeAware.checked;try{f.pixelateBtn.textContent=a?"Processing (Edge-Aware)...":"Processing...",await new Promise(u=>setTimeout(u,0));let i;if(a){let u=parseInt(f.optimizationIterationsSlider.value),l=parseFloat(f.contrastSlider.value),m=parseFloat(f.edgeSharpnessSlider.value);f.gpuStatus.textContent="Processing...",i=await lt(X,t,{returnCanvas:!0,searchSteps:9,numIterations:u,colorLimit:n,contrast:l,edgeSharpness:m,onProgress:r=>{r.usingGPU?(f.gpuStatus.textContent="\u2713 Using GPU acceleration",f.gpuStatus.style.color="#4caf50"):(f.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",f.gpuStatus.style.color="#ff9800")}}),i._usingGPU!==void 0&&(i._usingGPU?(f.gpuStatus.textContent="\u2713 Using GPU acceleration",f.gpuStatus.style.color="#4caf50"):(f.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",f.gpuStatus.style.color="#ff9800"))}else{let u=parseFloat(f.contrastSlider.value);await new Promise(l=>requestAnimationFrame(l)),i=rt(X,t,{returnCanvas:!0,colorLimit:n,contrast:u})}if(f.pixelatedCanvas.width=i.width,f.pixelatedCanvas.height=i.height,vt.drawImage(i,0,0),f.useProjection.checked){let u=parseFloat(f.rotationAngleSlider.value)*Math.PI/180,l=i.width/2,m=i.height/2,r=ht(u,l,m),d=dt(i,r,{returnCanvas:!0,interpolation:"nearest"});f.projectedCanvas.width=d.width,f.projectedCanvas.height=d.height,St.drawImage(d,0,0)}else f.projectedCanvas.width=0,f.projectedCanvas.height=0;f.pixelateBtn.disabled=!1,f.pixelateBtn.textContent="Pixelate Image"}catch(i){alert("Failed to pixelate image: "+i.message),f.pixelateBtn.disabled=!1,f.pixelateBtn.textContent="Pixelate Image"}});f.rotationAngleSlider.addEventListener("input",()=>{f.useProjection.checked&&X&&!f.pixelateBtn.disabled&&f.pixelateBtn.click()});f.rotationAngleNumber.addEventListener("input",()=>{f.useProjection.checked&&X&&!f.pixelateBtn.disabled&&f.pixelateBtn.click()});f.useProjection.addEventListener("change",()=>{X&&f.pixelatedCanvas.width>0&&!f.pixelateBtn.disabled&&f.pixelateBtn.click()});</script></body></html>