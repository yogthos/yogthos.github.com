<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pixel Mosaic - Demo</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:30px}.control-section{background:#f8f9fa;border-radius:6px;padding:12px;border:1px solid #e9ecef}.control-section-title{font-size:.8em;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #dee2e6}.control-section-grid{display:grid;grid-template-columns:1fr;gap:12px}.control-group{display:flex;flex-direction:column;gap:6px;min-height:50px;transition:opacity .2s ease}.control-group[style*="display: none"]{min-height:0;opacity:0}label{font-weight:600;color:#555;font-size:.85em}input[type=checkbox]{margin-right:8px;cursor:pointer;width:18px;height:18px;accent-color:#667eea}label:has(input[type=checkbox]){display:flex;align-items:center;cursor:pointer;user-select:none}input[type=range]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:0;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;transition:background .2s}input[type=range]::-webkit-slider-thumb:hover{background:#5568d3}input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;border:none;transition:background .2s}input[type=range]::-moz-range-thumb:hover{background:#5568d3}input[type=number]{width:70px;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:.85em}input[type=number]:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.1)}input[type=file]{padding:10px;border:2px dashed #667eea;border-radius:4px;cursor:pointer;background:#fff;transition:all .2s}input[type=file]:hover{border-color:#5568d3;background:#f8f9ff}button{padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:6px;font-size:.9em;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 4px rgba(102,126,234,.2)}button:hover:not(:disabled){background:#5568d3;box-shadow:0 4px 8px rgba(102,126,234,.3);transform:translateY(-1px)}button:active:not(:disabled){transform:translateY(0);box-shadow:0 2px 4px rgba(102,126,234,.2)}button:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;transform:none}.canvas-container{display:flex;flex-direction:column;align-items:center;margin-top:20px;margin-bottom:20px}.canvas-wrapper{text-align:center;width:100%}.canvas-wrapper h2{margin-bottom:12px;color:#333;font-size:1.1em}canvas{max-width:100%;height:auto;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}.info{margin-top:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;color:#1565c0}.step-navigation{display:none;justify-content:center;align-items:center;gap:15px;margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px}.step-navigation.active{display:flex}.step-navigation button{padding:8px 16px;font-size:.9em;min-width:90px}.step-label{font-weight:600;color:#333;font-size:1em;min-width:180px;text-align:center}.step-counter{color:#666;font-size:.85em}.github-link{margin-top:30px;text-align:center;padding:20px}.github-link a{display:inline-flex;align-items:center;gap:8px;color:#667eea;text-decoration:none;font-weight:600;font-size:1.1em;transition:color .3s}.github-link a:hover{color:#5568d3}.github-link a::before{content:'üîó';font-size:1.2em}</style></head><body><div class=container><h1>üé® Pixel Mosaic</h1><div class=control-section style="max-width:400px;margin:0 auto 20px"><div class=control-section-title>üì§ Image Upload</div><div class=control-section-grid><div class=control-group><label for=imageInput>Upload Image</label> <input type=file id=imageInput accept=image/*></div></div></div><div class=canvas-container><div class=canvas-wrapper><h2 id=canvasTitle>Upload an image to begin</h2><canvas id=mainCanvas></canvas><div style=margin-top:15px><button id=pixelateBtn disabled=disabled>Pixelate Image</button></div><div class=step-navigation id=stepNavigation><button id=stepPrev>‚Üê Previous</button><div><div class=step-label id=stepLabel>Original</div><div class=step-counter id=stepCounter></div></div><button id=stepNext>Next ‚Üí</button></div></div></div><div class=controls><div class=control-section><div class=control-section-title>üé® Pixelation</div><div class=control-section-grid><div class=control-group><label for=pixelSize>Pixel Size: <span id=pixelSizeValue>3</span></label> <input type=range id=pixelSize min=2 max=128 value=3> <input type=number id=pixelSizeNumber min=2 max=128 value=3></div><div class=control-group><label for=contrast>Contrast: <span id=contrastValue>1.0</span></label> <input type=range id=contrast min=0.5 max=2 step=0.1 value=1.0> <input type=number id=contrastNumber min=0.5 max=2 step=0.1 value=1.0></div><div class=control-group><label><input type=checkbox id=useColorLimit checked=checked> Enable Color Limiting</label></div><div class=control-group id=colorLimitGroup><label for=colorLimit>Color Limit: <span id=colorLimitValue>32</span></label> <input type=range id=colorLimit min=2 max=256 value=32> <input type=number id=colorLimitNumber min=2 max=256 value=32></div></div></div><div class=control-section><div class=control-section-title>üîç Edge-Aware</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useEdgeAware> Enable Edge-Aware</label><div id=gpuIndicator style=display:none;margin-top:4px;font-size:.75em;color:#666><span id=gpuStatus>Checking GPU...</span></div></div><div class=control-group id=edgeSharpnessGroup style=display:none><label for=edgeSharpness>Edge Sharpness: <span id=edgeSharpnessValue>0.8</span></label> <input type=range id=edgeSharpness min=0 max=1 step=0.1 value=0.8> <input type=number id=edgeSharpnessNumber min=0 max=1 step=0.1 value=0.8></div><div class=control-group id=showStepsGroup style=display:none><label><input type=checkbox id=showAlgorithmSteps> Show Algorithm Steps</label></div></div></div><div class=control-section><div class=control-section-title>üîÑ Transform</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useProjection> Apply Rotation</label></div><div class=control-group id=rotationGroup style=display:none><label for=rotationAngle>Rotation: <span id=rotationAngleValue>0</span>¬∞</label> <input type=range id=rotationAngle min=0 max=360 value=0> <input type=number id=rotationAngleNumber min=0 max=360 value=0></div></div></div></div><div class=info><strong>How to use:</strong> Upload an image, adjust the pixel size and color limit, then click "Pixelate Image". Enable "Edge-Aware Pixelation" for adaptive grid optimization with adjustable edge sharpness. Check "Show Algorithm Steps" to visualize the edge detection process.</div><div class=github-link><a href=https://github.com/yogthos/pixel-mosaic target=_blank rel="noopener noreferrer">View on GitHub</a></div></div><script type=module>function rt(t,e,o,a){let c=new Float32Array(o*a);for(let r=1;r<a-1;r++)for(let s=1;s<o-1;s++){let i=r*o+s,u=t[i],l=e[i];if(u===0){c[i]=0;continue}let d=l;for(;d<0;)d+=2*Math.PI;for(;d>=2*Math.PI;)d-=2*Math.PI;let n,h;d>=0&&d<Math.PI/8||d>=15*Math.PI/8&&d<2*Math.PI||d>=7*Math.PI/8&&d<9*Math.PI/8?(n=t[i-1],h=t[i+1]):d>=Math.PI/8&&d<3*Math.PI/8||d>=9*Math.PI/8&&d<11*Math.PI/8?(n=t[(r-1)*o+(s+1)],h=t[(r+1)*o+(s-1)]):d>=3*Math.PI/8&&d<5*Math.PI/8||d>=11*Math.PI/8&&d<13*Math.PI/8?(n=t[(r-1)*o+s],h=t[(r+1)*o+s]):(n=t[(r-1)*o+(s-1)],h=t[(r+1)*o+(s+1)]),u>=n&&u>=h?c[i]=u:c[i]=0}return c}function st(t,e,o,a={}){let{threshold:c=.1,highThreshold:r=null,lowThreshold:s=null,usePercentile:i=!0,binarize:u=!0}=a,l=new Float32Array(t.length),d=c;if(i&&c>0){let n=[];for(let h=0;h<t.length;h++)t[h]>0&&n.push(t[h]);if(n.length>0){n.sort((p,f)=>p-f);let h=c,x=Math.ceil(n.length*h),m=Math.min(n.length-1,Math.max(0,x));d=n[m]}}if(r!==null&&s!==null&&r>s){let n=r,h=s;if(i){let p=[];for(let f=0;f<t.length;f++)t[f]>0&&p.push(t[f]);if(p.length>0){p.sort((E,C)=>E-C);let f=1-r,M=1-s,v=Math.floor(p.length*f),y=Math.floor(p.length*M);n=p[Math.max(0,v-1)]||0,h=p[Math.max(0,y-1)]||0}}let x=new Set,m=new Set;for(let p=0;p<t.length;p++)t[p]>=n?(x.add(p),l[p]=u?1:t[p]):(t[p]>=h&&m.add(p),l[p]=0);for(let p=0;p<t.length;p++)if(m.has(p)){let f=!1,M=p%e,v=Math.floor(p/e);for(let y=-1;y<=1&&!f;y++)for(let E=-1;E<=1&&!f;E++){if(E===0&&y===0)continue;let C=M+E,I=v+y;if(C>=0&&C<e&&I>=0&&I<o){let b=I*e+C;x.has(b)&&(f=!0)}}f&&(l[p]=u?1:t[p])}}else for(let n=0;n<t.length;n++)t[n]>=d?l[n]=u?1:t[n]:l[n]=0;return l}function et(t,e={}){let{applyNMS:o=!0,threshold:a=null,edgeSharpness:c=.8,highThreshold:r=null,lowThreshold:s=null,captureIntermediates:i=!1}=e;a===null&&(a=.1+c*.5);let{data:u,width:l,height:d}=t,n=new Float32Array(l*d),h=new Float32Array(l*d),x=null;i&&(x=new Float32Array(l*d));let m=[-1,0,1,-2,0,2,-1,0,1],p=[-1,-2,-1,0,0,0,1,2,1];for(let E=1;E<d-1;E++)for(let C=1;C<l-1;C++){let I=0,b=0;for(let A=-1;A<=1;A++)for(let X=-1;X<=1;X++){let N=((E+A)*l+(C+X))*4,B=(u[N]+u[N+1]+u[N+2])/3,R=(A+1)*3+(X+1);I+=B*m[R],b+=B*p[R],i&&A===0&&X===0&&(x[E*l+C]=B/255)}let S=Math.sqrt(I*I+b*b);n[E*l+C]=S;let P=Math.atan2(b,I)+Math.PI/2;h[E*l+C]=P}if(i){for(let E=0;E<d;E++)for(let C=0;C<l;C++)if(E===0||E===d-1||C===0||C===l-1){let I=(E*l+C)*4,b=(u[I]+u[I+1]+u[I+2])/3;x[E*l+C]=b/255}}let f=0;for(let E=0;E<n.length;E++)n[E]>f&&(f=n[E]);if(f>0)for(let E=0;E<n.length;E++)n[E]/=f;let M=null;i&&(M=new Float32Array(n));let v=n,y=null;return o&&(v=rt(n,h,l,d),i&&(y=new Float32Array(v))),v=st(v,l,d,{threshold:a,highThreshold:r,lowThreshold:s}),i?{edgeMap:v,intermediates:{grayscale:x,magnitude:M,afterNMS:y||M,afterThreshold:v},width:l,height:d}:v}function it(t,e,o,a,c,r=!1){if(a=Math.max(0,Math.min(e-1,a)),c=Math.max(0,Math.min(o-1,c)),!r){let I=Math.round(a),S=Math.round(c)*e+I;return t[S]||0}let s=Math.floor(a),i=Math.floor(c),u=Math.min(e-1,s+1),l=Math.min(o-1,i+1),d=a-s,n=c-i,h=i*e+s,x=l*e+s,m=i*e+u,p=l*e+u,f=t[h]||0,M=t[x]||0,v=t[m]||0,y=t[p]||0,E=f*(1-d)+v*d,C=M*(1-d)+y*d;return E*(1-n)+C*n}function zt(t){let e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return null;let o=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;

    void main() {
      gl_Position = vec4(a_position, 0.0, 1.0);
      v_texCoord = a_texCoord;
    }
  `,a=`
    precision mediump float;
    uniform sampler2D u_image;
    uniform vec2 u_textureSize;
    varying vec2 v_texCoord;

    void main() {
      vec2 onePixel = vec2(1.0) / u_textureSize;

      // Sample neighboring pixels for Sobel operator
      float tl = texture2D(u_image, v_texCoord + vec2(-onePixel.x, -onePixel.y)).r;
      float tm = texture2D(u_image, v_texCoord + vec2( 0.0, -onePixel.y)).r;
      float tr = texture2D(u_image, v_texCoord + vec2( onePixel.x, -onePixel.y)).r;
      float ml = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  0.0)).r;
      float mr = texture2D(u_image, v_texCoord + vec2( onePixel.x,  0.0)).r;
      float bl = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  onePixel.y)).r;
      float bm = texture2D(u_image, v_texCoord + vec2( 0.0,  onePixel.y)).r;
      float br = texture2D(u_image, v_texCoord + vec2( onePixel.x,  onePixel.y)).r;

      // Sobel X kernel: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
      float sobelX = -tl + tr - 2.0 * ml + 2.0 * mr - bl + br;

      // Sobel Y kernel: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
      float sobelY = -tl - 2.0 * tm - tr + bl + 2.0 * bm + br;

      // Calculate gradient magnitude
      float magnitude = sqrt(sobelX * sobelX + sobelY * sobelY);

      // Normalize magnitude to [0, 1] range
      // Max theoretical magnitude for normalized [0,1] input with Sobel is ~5.66
      // Use 6.0 as divisor to ensure we stay in [0, 1] range
      float magnitudeNormalized = magnitude / 6.0;

      // Calculate edge direction (perpendicular to gradient)
      // atan2 returns [-\u03C0, \u03C0], we add \u03C0/2 and normalize to [0, 2\u03C0)
      float direction = atan(sobelY, sobelX) + 3.14159265359 / 2.0;
      if (direction < 0.0) direction += 2.0 * 3.14159265359;

      // Normalize direction to [0, 1] for storage in texture
      float directionNormalized = direction / (2.0 * 3.14159265359);

      // Output: R = magnitude (normalized), G = direction (normalized), B = unused, A = 1.0
      gl_FragColor = vec4(magnitudeNormalized, directionNormalized, 0.0, 1.0);
    }
  `;function c(n,h,x){let m=n.createShader(h);return n.shaderSource(m,x),n.compileShader(m),n.getShaderParameter(m,n.COMPILE_STATUS)?m:(console.error("Shader compile error:",n.getShaderInfoLog(m)),n.deleteShader(m),null)}function r(n,h,x){let m=n.createProgram();return n.attachShader(m,h),n.attachShader(m,x),n.linkProgram(m),n.getProgramParameter(m,n.LINK_STATUS)?m:(console.error("Program link error:",n.getProgramInfoLog(m)),n.deleteProgram(m),null)}let s=c(e,e.VERTEX_SHADER,o),i=c(e,e.FRAGMENT_SHADER,a);if(!s||!i)return null;let u=r(e,s,i);if(!u)return null;let l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);let d=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),{gl:e,program:u,positionBuffer:l,texCoordBuffer:d}}function Nt(t,e){let{width:o,height:a,data:c}=e,r=new Uint8Array(o*a);for(let i=0;i<c.length;i+=4){let u=Math.round(.299*c[i]+.587*c[i+1]+.114*c[i+2]);r[i/4]=u}let s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,o,a,0,t.LUMINANCE,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),s}function pt(t,e={}){let{applyNMS:o=!0,threshold:a=null,edgeSharpness:c=.8,highThreshold:r=null,lowThreshold:s=null}=e;a===null&&(a=.02+c*.18);let{width:i,height:u}=t,l=document.createElement("canvas");l.width=i,l.height=u;let d=zt(l);if(!d)return console.warn("WebGL not available, falling back to CPU"),null;let{gl:n,program:h,positionBuffer:x,texCoordBuffer:m}=d,p=Nt(n,t);n.viewport(0,0,i,u),n.useProgram(h);let f=n.getAttribLocation(h,"a_position"),M=n.getAttribLocation(h,"a_texCoord");n.bindBuffer(n.ARRAY_BUFFER,x),n.enableVertexAttribArray(f),n.vertexAttribPointer(f,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,m),n.enableVertexAttribArray(M),n.vertexAttribPointer(M,2,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,p),n.uniform1i(n.getUniformLocation(h,"u_image"),0),n.uniform2f(n.getUniformLocation(h,"u_textureSize"),i,u);let v=n.createTexture();n.bindTexture(n.TEXTURE_2D,v),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,u,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);let y=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,y),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,v,0);let E=n.checkFramebufferStatus(n.FRAMEBUFFER);if(E!==n.FRAMEBUFFER_COMPLETE)return console.error("WebGL framebuffer incomplete:",E),n.deleteTexture(p),n.deleteTexture(v),n.deleteFramebuffer(y),null;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,p),n.drawArrays(n.TRIANGLES,0,6);let C=n.getError();if(C!==n.NO_ERROR)return console.error("WebGL error during rendering:",C),n.deleteTexture(p),n.deleteTexture(v),n.deleteFramebuffer(y),null;let I=new Uint8Array(i*u*4);n.readPixels(0,0,i,u,n.RGBA,n.UNSIGNED_BYTE,I);let b=new Float32Array(i*u),S=new Float32Array(i*u);for(let A=0;A<i*u;A++){b[A]=I[A*4]/255;let X=I[A*4+1]/255;S[A]=X*2*Math.PI}let P=b;return o&&(P=rt(b,S,i,u)),P=st(P,i,u,{threshold:a,highThreshold:r,lowThreshold:s}),n.deleteTexture(p),n.deleteTexture(v),n.deleteFramebuffer(y),P}function xt(t,e,o){let a=[[o[0],o[1]],[o[1],o[2]],[o[2],o[3]],[o[3],o[0]]],c=null;for(let[r,s]of a){let i=s.x-r.x,u=s.y-r.y,l=t-r.x,d=e-r.y,n=i*d-u*l;if(Math.abs(n)<1e-10)continue;let h=n>0?"left":"right";if(c===null)c=h;else if(c!==h)return!1}return!0}var lt=class{constructor(e,o){this.x=e,this.y=o,this.originalX=e,this.originalY=o}reset(){this.x=this.originalX,this.y=this.originalY}},ct=class{constructor(e){this.corners=e}getBounds(){let e=1/0,o=1/0,a=-1/0,c=-1/0;for(let r of this.corners)e=Math.min(e,r.x),o=Math.min(o,r.y),a=Math.max(a,r.x),c=Math.max(c,r.y);return{minX:e,minY:o,maxX:a,maxY:c}}getAverageColor(e){let{data:o,width:a}=e,c=this.getBounds(),r=Math.max(0,Math.floor(c.minX)),s=Math.max(0,Math.floor(c.minY)),i=Math.min(a-1,Math.floor(c.maxX)),u=Math.min(e.height-1,Math.floor(c.maxY)),l=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],d=Math.max(1,Math.floor(Math.min((i-r)/10,(u-s)/10,4))),n=0,h=0,x=0,m=0,p=0;for(let f=s;f<=u;f+=d)for(let M=r;M<=i;M+=d){let v=M+.5,y=f+.5;if(xt(v,y,l)){let E=(f*a+M)*4;n+=o[E],h+=o[E+1],x+=o[E+2],m+=o[E+3],p++}}if(p===0)for(let f=s;f<=u;f++)for(let M=r;M<=i;M++){let v=(f*a+M)*4;n+=o[v],h+=o[v+1],x+=o[v+2],m+=o[v+3],p++}return p===0?{r:0,g:0,b:0,a:255}:{r:Math.round(n/p),g:Math.round(h/p),b:Math.round(x/p),a:Math.round(m/p)}}getBlendedColor(e,o){let{data:a,width:c}=e,r=this.getBounds(),s=Math.max(0,Math.floor(r.minX)),i=Math.max(0,Math.floor(r.minY)),u=Math.min(c-1,Math.floor(r.maxX)),l=Math.min(e.height-1,Math.floor(r.maxY)),d=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],n=Math.max(1,Math.floor(Math.min((u-s)/15,(l-i)/15,2))),h=[],x=0,m=0,p=0,f=0;for(let S=i;S<=l;S+=n)for(let P=s;P<=u;P+=n){let A=P+.5,X=S+.5;if(xt(A,X,d)){let N=(S*c+P)*4,B=a[N],R=a[N+1],L=a[N+2],w=a[N+3];h.push({r:B,g:R,b:L,a:w}),x+=B,m+=R,p+=L,f+=w}}if(h.length===0)return this.getAverageColor(e);let M=h.length;x=Math.round(x/M),m=Math.round(m/M),p=Math.round(p/M),f=Math.round(f/M),h.sort((S,P)=>S.r+S.g+S.b-(P.r+P.g+P.b));let v=Math.floor(h.length/2),y=h[v].r,E=h[v].g,C=h[v].b,I=h[v].a,b=o;return{r:Math.round(x*(1-b)+y*b),g:Math.round(m*(1-b)+E*b),b:Math.round(p*(1-b)+C*b),a:Math.round(f*(1-b)+I*b)}}};function Et(t,e,o){let a=Math.ceil(t/o),c=Math.ceil(e/o),r=[],s=[];for(let i=0;i<=c;i++){let u=[];for(let l=0;l<=a;l++){let d=l*t/a,n=i*e/c;u.push(new lt(d,n))}r.push(u)}for(let i=0;i<c;i++)for(let u=0;u<a;u++){let l=new ct([r[i][u],r[i][u+1],r[i+1][u+1],r[i+1][u]]);s.push(l)}return{corners:r,cells:s,cols:a,rows:c}}function vt(t,e,o,a,c,r,s){let i=r-a,u=s-c,l=Math.sqrt(i*i+u*u);if(l<1)return 0;let d=Math.max(3,Math.ceil(l*1.5)),n=0,h=0,x=0;for(let M=0;M<=d;M++){let v=M/d,y=a+i*v,E=c+u*v,C=Math.max(0,Math.min(e-1,y)),I=Math.max(0,Math.min(o-1,E));it(t,e,o,C,I,!1)>0?(n++,h++,x=Math.max(x,h)):h=0}let m=n/(d+1),p=x/(d+1),f=it(t,e,o,Math.max(0,Math.min(e-1,a)),Math.max(0,Math.min(o-1,c)),!1)>0?.2:0;return m*.4+p*.4+f}function Mt(t,e,o,a,c,r=3){let s=0,i=0;for(let u=-r;u<=r;u++)for(let l=-r;l<=r;l++){let d=Math.floor(a+l),n=Math.floor(c+u);if(d>=0&&d<e&&n>=0&&n<o){i++;let h=n*e+d;t[h]>0&&s++}}return i>0?s/i:0}function yt(t,e,o,a,c={}){let{searchSteps:r=9,numIterations:s=2,stepSize:i=1,edgeSharpness:u=.8}=c;if(!e||e.length!==o*a)return console.warn("Invalid edge map for grid optimization"),t;let{corners:l,cells:d}=t,n=l.length,h=l[0].length,x=.3+u*.5,m=.2*(1-u*.5);for(let p=0;p<s;p++)for(let f=1;f<n-1;f++)for(let M=1;M<h-1;M++){let v=l[f][M],y=v.x,E=v.y,C=[];f>0&&C.push(l[f-1][M]),f<n-1&&C.push(l[f+1][M]),M>0&&C.push(l[f][M-1]),M<h-1&&C.push(l[f][M+1]);let I=Mt(e,o,a,v.x,v.y,Math.ceil(i));for(let B of C)I+=vt(e,o,a,v.x,v.y,B.x,B.y);let b=Math.floor(Math.sqrt(r)),S=Math.floor(b/2);for(let B=-S;B<=S;B++)for(let R=-S;R<=S;R++){if(R===0&&B===0)continue;let L=v.x+R*i,w=v.y+B*i;if(L<0||L>=o||w<0||w>=a)continue;let D=Mt(e,o,a,L,w,Math.ceil(i));for(let F of C)D+=vt(e,o,a,L,w,F.x,F.y);D>I&&(I=D,y=L,E=w)}let P=p/Math.max(1,s-1),A=x+m*(1-P),X=y-v.x,N=E-v.y;v.x+=X*A,v.y+=N*A}return t}function ut(t,e,o){let a=document.createElement("canvas");a.width=e,a.height=o;let c=a.getContext("2d"),r=c.createImageData(e,o),s=r.data;if(t.length!==e*o){console.warn(`Edge map size mismatch: expected ${e*o}, got ${t.length}`);for(let l=0;l<s.length;l+=4)s[l]=255,s[l+1]=0,s[l+2]=0,s[l+3]=255;return c.putImageData(r,0,0),a}let i=!1,u=0;for(let l=0;l<t.length;l++)t[l]>0&&(i=!0,u=Math.max(u,t[l]));if(i)for(let l=0;l<t.length;l++){let d=t[l],n=l*4;if(d>0){let h=Math.round(d*255);s[n]=h,s[n+1]=h,s[n+2]=h}else s[n]=0,s[n+1]=0,s[n+2]=0;s[n+3]=255}else for(let l=0;l<s.length;l+=4)s[l]=32,s[l+1]=32,s[l+2]=32,s[l+3]=255;return c.putImageData(r,0,0),a}function Ct(t){let{width:e,height:o,data:a}=t,c=document.createElement("canvas");c.width=e,c.height=o;let r=c.getContext("2d"),s=r.createImageData(e,o),i=s.data;for(let u=0;u<a.length;u+=4){let l=Math.round(.299*a[u]+.587*a[u+1]+.114*a[u+2]);i[u]=l,i[u+1]=l,i[u+2]=l,i[u+3]=a[u+3]}return r.putImageData(s,0,0),c}function dt(t,e,o="rgba(255, 0, 0, 0.7)",a=1){let c=document.createElement("canvas");c.width=t.width,c.height=t.height;let r=c.getContext("2d");r.drawImage(t,0,0),r.strokeStyle=o,r.lineWidth=a,r.lineCap="round",r.lineJoin="round";let{corners:s}=e,i=s.length,u=s[0].length,l=t.width/(u-1),d=t.height/(i-1),n=Math.min(l,d),h=n<20?Math.ceil(20/n):1;for(let x=0;x<i;x+=h){r.beginPath(),r.moveTo(s[x][0].x,s[x][0].y);for(let m=1;m<u;m++)r.lineTo(s[x][m].x,s[x][m].y);r.stroke()}if(h>1&&i>1){let x=i-1;r.beginPath(),r.moveTo(s[x][0].x,s[x][0].y);for(let m=1;m<u;m++)r.lineTo(s[x][m].x,s[x][m].y);r.stroke()}for(let x=0;x<u;x+=h){r.beginPath(),r.moveTo(s[0][x].x,s[0][x].y);for(let m=1;m<i;m++)r.lineTo(s[m][x].x,s[m][x].y);r.stroke()}if(h>1&&u>1){let x=u-1;r.beginPath(),r.moveTo(s[0][x].x,s[0][x].y);for(let m=1;m<i;m++)r.lineTo(s[m][x].x,s[m][x].y);r.stroke()}return c}function J(t){let e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e}function bt(t,e,o={}){let{returnCanvas:a=!1,colorLimit:c=null,contrast:r=1}=o,s=t instanceof ImageData?t:St(t),i=Zt(t,e),u=i.scaledImageData;c&&c>0&&(u=Tt(u,c),i.scaledCanvas.getContext("2d").putImageData(u,0,0),i.scaledImageData=u);let l=Jt(i);if(r!==1){let d=l.getContext("2d").getImageData(0,0,l.width,l.height);d=wt(d,r),l.getContext("2d").putImageData(d,0,0)}return a?l:l.getContext("2d").getImageData(0,0,l.width,l.height)}function kt(t,e,o,a){let{width:c,height:r,data:s}=t,i=new ImageData(c,r),u=i.data;for(let l=0;l<r;l+=o)for(let d=0;d<c;d+=o){let n=Math.min(d+o,c),h=Math.min(l+o,r),x=[],m=!1,p=0;for(let M=l;M<h;M++)for(let v=d;v<n;v++){let y=(M*c+v)*4;x.push({r:s[y],g:s[y+1],b:s[y+2],a:s[y+3]});let E=M*c+v;e[E]>0&&(m=!0,p=Math.max(p,e[E]))}let f;if(m&&a>0){let M=Yt(x);if(a>=1)f=M;else{let v=It(x),y=a*p;f={r:Math.round(v.r*(1-y)+M.r*y),g:Math.round(v.g*(1-y)+M.g*y),b:Math.round(v.b*(1-y)+M.b*y),a:Math.round(v.a*(1-y)+M.a*y)}}}else f=It(x);for(let M=l;M<h;M++)for(let v=d;v<n;v++){let y=(M*c+v)*4;u[y]=f.r,u[y+1]=f.g,u[y+2]=f.b,u[y+3]=f.a}}return i}function It(t){let e=0,o=0,a=0,c=0;for(let s of t)e+=s.r,o+=s.g,a+=s.b,c+=s.a;let r=t.length;return{r:Math.round(e/r),g:Math.round(o/r),b:Math.round(a/r),a:Math.round(c/r)}}function Yt(t){if(t.length===0)return{r:0,g:0,b:0,a:255};if(t.length===1)return t[0];let e=[...t].sort((o,a)=>{let c=.299*o.r+.587*o.g+.114*o.b,r=.299*a.r+.587*a.g+.114*a.b;return c-r});return e[Math.floor(e.length/2)]}function Wt(t,e){let o=new Uint8ClampedArray(t.data),a=t.width,c=t.height,r=Math.max(1,Math.floor(Math.sqrt(a*c)/100)),s=[];for(let d=0;d<o.length;d+=4*r){let n=o[d],h=o[d+1],x=o[d+2];s.push({r:n,g:h,b:x})}let i=[];if(s.length<=e){let d=new Map;for(let n of s){let h=`${n.r},${n.g},${n.b}`;if(!d.has(h)&&(d.set(h,n),d.size>=e))break}i.push(...Array.from(d.values()))}else{let d=new Map;for(let h of s){let x=`${h.r},${h.g},${h.b}`;d.set(x,(d.get(x)||0)+1)}let n=Array.from(d.entries()).sort((h,x)=>x[1]-h[1]).map(([h])=>{let[x,m,p]=h.split(",").map(Number);return{r:x,g:m,b:p}});for(i.push(n[0]);i.length<e&&i.length<n.length;){let h=-1,x=null;for(let m of n){if(i.some(f=>f.r===m.r&&f.g===m.g&&f.b===m.b))continue;let p=1/0;for(let f of i){let M=Math.sqrt(Math.pow(m.r-f.r,2)+Math.pow(m.g-f.g,2)+Math.pow(m.b-f.b,2));M<p&&(p=M)}p>h&&(h=p,x=m)}if(x)i.push(x);else{for(let m of n){if(i.length>=e)break;i.some(p=>p.r===m.r&&p.g===m.g&&p.b===m.b)||i.push(m)}break}}}i.length===0&&i.push({r:128,g:128,b:128});let u=new ImageData(a,c),l=u.data;for(let d=0;d<o.length;d+=4){let n=o[d],h=o[d+1],x=o[d+2],m=o[d+3],p=1/0,f=i[0];for(let M of i){let v=Math.sqrt(Math.pow(n-M.r,2)+Math.pow(h-M.g,2)+Math.pow(x-M.b,2));v<p&&(p=v,f=M)}l[d]=f.r,l[d+1]=f.g,l[d+2]=f.b,l[d+3]=m}return u}function Ht(t,e){let o=t.data,a=new ImageData(t.width,t.height),c=a.data;for(let r=0;r<o.length;r+=4)c[r]=Math.max(0,Math.min(255,Math.round((o[r]-128)*e+128))),c[r+1]=Math.max(0,Math.min(255,Math.round((o[r+1]-128)*e+128))),c[r+2]=Math.max(0,Math.min(255,Math.round((o[r+2]-128)*e+128))),c[r+3]=o[r+3];return a}function St(t){if(t instanceof ImageData)return t;let e=document.createElement("canvas");if(t instanceof HTMLCanvasElement)e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement){let o=t.naturalWidth||t.width,a=t.naturalHeight||t.height;e.width=o,e.height=a,e.getContext("2d").drawImage(t,0,0)}else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");return e.getContext("2d").getImageData(0,0,e.width,e.height)}async function Vt(t,e={}){let{edgeSharpness:o=.8,onProgress:a=null}=e,{width:c,height:r}=t,s=null,i=!1;try{if(s=pt(t,{edgeSharpness:o}),i=s!==null,s)if(s.length!==c*r)console.warn("WebGL edge map size mismatch, falling back to CPU"),s=null,i=!1;else{let u=0,l=Math.min(1e4,s.length),d=Math.max(1,Math.floor(s.length/l));for(let n=0;n<s.length;n+=d)s[n]>0&&u++;if(u===0&&l>100){console.warn("WebGL edge map has no edges in sample, trying CPU");let n=et(t,{edgeSharpness:o}),h=0,x=Math.max(1,Math.floor(n.length/l));for(let m=0;m<n.length;m+=x)n[m]>0&&h++;h>0&&(s=n,i=!1)}}}catch(u){console.error("WebGL edge detection error:",u),s=null,i=!1}return s||(s=et(t,{edgeSharpness:o})),a&&a({usingGPU:i}),{edgeMap:s,usingGPU:i}}function Ot(t,e){return Et(t.width,t.height,e)}function qt(t,e={}){let{grid:o,edgeMap:a,imageData:c}=t,{searchSteps:r=9,numIterations:s=2,stepSize:i=1,edgeSharpness:u=.8}=e;if(!o||!a||!c)throw new Error("optimizeGridStep requires grid, edgeMap, and imageData in context");let{width:l,height:d}=c,n=Math.max(r,Math.floor(9+u*16)),h=Math.max(s,Math.floor(2+u*3));return yt(o,a,l,d,{searchSteps:n,numIterations:h,stepSize:i||1,edgeSharpness:u})}function jt(t,e,o,a){return kt(t,e,o,a)}function wt(t,e){return e===1?t:Ht(t,e)}function Tt(t,e){return!e||e<=0?t:Wt(t,e)}function $t(t,e=!1){if(!e)return t;let o=document.createElement("canvas");return o.width=t.width,o.height=t.height,o.getContext("2d").putImageData(t,0,0),o}function Zt(t,e){let o,a;if(t instanceof ImageData)o=t.width,a=t.height;else if(t instanceof HTMLCanvasElement)o=t.width,a=t.height;else if(t instanceof HTMLImageElement)o=t.naturalWidth||t.width,a=t.naturalHeight||t.height;else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");let c=Math.max(1,Math.floor(o/e)),r=Math.max(1,Math.floor(a/e)),s=document.createElement("canvas");s.width=c,s.height=r;let i=s.getContext("2d");if(i.imageSmoothingEnabled=!1,t instanceof ImageData){let l=document.createElement("canvas");l.width=o,l.height=a,l.getContext("2d").putImageData(t,0,0),i.drawImage(l,0,0,c,r)}else i.drawImage(t,0,0,c,r);return{scaledImageData:i.getImageData(0,0,c,r),originalSize:{width:o,height:a},scaledCanvas:s}}function Jt(t){let{scaledImageData:e,originalSize:o,scaledCanvas:a}=t;if(!e||!o||!a)throw new Error("upscaleImageStep requires scaledImageData, originalSize, and scaledCanvas from downscaleImageStep");let c=document.createElement("canvas");c.width=o.width,c.height=o.height;let r=c.getContext("2d");return r.imageSmoothingEnabled=!1,r.drawImage(a,0,0,o.width,o.height),c}async function Pt(t,e,o={}){let{returnCanvas:a=!1,searchSteps:c=9,numIterations:r=2,onProgress:s=null,colorLimit:i=null,contrast:u=1,edgeSharpness:l=.8,captureIntermediates:d=!1}=o,n=d?[]:null,h=St(t),{width:x,height:m}=h;d&&n.push({name:"Original",canvas:J(h)});let p=await Vt(h,{edgeSharpness:l,onProgress:s}),{edgeMap:f,usingGPU:M}=p,v=null;if(d){let z=function(k,Y,O,q,H){let V=ut(k,Y,O),W=document.createElement("canvas");W.width=q,W.height=H;let j=W.getContext("2d");return j.imageSmoothingEnabled=!1,j.drawImage(V,0,0,Y,O,0,0,q,H),W};n.push({name:"Grayscale",canvas:Ct(h)});let D=Math.min(1,800/Math.max(x,m)),F=Math.round(x*D),U=Math.round(m*D),_=h;if(D<1){let k=document.createElement("canvas");k.width=F,k.height=U;let Y=k.getContext("2d"),O=J(h);Y.drawImage(O,0,0,F,U),_=Y.getImageData(0,0,F,U)}let G=et(_,{edgeSharpness:l,captureIntermediates:!0});if(n.push({name:"Gradient Magnitude",canvas:z(G.intermediates.magnitude,F,U,x,m)}),n.push({name:"After NMS",canvas:z(G.intermediates.afterNMS,F,U,x,m)}),f&&f.length===x*m){let k=0;for(let Y=0;Y<f.length;Y++)f[Y]>0&&k++;k>0?(v=ut(f,x,m),n.push({name:"Edge Map",canvas:v})):(console.warn("Full-res edge map has no edges, using downscaled version for visualization"),v=z(G.intermediates.afterThreshold,F,U,x,m),n.push({name:"Edge Map",canvas:v}))}else console.warn("Full-res edge map invalid, using downscaled version for visualization"),v=z(G.intermediates.afterThreshold,F,U,x,m),n.push({name:"Edge Map",canvas:v})}let y=Ot(h,e),E=0;for(let w=0;w<f.length;w++)f[w]>0&&E++;let C=(E/f.length*100).toFixed(2);if(d){let w=J(h);n.push({name:"Initial Grid",canvas:dt(w,y,"rgba(255, 0, 0, 1.0)",2)})}let I=.5+l*1.5,b=Math.max(1,e*.3*I),S=Math.max(c,Math.floor(9+l*16)),P=Math.max(r,Math.floor(2+l*3)),A=null;d&&(A={corners:y.corners.map(w=>w.map(D=>({x:D.x,y:D.y})))}),E===0&&console.warn("Edge map has no edges - grid optimization will have no effect");let X=d?Math.max(b,e*.5):b,N=d?Math.max(S,25):S,B=d?Math.max(P,4):P;if(qt({grid:y,edgeMap:f,imageData:h},{searchSteps:N,numIterations:B,stepSize:X,edgeSharpness:l}),d){let w=y.corners.length,D=y.corners[0].length,F=Math.ceil(e);if(E>0)for(let U=1;U<w-1;U++)for(let _=1;_<D-1;_++){let G=y.corners[U][_],z=Math.floor(G.x),k=Math.floor(G.y),Y=0,O=0,q=1/0;for(let H=1;H<=F;H++)for(let V=-H;V<=H;V++)for(let W=-H;W<=H;W++){let j=z+W,Z=k+V;if(j>=0&&j<x&&Z>=0&&Z<m){let $=Z*x+j;if(f[$]>0){let gt=Math.sqrt(W*W+V*V);gt<q&&(q=gt,Y=W,O=V)}}}q<1/0&&q>0&&(G.x=z+Y,G.y=k+O)}}if(d){let w=J(h);n.push({name:"Optimized Grid",canvas:dt(w,y,"rgba(0, 255, 0, 1.0)",2)})}s&&s({usingGPU:M});let R=jt(h,f,e,l);R=wt(R,u),R=Tt(R,i);let L=$t(R,!0);return L._usingGPU=M,d?(n.push({name:"Final Result",canvas:L}),{canvas:L,intermediates:n,usingGPU:M}):a?L:R}function At(t){return new Promise((e,o)=>{let a=new Image;if(a.onload=()=>e(a),a.onerror=()=>o(new Error("Failed to load image")),t instanceof File){let c=new FileReader;c.onload=r=>{a.src=r.target.result},c.onerror=()=>o(new Error("Failed to read file")),c.readAsDataURL(t)}else a.src=t})}function Bt(t,e,o={}){let{interpolation:a="nearest",fillMode:c="constant",fillValue:r=0,returnCanvas:s=!1}=o;if(e.length!==8)throw new Error("Transform matrix must have 8 elements [a1, a2, a3, b1, b2, b3, c1, c2]");let[i,u,l,d,n,h,x,m]=e,p,f,M;if(t instanceof ImageData)p=t.width,f=t.height,M=t.data;else{let I=document.createElement("canvas");if(t instanceof HTMLCanvasElement)I.width=t.width,I.height=t.height,I.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement)I.width=t.naturalWidth||t.width,I.height=t.naturalHeight||t.height,I.getContext("2d").drawImage(t,0,0);else throw new Error("Unsupported image type");p=I.width,f=I.height,M=I.getContext("2d").getImageData(0,0,p,f).data}let v=document.createElement("canvas");v.width=p,v.height=f;let y=v.getContext("2d"),E=y.createImageData(p,f),C=E.data;for(let I=0;I<f;I++)for(let b=0;b<p;b++){let S=b,P=I,A=x*S+m*P+1;if(Math.abs(A)<1e-4){let _=(I*p+b)*4;C[_]=r,C[_+1]=r,C[_+2]=r,C[_+3]=255;continue}let X=(i*S+u*P+l)/A,N=(d*S+n*P+h)/A,B=Rt(X,p,c),R=Rt(N,f,c),L,w,D,F;if(a==="nearest"){let _=Math.round(B),G=Math.round(R),z=K(M,_,G,p,f,r);L=z.r,w=z.g,D=z.b,F=z.a}else{let _=Math.floor(B),G=Math.floor(R),z=_+1,k=G+1,Y=K(M,_,G,p,f,r),O=K(M,z,G,p,f,r),q=K(M,_,k,p,f,r),H=K(M,z,k,p,f,r),V=B-_,W=R-G,j=ht(Y,O,V),Z=ht(q,H,V),$=ht(j,Z,W);L=$.r,w=$.g,D=$.b,F=$.a}let U=(I*p+b)*4;C[U]=L,C[U+1]=w,C[U+2]=D,C[U+3]=F}return y.putImageData(E,0,0),s?v:E}function Rt(t,e,o){if(o==="constant")return t;if(o==="reflect"){if(t<0){if(e<=1)return 0;let a=2*e;t<-a&&(t=t+a*Math.floor(-t/a)),t=t<-e?t+a:-t-1}else if(t>e-1){if(e<=1)return 0;let a=2*e;t=t-a*Math.floor(t/a),t>=e&&(t=a-t-1)}return Math.max(0,Math.min(e-1,t))}else if(o==="wrap"){if(t<0){if(e<=1)return 0;let a=e-1;t=t+e*(Math.floor(-t/a)+1)}else if(t>e-1){if(e<=1)return 0;let a=e-1;t=t-e*Math.floor(t/a)}return Math.max(0,Math.min(e-1,t))}else if(o==="nearest")return Math.max(0,Math.min(e-1,t));return t}function K(t,e,o,a,c,r){if(e>=0&&e<a&&o>=0&&o<c){let s=(o*a+e)*4;return{r:t[s],g:t[s+1],b:t[s+2],a:t[s+3]}}else return{r,g:r,b:r,a:255}}function ht(t,e,o){return{r:Math.round(t.r+(e.r-t.r)*o),g:Math.round(t.g+(e.g-t.g)*o),b:Math.round(t.b+(e.b-t.b)*o),a:Math.round(t.a+(e.a-t.a)*o)}}function _t(t,e,o){let a=Math.cos(t),c=Math.sin(t),r=e-e*a+o*c,s=o-e*c-o*a;return[a,-c,r,c,a,s,0,0]}var g={imageInput:document.getElementById("imageInput"),pixelSizeSlider:document.getElementById("pixelSize"),pixelSizeNumber:document.getElementById("pixelSizeNumber"),pixelSizeValue:document.getElementById("pixelSizeValue"),colorLimitSlider:document.getElementById("colorLimit"),colorLimitNumber:document.getElementById("colorLimitNumber"),colorLimitValue:document.getElementById("colorLimitValue"),colorLimitGroup:document.getElementById("colorLimitGroup"),useColorLimit:document.getElementById("useColorLimit"),useEdgeAware:document.getElementById("useEdgeAware"),gpuIndicator:document.getElementById("gpuIndicator"),gpuStatus:document.getElementById("gpuStatus"),edgeSharpnessGroup:document.getElementById("edgeSharpnessGroup"),edgeSharpnessSlider:document.getElementById("edgeSharpness"),edgeSharpnessNumber:document.getElementById("edgeSharpnessNumber"),edgeSharpnessValue:document.getElementById("edgeSharpnessValue"),showStepsGroup:document.getElementById("showStepsGroup"),showAlgorithmSteps:document.getElementById("showAlgorithmSteps"),stepNavigation:document.getElementById("stepNavigation"),stepLabel:document.getElementById("stepLabel"),stepCounter:document.getElementById("stepCounter"),stepPrev:document.getElementById("stepPrev"),stepNext:document.getElementById("stepNext"),contrastGroup:document.getElementById("contrastGroup"),contrastSlider:document.getElementById("contrast"),contrastNumber:document.getElementById("contrastNumber"),contrastValue:document.getElementById("contrastValue"),useProjection:document.getElementById("useProjection"),rotationGroup:document.getElementById("rotationGroup"),rotationAngleSlider:document.getElementById("rotationAngle"),rotationAngleNumber:document.getElementById("rotationAngleNumber"),rotationAngleValue:document.getElementById("rotationAngleValue"),pixelateBtn:document.getElementById("pixelateBtn"),mainCanvas:document.getElementById("mainCanvas"),canvasTitle:document.getElementById("canvasTitle")},T={intermediates:[],currentStep:0},tt=g.mainCanvas.getContext("2d"),nt=null,Q=null;function ft(t,e,o,a,c,r){let s=()=>{let u=t.value;e.value=u,o.textContent=u},i=u=>{let l=Math.max(a,Math.min(c,parseInt(u.target.value)||r));t.value=l,e.value=l,o.textContent=l};t.addEventListener("input",s),e.addEventListener("input",i),s()}ft(g.pixelSizeSlider,g.pixelSizeNumber,g.pixelSizeValue,2,128,3);ft(g.colorLimitSlider,g.colorLimitNumber,g.colorLimitValue,2,256,32);function Lt(t,e,o,a,c,r){let s=()=>{let u=parseFloat(t.value);e.value=u.toFixed(1),o.textContent=u.toFixed(1)},i=u=>{let l=Math.max(a,Math.min(c,parseFloat(u.target.value)||r));t.value=l,e.value=l.toFixed(1),o.textContent=l.toFixed(1)};t.addEventListener("input",s),e.addEventListener("input",i),s()}Lt(g.edgeSharpnessSlider,g.edgeSharpnessNumber,g.edgeSharpnessValue,0,1,.8);Lt(g.contrastSlider,g.contrastNumber,g.contrastValue,.5,2,1);ft(g.rotationAngleSlider,g.rotationAngleNumber,g.rotationAngleValue,0,360,0);function Dt(){let t=g.useEdgeAware.checked;g.edgeSharpnessGroup.style.display=t?"flex":"none",g.showStepsGroup.style.display=t?"flex":"none",g.gpuIndicator.style.display=t?"block":"none",t||(g.gpuStatus.textContent="",g.stepNavigation.classList.remove("active"),T.intermediates=[])}function Ft(){let t=g.useColorLimit.checked;g.colorLimitGroup.style.display=t?"flex":"none"}function Ut(){let t=g.useProjection.checked;g.rotationGroup.style.display=t?"flex":"none"}function ot(t){if(g.useProjection.checked){let e=parseFloat(g.rotationAngleSlider.value)*Math.PI/180,o=t.width/2,a=t.height/2,c=_t(e,o,a);return Bt(t,c,{returnCanvas:!0,interpolation:"nearest"})}return t}function at(t){if(!T.intermediates.length)return;T.currentStep=Math.max(0,Math.min(t,T.intermediates.length-1));let e=T.intermediates[T.currentStep],o=e.canvas;if(e.name==="Final Result"){let a=e.originalCanvas||e.canvas;o=ot(a)}g.mainCanvas.width=o.width,g.mainCanvas.height=o.height,tt.drawImage(o,0,0),g.canvasTitle.textContent=e.name,g.stepLabel.textContent=e.name,g.stepCounter.textContent=`Step ${T.currentStep+1} of ${T.intermediates.length}`}function Gt(){if(!T.intermediates.length)return;let t=(T.currentStep+1)%T.intermediates.length;at(t)}function Xt(){if(!T.intermediates.length)return;let t=(T.currentStep-1+T.intermediates.length)%T.intermediates.length;at(t)}function Kt(t){T.intermediates=t,T.currentStep=t.length-1,g.stepNavigation.classList.add("active"),at(T.currentStep)}g.stepPrev.addEventListener("click",Xt);g.stepNext.addEventListener("click",Gt);document.addEventListener("keydown",t=>{T.intermediates.length!==0&&(t.key==="ArrowLeft"?Xt():t.key==="ArrowRight"&&Gt())});Ft();Dt();Ut();g.useColorLimit.addEventListener("change",Ft);g.useEdgeAware.addEventListener("change",Dt);g.useProjection.addEventListener("change",Ut);g.imageInput.addEventListener("change",async t=>{let e=t.target.files[0];if(!e){g.pixelateBtn.disabled=!0;return}try{g.pixelateBtn.disabled=!0,g.pixelateBtn.textContent="Loading...";let o=await At(e);nt=o,g.mainCanvas.width=o.width,g.mainCanvas.height=o.height,tt.drawImage(o,0,0),g.canvasTitle.textContent="Original Image",g.stepNavigation.classList.remove("active"),T.intermediates=[],g.pixelateBtn.disabled=!1,g.pixelateBtn.textContent="Pixelate Image"}catch(o){alert("Failed to load image: "+o.message),g.pixelateBtn.disabled=!0,g.pixelateBtn.textContent="Pixelate Image"}});g.pixelateBtn.addEventListener("click",async()=>{if(g.pixelateBtn.disabled)return;if(g.pixelateBtn.disabled=!0,!nt){alert("Please upload an image first."),g.pixelateBtn.disabled=!1;return}let t=parseInt(g.pixelSizeSlider.value),e=g.useColorLimit.checked?parseInt(g.colorLimitSlider.value):null,o=g.useEdgeAware.checked;try{g.pixelateBtn.textContent=o?"Processing (Edge-Aware)...":"Processing...",await new Promise(c=>setTimeout(c,0));let a;if(o){let c=parseFloat(g.contrastSlider.value),r=parseFloat(g.edgeSharpnessSlider.value),s=g.showAlgorithmSteps.checked;g.gpuStatus.textContent="Processing...";let i=await Pt(nt,t,{returnCanvas:!0,searchSteps:9,numIterations:3,colorLimit:e,contrast:c,edgeSharpness:r,captureIntermediates:s,onProgress:u=>{u.usingGPU?(g.gpuStatus.textContent="\u2713 Using GPU acceleration",g.gpuStatus.style.color="#4caf50"):(g.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",g.gpuStatus.style.color="#ff9800")}});if(s&&i.intermediates){if(a=i.canvas,i.intermediates.length>0){let u=i.intermediates[i.intermediates.length-1];u.name==="Final Result"&&(u.originalCanvas=u.canvas)}Kt(i.intermediates),i.usingGPU?(g.gpuStatus.textContent="\u2713 Using GPU acceleration",g.gpuStatus.style.color="#4caf50"):(g.gpuStatus.textContent="\u26A0 Using CPU (for visualization)",g.gpuStatus.style.color="#ff9800")}else{a=i,Q=a,g.stepNavigation.classList.remove("active"),T.intermediates=[];let u=ot(a);g.mainCanvas.width=u.width,g.mainCanvas.height=u.height,tt.drawImage(u,0,0),g.canvasTitle.textContent="Pixelated Image",i._usingGPU!==void 0&&(i._usingGPU?(g.gpuStatus.textContent="\u2713 Using GPU acceleration",g.gpuStatus.style.color="#4caf50"):(g.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",g.gpuStatus.style.color="#ff9800"))}}else{let c=parseFloat(g.contrastSlider.value);await new Promise(s=>requestAnimationFrame(s)),a=bt(nt,t,{returnCanvas:!0,colorLimit:e,contrast:c}),g.stepNavigation.classList.remove("active"),T.intermediates=[],Q=a;let r=ot(a);g.mainCanvas.width=r.width,g.mainCanvas.height=r.height,tt.drawImage(r,0,0),g.canvasTitle.textContent="Pixelated Image"}g.pixelateBtn.disabled=!1,g.pixelateBtn.textContent="Pixelate Image"}catch(a){alert("Failed to pixelate image: "+a.message),g.pixelateBtn.disabled=!1,g.pixelateBtn.textContent="Pixelate Image"}});function mt(){if(!(!Q&&!T.intermediates.length)){if(T.intermediates.length>0)at(T.currentStep);else if(Q){let t=ot(Q);g.mainCanvas.width=t.width,g.mainCanvas.height=t.height,tt.drawImage(t,0,0)}}}g.rotationAngleSlider.addEventListener("input",mt);g.rotationAngleNumber.addEventListener("input",mt);g.useProjection.addEventListener("change",mt);</script></body></html>