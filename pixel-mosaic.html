<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pixel Mosaic - Demo</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:30px}h1{text-align:center;color:#333;margin-bottom:30px;font-size:2.5em}.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:30px}.control-section{background:#f8f9fa;border-radius:6px;padding:12px;border:1px solid #e9ecef}.control-section-title{font-size:.8em;font-weight:700;color:#495057;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #dee2e6}.control-section-grid{display:grid;grid-template-columns:1fr;gap:12px}.control-group{display:flex;flex-direction:column;gap:6px;min-height:50px;transition:opacity .2s ease}.control-group[style*="display: none"]{min-height:0;opacity:0}label{font-weight:600;color:#555;font-size:.85em}input[type=checkbox]{margin-right:8px;cursor:pointer;width:18px;height:18px;accent-color:#667eea}label:has(input[type=checkbox]){display:flex;align-items:center;cursor:pointer;user-select:none}input[type=range]{width:100%;height:6px;border-radius:3px;background:#e0e0e0;outline:0;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;transition:background .2s}input[type=range]::-webkit-slider-thumb:hover{background:#5568d3}input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#667eea;cursor:pointer;border:none;transition:background .2s}input[type=range]::-moz-range-thumb:hover{background:#5568d3}input[type=number]{width:70px;padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:.85em}input[type=number]:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.1)}input[type=file]{padding:10px;border:2px dashed #667eea;border-radius:4px;cursor:pointer;background:#fff;transition:all .2s}input[type=file]:hover{border-color:#5568d3;background:#f8f9ff}button{padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:6px;font-size:.9em;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 4px rgba(102,126,234,.2)}button:hover:not(:disabled){background:#5568d3;box-shadow:0 4px 8px rgba(102,126,234,.3);transform:translateY(-1px)}button:active:not(:disabled){transform:translateY(0);box-shadow:0 2px 4px rgba(102,126,234,.2)}button:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;transform:none}.canvas-container{display:flex;flex-direction:column;align-items:center;margin-top:20px;margin-bottom:20px}.canvas-wrapper{text-align:center;width:100%}.canvas-wrapper h2{margin-bottom:12px;color:#333;font-size:1.1em}canvas{max-width:100%;height:auto;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}.info{margin-top:20px;padding:15px;background:#e3f2fd;border-left:4px solid #2196f3;border-radius:4px;color:#1565c0}.step-navigation{display:none;justify-content:center;align-items:center;gap:15px;margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px}.step-navigation.active{display:flex}.step-navigation button{padding:8px 16px;font-size:.9em;min-width:90px}.step-label{font-weight:600;color:#333;font-size:1em;min-width:180px;text-align:center}.step-counter{color:#666;font-size:.85em}.github-link{margin-top:30px;text-align:center;padding:20px}.github-link a{display:inline-flex;align-items:center;gap:8px;color:#667eea;text-decoration:none;font-weight:600;font-size:1.1em;transition:color .3s}.github-link a:hover{color:#5568d3}.github-link a::before{content:'üîó';font-size:1.2em}</style></head><body><div class=container><h1>üé® Pixel Mosaic</h1><div class=control-section style="max-width:400px;margin:0 auto 20px"><div class=control-section-title>üì§ Image Upload</div><div class=control-section-grid><div class=control-group><label for=imageInput>Upload Image</label> <input type=file id=imageInput accept=image/*></div></div></div><div class=canvas-container><div class=canvas-wrapper><h2 id=canvasTitle>Upload an image to begin</h2><canvas id=mainCanvas></canvas><div style=margin-top:15px><button id=pixelateBtn disabled=disabled>Pixelate Image</button></div><div class=step-navigation id=stepNavigation><button id=stepPrev>‚Üê Previous</button><div><div class=step-label id=stepLabel>Original</div><div class=step-counter id=stepCounter></div></div><button id=stepNext>Next ‚Üí</button></div></div></div><div class=controls><div class=control-section><div class=control-section-title>üé® Pixelation</div><div class=control-section-grid><div class=control-group><label for=pixelSize>Pixel Size: <span id=pixelSizeValue>3</span></label> <input type=range id=pixelSize min=2 max=128 value=3> <input type=number id=pixelSizeNumber min=2 max=128 value=3></div><div class=control-group><label for=contrast>Contrast: <span id=contrastValue>1.0</span></label> <input type=range id=contrast min=0.5 max=2 step=0.1 value=1.0> <input type=number id=contrastNumber min=0.5 max=2 step=0.1 value=1.0></div><div class=control-group><label><input type=checkbox id=useColorLimit checked=checked> Enable Color Limiting</label></div><div class=control-group id=colorLimitGroup><label for=colorLimit>Color Limit: <span id=colorLimitValue>32</span></label> <input type=range id=colorLimit min=2 max=256 value=32> <input type=number id=colorLimitNumber min=2 max=256 value=32></div></div></div><div class=control-section><div class=control-section-title>üîç Edge-Aware</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useEdgeAware> Enable Edge-Aware</label><div id=gpuIndicator style=display:none;margin-top:4px;font-size:.75em;color:#666><span id=gpuStatus>Checking GPU...</span></div></div><div class=control-group id=edgeSharpnessGroup style=display:none><label for=edgeSharpness>Edge Sharpness: <span id=edgeSharpnessValue>0.8</span></label> <input type=range id=edgeSharpness min=0 max=1 step=0.1 value=0.8> <input type=number id=edgeSharpnessNumber min=0 max=1 step=0.1 value=0.8></div><div class=control-group id=gridResolutionGroup style=display:none><label for=gridResolution>Grid Resolution: <span id=gridResolutionValue>-</span></label> <input type=range id=gridResolution min=10 max=500 value=100> <input type=number id=gridResolutionNumber min=10 max=500 value=100><div style=font-size:.75em;color:#666;margin-top:4px>Current: <span id=currentGridResolution>-</span></div></div><div class=control-group id=numPassesGroup style=display:none><label for=numPasses>Optimization Passes: <span id=numPassesValue>3</span></label> <input type=range id=numPasses min=1 max=10 value=3> <input type=number id=numPassesNumber min=1 max=10 value=3></div><div class=control-group id=showStepsGroup style=display:none><label><input type=checkbox id=showAlgorithmSteps> Show Algorithm Steps</label></div><div class=control-group id=useSplinesGroup style=display:none><label><input type=checkbox id=useSplines> Use B-Splines</label></div><div class=control-group id=splineSmoothnessGroup style=display:none><label for=splineSmoothness>Spline Smoothness: <span id=splineSmoothnessValue>0.3</span></label> <input type=range id=splineSmoothness min=0 max=1 step=0.01 value=0.3> <input type=number id=splineSmoothnessNumber min=0 max=1 step=0.01 value=0.3></div></div></div><div class=control-section><div class=control-section-title>üîÑ Transform</div><div class=control-section-grid><div class=control-group><label><input type=checkbox id=useProjection> Apply Rotation</label></div><div class=control-group id=rotationGroup style=display:none><label for=rotationAngle>Rotation: <span id=rotationAngleValue>0</span>¬∞</label> <input type=range id=rotationAngle min=0 max=360 value=0> <input type=number id=rotationAngleNumber min=0 max=360 value=0></div><div class=control-group><label><input type=checkbox id=useScaling> Apply Scaling</label></div><div class=control-group id=scalingGroup style=display:none><label for=scaleX>Scale X: <span id=scaleXValue>1.0</span></label> <input type=range id=scaleX min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleXNumber min=0.1 max=3 step=0.1 value=1.0></div><div class=control-group id=scalingGroupY style=display:none><label for=scaleY>Scale Y: <span id=scaleYValue>1.0</span></label> <input type=range id=scaleY min=0.1 max=3 step=0.1 value=1.0> <input type=number id=scaleYNumber min=0.1 max=3 step=0.1 value=1.0></div></div></div></div><div class=info><strong>How to use:</strong> Upload an image, adjust the pixel size and color limit, then click "Pixelate Image". Enable "Edge-Aware Pixelation" for adaptive grid optimization with adjustable edge sharpness. Check "Show Algorithm Steps" to visualize the edge detection process.</div><div class=github-link><a href=https://github.com/yogthos/pixel-mosaic target=_blank rel="noopener noreferrer">View on GitHub</a></div></div><script type=module>function ht(t,e,o,r){let a=new Float32Array(o*r);for(let l=1;l<r-1;l++)for(let s=1;s<o-1;s++){let c=l*o+s,u=t[c],i=e[c];if(u===0){a[c]=0;continue}let d=i;for(;d<0;)d+=2*Math.PI;for(;d>=2*Math.PI;)d-=2*Math.PI;let n,m;d>=0&&d<Math.PI/8||d>=15*Math.PI/8&&d<2*Math.PI||d>=7*Math.PI/8&&d<9*Math.PI/8?(n=t[c-1],m=t[c+1]):d>=Math.PI/8&&d<3*Math.PI/8||d>=9*Math.PI/8&&d<11*Math.PI/8?(n=t[(l-1)*o+(s+1)],m=t[(l+1)*o+(s-1)]):d>=3*Math.PI/8&&d<5*Math.PI/8||d>=11*Math.PI/8&&d<13*Math.PI/8?(n=t[(l-1)*o+s],m=t[(l+1)*o+s]):(n=t[(l-1)*o+(s-1)],m=t[(l+1)*o+(s+1)]),u>=n&&u>=m?a[c]=u:a[c]=0}return a}function mt(t,e,o,r={}){let{threshold:a=.1,highThreshold:l=null,lowThreshold:s=null,usePercentile:c=!0,binarize:u=!0}=r,i=new Float32Array(t.length),d=a;if(c&&a>0){let n=[];for(let m=0;m<t.length;m++)t[m]>0&&n.push(t[m]);if(n.length>0){n.sort((f,x)=>f-x);let m=a,y=Math.ceil(n.length*m),g=Math.min(n.length-1,Math.max(0,y));d=n[g]}}if(l!==null&&s!==null&&l>s){let n=l,m=s;if(c){let f=[];for(let x=0;x<t.length;x++)t[x]>0&&f.push(t[x]);if(f.length>0){f.sort((M,v)=>M-v);let x=1-l,E=1-s,I=Math.floor(f.length*x),p=Math.floor(f.length*E);n=f[Math.max(0,I-1)]||0,m=f[Math.max(0,p-1)]||0}}let y=new Set,g=new Set;for(let f=0;f<t.length;f++)t[f]>=n?(y.add(f),i[f]=u?1:t[f]):(t[f]>=m&&g.add(f),i[f]=0);for(let f=0;f<t.length;f++)if(g.has(f)){let x=!1,E=f%e,I=Math.floor(f/e);for(let p=-1;p<=1&&!x;p++)for(let M=-1;M<=1&&!x;M++){if(M===0&&p===0)continue;let v=E+M,S=I+p;if(v>=0&&v<e&&S>=0&&S<o){let b=S*e+v;y.has(b)&&(x=!0)}}x&&(i[f]=u?1:t[f])}}else for(let n=0;n<t.length;n++)t[n]>=d?i[n]=u?1:t[n]:i[n]=0;return i}function st(t,e={}){let{applyNMS:o=!0,threshold:r=null,edgeSharpness:a=.8,highThreshold:l=null,lowThreshold:s=null,captureIntermediates:c=!1}=e;r===null&&(r=.1+a*.5);let{data:u,width:i,height:d}=t,n=new Float32Array(i*d),m=new Float32Array(i*d),y=null;c&&(y=new Float32Array(i*d));let g=[-1,0,1,-2,0,2,-1,0,1],f=[-1,-2,-1,0,0,0,1,2,1];for(let M=1;M<d-1;M++)for(let v=1;v<i-1;v++){let S=0,b=0;for(let T=-1;T<=1;T++)for(let R=-1;R<=1;R++){let _=((M+T)*i+(v+R))*4,A=(u[_]+u[_+1]+u[_+2])/3,X=(T+1)*3+(R+1);S+=A*g[X],b+=A*f[X],c&&T===0&&R===0&&(y[M*i+v]=A/255)}let C=Math.sqrt(S*S+b*b);n[M*i+v]=C;let w=Math.atan2(b,S)+Math.PI/2;m[M*i+v]=w}if(c){for(let M=0;M<d;M++)for(let v=0;v<i;v++)if(M===0||M===d-1||v===0||v===i-1){let S=(M*i+v)*4,b=(u[S]+u[S+1]+u[S+2])/3;y[M*i+v]=b/255}}let x=0;for(let M=0;M<n.length;M++)n[M]>x&&(x=n[M]);if(x>0)for(let M=0;M<n.length;M++)n[M]/=x;let E=null;c&&(E=new Float32Array(n));let I=n,p=null;return o&&(I=ht(n,m,i,d),c&&(p=new Float32Array(I))),I=mt(I,i,d,{threshold:r,highThreshold:l,lowThreshold:s}),c?{edgeMap:I,intermediates:{grayscale:y,magnitude:E,afterNMS:p||E,afterThreshold:I},width:i,height:d}:I}function ft(t,e,o,r,a,l=!1){if(r=Math.max(0,Math.min(e-1,r)),a=Math.max(0,Math.min(o-1,a)),!l){let S=Math.round(r),C=Math.round(a)*e+S;return t[C]||0}let s=Math.floor(r),c=Math.floor(a),u=Math.min(e-1,s+1),i=Math.min(o-1,c+1),d=r-s,n=a-c,m=c*e+s,y=i*e+s,g=c*e+u,f=i*e+u,x=t[m]||0,E=t[y]||0,I=t[g]||0,p=t[f]||0,M=x*(1-d)+I*d,v=E*(1-d)+p*d;return M*(1-n)+v*n}function te(t){let e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return null;let o=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    varying vec2 v_texCoord;

    void main() {
      gl_Position = vec4(a_position, 0.0, 1.0);
      v_texCoord = a_texCoord;
    }
  `,r=`
    precision mediump float;
    uniform sampler2D u_image;
    uniform vec2 u_textureSize;
    varying vec2 v_texCoord;

    void main() {
      vec2 onePixel = vec2(1.0) / u_textureSize;

      // Sample neighboring pixels for Sobel operator
      float tl = texture2D(u_image, v_texCoord + vec2(-onePixel.x, -onePixel.y)).r;
      float tm = texture2D(u_image, v_texCoord + vec2( 0.0, -onePixel.y)).r;
      float tr = texture2D(u_image, v_texCoord + vec2( onePixel.x, -onePixel.y)).r;
      float ml = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  0.0)).r;
      float mr = texture2D(u_image, v_texCoord + vec2( onePixel.x,  0.0)).r;
      float bl = texture2D(u_image, v_texCoord + vec2(-onePixel.x,  onePixel.y)).r;
      float bm = texture2D(u_image, v_texCoord + vec2( 0.0,  onePixel.y)).r;
      float br = texture2D(u_image, v_texCoord + vec2( onePixel.x,  onePixel.y)).r;

      // Sobel X kernel: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
      float sobelX = -tl + tr - 2.0 * ml + 2.0 * mr - bl + br;

      // Sobel Y kernel: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
      float sobelY = -tl - 2.0 * tm - tr + bl + 2.0 * bm + br;

      // Calculate gradient magnitude
      float magnitude = sqrt(sobelX * sobelX + sobelY * sobelY);

      // Normalize magnitude to [0, 1] range
      // Max theoretical magnitude for normalized [0,1] input with Sobel is ~5.66
      // Use 6.0 as divisor to ensure we stay in [0, 1] range
      float magnitudeNormalized = magnitude / 6.0;

      // Calculate edge direction (perpendicular to gradient)
      // atan2 returns [-\u03C0, \u03C0], we add \u03C0/2 and normalize to [0, 2\u03C0)
      float direction = atan(sobelY, sobelX) + 3.14159265359 / 2.0;
      if (direction < 0.0) direction += 2.0 * 3.14159265359;

      // Normalize direction to [0, 1] for storage in texture
      float directionNormalized = direction / (2.0 * 3.14159265359);

      // Output: R = magnitude (normalized), G = direction (normalized), B = unused, A = 1.0
      gl_FragColor = vec4(magnitudeNormalized, directionNormalized, 0.0, 1.0);
    }
  `;function a(n,m,y){let g=n.createShader(m);return n.shaderSource(g,y),n.compileShader(g),n.getShaderParameter(g,n.COMPILE_STATUS)?g:(console.error("Shader compile error:",n.getShaderInfoLog(g)),n.deleteShader(g),null)}function l(n,m,y){let g=n.createProgram();return n.attachShader(g,m),n.attachShader(g,y),n.linkProgram(g),n.getProgramParameter(g,n.LINK_STATUS)?g:(console.error("Program link error:",n.getProgramInfoLog(g)),n.deleteProgram(g),null)}let s=a(e,e.VERTEX_SHADER,o),c=a(e,e.FRAGMENT_SHADER,r);if(!s||!c)return null;let u=l(e,s,c);if(!u)return null;let i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);let d=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),{gl:e,program:u,positionBuffer:i,texCoordBuffer:d}}function ee(t,e){let{width:o,height:r,data:a}=e,l=new Uint8Array(o*r);for(let c=0;c<a.length;c+=4){let u=Math.round(.299*a[c]+.587*a[c+1]+.114*a[c+2]);l[c/4]=u}let s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,o,r,0,t.LUMINANCE,t.UNSIGNED_BYTE,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),s}function bt(t,e={}){let{applyNMS:o=!0,threshold:r=null,edgeSharpness:a=.8,highThreshold:l=null,lowThreshold:s=null}=e;r===null&&(r=.02+a*.18);let{width:c,height:u}=t,i=document.createElement("canvas");i.width=c,i.height=u;let d=te(i);if(!d)return console.warn("WebGL not available, falling back to CPU"),null;let{gl:n,program:m,positionBuffer:y,texCoordBuffer:g}=d,f=ee(n,t);n.viewport(0,0,c,u),n.useProgram(m);let x=n.getAttribLocation(m,"a_position"),E=n.getAttribLocation(m,"a_texCoord");n.bindBuffer(n.ARRAY_BUFFER,y),n.enableVertexAttribArray(x),n.vertexAttribPointer(x,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,g),n.enableVertexAttribArray(E),n.vertexAttribPointer(E,2,n.FLOAT,!1,0,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,f),n.uniform1i(n.getUniformLocation(m,"u_image"),0),n.uniform2f(n.getUniformLocation(m,"u_textureSize"),c,u);let I=n.createTexture();n.bindTexture(n.TEXTURE_2D,I),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,c,u,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);let p=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,p),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,I,0);let M=n.checkFramebufferStatus(n.FRAMEBUFFER);if(M!==n.FRAMEBUFFER_COMPLETE)return console.error("WebGL framebuffer incomplete:",M),n.deleteTexture(f),n.deleteTexture(I),n.deleteFramebuffer(p),null;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,f),n.drawArrays(n.TRIANGLES,0,6);let v=n.getError();if(v!==n.NO_ERROR)return console.error("WebGL error during rendering:",v),n.deleteTexture(f),n.deleteTexture(I),n.deleteFramebuffer(p),null;let S=new Uint8Array(c*u*4);n.readPixels(0,0,c,u,n.RGBA,n.UNSIGNED_BYTE,S);let b=new Float32Array(c*u),C=new Float32Array(c*u);for(let T=0;T<c*u;T++){b[T]=S[T*4]/255;let R=S[T*4+1]/255;C[T]=R*2*Math.PI}let w=b;return o&&(w=ht(b,C,c,u)),w=mt(w,c,u,{threshold:r,highThreshold:l,lowThreshold:s}),n.deleteTexture(f),n.deleteTexture(I),n.deleteFramebuffer(p),w}function At(t,e,o=2){if(e.length<2)return{x:e[0].x,y:e[0].y};if(e.length===2)return{x:e[0].x+(e[1].x-e[0].x)*t,y:e[0].y+(e[1].y-e[0].y)*t};if(o===2&&e.length>=3){let r=e[0],a=e[1],l=e[2],s=1-t,c=s*s,u=t*t,i=c,d=2*t*s,n=u;return{x:i*r.x+d*a.x+n*l.x,y:i*r.y+d*a.y+n*l.y}}if(o===3&&e.length>=4){let r=e[0],a=e[1],l=e[2],s=e[3],c=1-t,u=c*c,i=u*c,d=t*t,n=d*t,m=i,y=3*t*u,g=3*d*c,f=n;return{x:m*r.x+y*a.x+g*l.x+f*s.x,y:m*r.y+y*a.y+g*l.y+f*s.y}}return{x:e[0].x+(e[1].x-e[0].x)*t,y:e[0].y+(e[1].y-e[0].y)*t}}function Pt(t,e,o=null,r=null,a=.3,l=null,s=null){let c=[t],u=(t.x+e.x)/2,i=(t.y+e.y)/2;if(a<.001)return c.push({x:u,y:i}),c.push(e),c;let d=e.x-t.x,n=e.y-t.y,m=Math.sqrt(d*d+n*n);if(m<.001)return c.push({x:u,y:i}),c.push(e),c;let y=-n/m,g=d/m;y+g<0&&(y=-y,g=-g);let f=u,x=i;if(o&&r){let E=(o.x+r.x)/2,I=(o.y+r.y)/2,p=E-u,M=I-i,S=-(p*y+M*g)*a*.4,b=m*.2,C=Math.max(-b,Math.min(b,S));f=u+y*C,x=i+g*C}return l!==null&&s!==null&&(f=Math.max(0,Math.min(l-1,f)),x=Math.max(0,Math.min(s-1,x))),c.push({x:f,y:x}),c.push(e),c}function it(t,e,o=2,r=.3){if(t._splineCache&&t._splineCache.splineDegree===o&&t._splineCache.splineSmoothness===r)return t._splineCache;let a=t.corners,l=[],s=1/0,c=-1/0,u=1/0,i=-1/0;if(r<.001){for(let T of a)l.push({x:T.x,y:T.y}),s=Math.min(s,T.x),c=Math.max(c,T.x),u=Math.min(u,T.y),i=Math.max(i,T.y);let v=(a[0].x+a[1].x+a[2].x+a[3].x)/4,S=(a[0].y+a[1].y+a[2].y+a[3].y)/4,b=(a[1].x-a[0].x+(a[2].x-a[3].x))/2,C=(a[3].y-a[0].y+(a[2].y-a[1].y))/2,w=Math.min(Math.abs(b),Math.abs(C))/2;return t._splineCache={polygon:l,minX:s,maxX:c,minY:u,maxY:i,centerX:v,centerY:S,radius:w,splineDegree:o,splineSmoothness:r},t._splineCache}let d=-1,n=-1;if(e&&e.corners&&t._gridIndex!==void 0)d=Math.floor(t._gridIndex/e.cols),n=t._gridIndex%e.cols;else if(e&&e.cells){let v=e.cells.indexOf(t);v>=0&&(t._gridIndex=v,d=Math.floor(v/e.cols),n=v%e.cols)}let m=e&&e.corners?e.corners.length:0,y=e&&e.corners?e.corners[0].length:0,g=12;for(let v=0;v<4;v++){let S=a[v],b=a[(v+1)%4],C=null,w=null;d>=0&&n>=0&&(v===0?(C=a[3],w=a[2]):v===1?(C=a[0],w=a[3]):v===2?(C=a[1],w=a[0]):(C=a[2],w=a[1]));let T=Pt(S,b,C,w,r);for(let R=0;R<g;R++){let _=R/g,A=At(_,T,o);l.push(A),s=Math.min(s,A.x),c=Math.max(c,A.x),u=Math.min(u,A.y),i=Math.max(i,A.y)}}let f=(a[0].x+a[1].x+a[2].x+a[3].x)/4,x=(a[0].y+a[1].y+a[2].y+a[3].y)/4,E=(a[1].x-a[0].x+(a[2].x-a[3].x))/2,I=(a[3].y-a[0].y+(a[2].y-a[1].y))/2,p=Math.min(Math.abs(E),Math.abs(I))/2,M=Math.max(c-s,i-u)*.1;return t._splineCache={polygon:l,minX:s-M,maxX:c+M,minY:u-M,maxY:i+M,centerX:f,centerY:x,radius:p,splineDegree:o,splineSmoothness:r},t._splineCache}function Ct(t,e,o,r,a=2,l=.3){let s=it(o,r,a,l);if(t<s.minX||t>s.maxX||e<s.minY||e>s.maxY)return!1;let c=s.polygon,u=0,i=c.length;for(let d=0;d<i;d++){let n=c[d],m=c[(d+1)%i];n.y<=e?m.y>e&&(m.x-n.x)*(e-n.y)-(t-n.x)*(m.y-n.y)>0&&u++:m.y<=e&&(m.x-n.x)*(e-n.y)-(t-n.x)*(m.y-n.y)<0&&u--}return u!==0}function wt(t,e,o){let r=[[o[0],o[1]],[o[1],o[2]],[o[2],o[3]],[o[3],o[0]]],a=null;for(let[l,s]of r){let c=s.x-l.x,u=s.y-l.y,i=t-l.x,d=e-l.y,n=c*d-u*i;if(Math.abs(n)<1e-10)continue;let m=n>0?"left":"right";if(a===null)a=m;else if(a!==m)return!1}return!0}var gt=class{constructor(e,o){this.x=e,this.y=o,this.originalX=e,this.originalY=o}reset(){this.x=this.originalX,this.y=this.originalY}},pt=class{constructor(e){this.corners=e}getBounds(e=!1,o=2,r=null,a=.3){if(e&&r){let i=it(this,r,o,a);return{minX:i.minX,minY:i.minY,maxX:i.maxX,maxY:i.maxY}}let l=1/0,s=1/0,c=-1/0,u=-1/0;for(let i of this.corners)l=Math.min(l,i.x),s=Math.min(s,i.y),c=Math.max(c,i.x),u=Math.max(u,i.y);return{minX:l,minY:s,maxX:c,maxY:u}}getAverageColor(e,o=!1,r=null,a=2,l=.3){let{data:s,width:c}=e,u=this.getBounds(o,a,r,l),i=Math.max(0,Math.floor(u.minX)),d=Math.max(0,Math.floor(u.minY)),n=Math.min(c-1,Math.floor(u.maxX)),m=Math.min(e.height-1,Math.floor(u.maxY)),y=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],g=Math.max(1,Math.floor(Math.min((n-i)/10,(m-d)/10,4))),f=0,x=0,E=0,I=0,p=0;o&&r&&it(this,r,a,l);for(let M=d;M<=m;M+=g)for(let v=i;v<=n;v+=g){let S=v+.5,b=M+.5,C=!1;if(o&&r?C=Ct(S,b,this,r,a,l):C=wt(S,b,y),C){let w=(M*c+v)*4;f+=s[w],x+=s[w+1],E+=s[w+2],I+=s[w+3],p++}}if(p===0)for(let M=d;M<=m;M++)for(let v=i;v<=n;v++){let S=(M*c+v)*4;f+=s[S],x+=s[S+1],E+=s[S+2],I+=s[S+3],p++}return p===0?{r:0,g:0,b:0,a:255}:{r:Math.round(f/p),g:Math.round(x/p),b:Math.round(E/p),a:Math.round(I/p)}}getBlendedColor(e,o,r=!1,a=null,l=2,s=.3){let{data:c,width:u}=e,i=this.getBounds(r,l,a,s),d=Math.max(0,Math.floor(i.minX)),n=Math.max(0,Math.floor(i.minY)),m=Math.min(u-1,Math.floor(i.maxX)),y=Math.min(e.height-1,Math.floor(i.maxY)),g=[this.corners[0],this.corners[1],this.corners[2],this.corners[3]],f=Math.max(1,Math.floor(Math.min((m-d)/12,(y-n)/12,3)));r&&a&&it(this,a,l,s);let x=[],E=0,I=0,p=0,M=0;for(let _=n;_<=y;_+=f)for(let A=d;A<=m;A+=f){let X=A+.5,j=_+.5,U=!1;if(r&&a?U=Ct(X,j,this,a,l,s):U=wt(X,j,g),U){let L=(_*u+A)*4,D=c[L],P=c[L+1],B=c[L+2],N=c[L+3];x.push({r:D,g:P,b:B,a:N}),E+=D,I+=P,p+=B,M+=N}}if(x.length===0)return this.getAverageColor(e,r,a,l,s);let v=x.length;E=Math.round(E/v),I=Math.round(I/v),p=Math.round(p/v),M=Math.round(M/v),x.sort((_,A)=>_.r+_.g+_.b-(A.r+A.g+A.b));let S=Math.floor(x.length/2),b=x[S].r,C=x[S].g,w=x[S].b,T=x[S].a,R=o;return{r:Math.round(E*(1-R)+b*R),g:Math.round(I*(1-R)+C*R),b:Math.round(p*(1-R)+w*R),a:Math.round(M*(1-R)+T*R)}}};function Bt(t,e,o){let r=Math.ceil(t/o),a=Math.ceil(e/o),l=[],s=[];for(let c=0;c<=a;c++){let u=[];for(let i=0;i<=r;i++){let d=i*t/r,n=c*e/a;u.push(new gt(d,n))}l.push(u)}for(let c=0;c<a;c++)for(let u=0;u<r;u++){let i=new pt([l[c][u],l[c][u+1],l[c+1][u+1],l[c+1][u]]);i._gridIndex=c*r+u,s.push(i)}return{corners:l,cells:s,cols:r,rows:a}}function ne(t,e,o){let{width:r,height:a}=e,{cols:l,rows:s}=t,c=new ImageData(r,a),u=c.data,i=r/l,d=a/s;for(let n=0;n<s;n++)for(let m=0;m<l;m++){let y=n*l+m,g=o[y],f=Math.floor(m*i),x=Math.floor((m+1)*i),E=Math.floor(n*d),I=Math.floor((n+1)*d);for(let p=E;p<I&&p<a;p++)for(let M=f;M<x&&M<r;M++){let v=(p*r+M)*4;u[v]=g.r,u[v+1]=g.g,u[v+2]=g.b,u[v+3]=255}}return c}function Tt(t,e,o,r,a,l,s,c=!1,u=null,i=null,d=2,n=.3){let m=l-r,y=s-a,g=Math.sqrt(m*m+y*y);if(g<1)return 0;let f=Math.max(3,Math.ceil(g*1.5)),x=0,E=0,I=0,p=null;c&&(p=Pt({x:r,y:a},{x:l,y:s},u,i,n));for(let b=0;b<=f;b++){let C=b/f,w,T;if(c&&p){let X=At(C,p,d);w=X.x,T=X.y}else w=r+m*C,T=a+y*C;let R=Math.max(0,Math.min(e-1,w)),_=Math.max(0,Math.min(o-1,T));ft(t,e,o,R,_,!1)>0?(x++,E++,I=Math.max(I,E)):E=0}let M=x/(f+1),v=I/(f+1),S=ft(t,e,o,Math.max(0,Math.min(e-1,r)),Math.max(0,Math.min(o-1,a)),!1)>0?.2:0;return M*.4+v*.4+S}function Rt(t,e,o,r,a,l=3){let s=0,c=0;for(let u=-l;u<=l;u++)for(let i=-l;i<=l;i++){let d=Math.floor(r+i),n=Math.floor(a+u);if(d>=0&&d<e&&n>=0&&n<o){c++;let m=n*e+d;t[m]>0&&s++}}return c>0?s/c:0}function _t(t,e,o,r,a={}){let{searchSteps:l=9,numIterations:s=2,stepSize:c=1,edgeSharpness:u=.8,useSplines:i=!1,splineDegree:d=2,splineSmoothness:n=.3}=a;if(!e||e.length!==o*r)return console.warn("Invalid edge map for grid optimization"),t;let{corners:m,cells:y}=t,g=m.length,f=m[0].length,x=.3+u*.5,E=.2*(1-u*.5);for(let I=0;I<s;I++)for(let p=1;p<g-1;p++)for(let M=1;M<f-1;M++){let v=m[p][M],S=v.x,b=v.y,C=[];p>0&&C.push(m[p-1][M]),p<g-1&&C.push(m[p+1][M]),M>0&&C.push(m[p][M-1]),M<f-1&&C.push(m[p][M+1]);let w=Rt(e,o,r,v.x,v.y,Math.ceil(c));for(let U of C){let L=null,D=null;if(i){let P=U.x-v.x,B=U.y-v.y;Math.abs(P)>Math.abs(B)?(p>0&&(L=m[p-1][M]),p<g-1&&(D=m[p+1][M])):(M>0&&(L=m[p][M-1]),M<f-1&&(D=m[p][M+1]))}w+=Tt(e,o,r,v.x,v.y,U.x,U.y,i,L,D,d,n)}let T=Math.floor(Math.sqrt(l)),R=Math.floor(T/2);for(let U=-R;U<=R;U++)for(let L=-R;L<=R;L++){if(L===0&&U===0)continue;let D=v.x+L*c,P=v.y+U*c;if(D<0||D>=o||P<0||P>=r)continue;let B=Rt(e,o,r,D,P,Math.ceil(c));for(let N of C){let F=null,k=null;if(i){let V=N.x-D,H=N.y-P;Math.abs(V)>Math.abs(H)?(p>0&&(F=m[p-1][M]),p<g-1&&(k=m[p+1][M])):(M>0&&(F=m[p][M-1]),M<f-1&&(k=m[p][M+1]))}B+=Tt(e,o,r,D,P,N.x,N.y,i,F,k,d,n)}B>w&&(w=B,S=D,b=P)}let _=I/Math.max(1,s-1),A=x+E*(1-_),X=S-v.x,j=b-v.y;v.x+=X*A,v.y+=j*A}return t}function oe(t,e,o,r,a,l){let{data:s,width:c,height:u}=t;if(e=Math.max(0,Math.floor(e)),o=Math.max(0,Math.floor(o)),r=Math.min(c,Math.floor(r)),a=Math.min(u,Math.floor(a)),r<=e||a<=o)return{r:128,g:128,b:128,a:255};let i=r-e,d=a-o,n=Math.max(1,Math.floor(Math.min(i/6,d/6,4))),m=[],y=0,g=0,f=0,x=0;for(let C=o;C<a;C+=n)for(let w=e;w<r;w+=n){let T=(C*c+w)*4,R=s[T],_=s[T+1],A=s[T+2],X=s[T+3];m.push({r:R,g:_,b:A,a:X}),y+=R,g+=_,f+=A,x+=X}if(m.length===0)return{r:128,g:128,b:128,a:255};let E=m.length,I=Math.round(y/E),p=Math.round(g/E),M=Math.round(f/E),v=Math.round(x/E);if(l<.01)return{r:I,g:p,b:M,a:v};m.sort((C,w)=>C.r+C.g+C.b-(w.r+w.g+w.b));let S=m[Math.floor(E/2)],b=l;return{r:Math.round(I*(1-b)+S.r*b),g:Math.round(p*(1-b)+S.g*b),b:Math.round(M*(1-b)+S.b*b),a:Math.round(v*(1-b)+S.a*b)}}function Lt(t,e,o=null,r=.8,a=!1,l=2,s=.3){let{width:c,height:u}=e,{cols:i,rows:d}=t,n=c/i,m=u/d,y=[];for(let g=0;g<d;g++)for(let f=0;f<i;f++){let x=f*n,E=g*m,I=(f+1)*n,p=(g+1)*m;y.push(oe(e,x,E,I,p,r))}return ne(t,e,y)}function xt(t,e,o){let r=document.createElement("canvas");r.width=e,r.height=o;let a=r.getContext("2d"),l=a.createImageData(e,o),s=l.data;if(t.length!==e*o){console.warn(`Edge map size mismatch: expected ${e*o}, got ${t.length}`);for(let i=0;i<s.length;i+=4)s[i]=255,s[i+1]=0,s[i+2]=0,s[i+3]=255;return a.putImageData(l,0,0),r}let c=!1,u=0;for(let i=0;i<t.length;i++)t[i]>0&&(c=!0,u=Math.max(u,t[i]));if(c)for(let i=0;i<t.length;i++){let d=t[i],n=i*4;if(d>0){let m=Math.round(d*255);s[n]=m,s[n+1]=m,s[n+2]=m}else s[n]=0,s[n+1]=0,s[n+2]=0;s[n+3]=255}else for(let i=0;i<s.length;i+=4)s[i]=32,s[i+1]=32,s[i+2]=32,s[i+3]=255;return a.putImageData(l,0,0),r}function Gt(t){let{width:e,height:o,data:r}=t,a=document.createElement("canvas");a.width=e,a.height=o;let l=a.getContext("2d"),s=l.createImageData(e,o),c=s.data;for(let u=0;u<r.length;u+=4){let i=Math.round(.299*r[u]+.587*r[u+1]+.114*r[u+2]);c[u]=i,c[u+1]=i,c[u+2]=i,c[u+3]=r[u+3]}return l.putImageData(s,0,0),a}function yt(t,e,o="rgba(255, 0, 0, 0.7)",r=1){let a=document.createElement("canvas");a.width=t.width,a.height=t.height;let l=a.getContext("2d");l.drawImage(t,0,0),l.strokeStyle=o,l.lineWidth=r,l.lineCap="round",l.lineJoin="round";let{corners:s}=e,c=s.length,u=s[0].length,i=t.width/(u-1),d=t.height/(c-1),n=Math.min(i,d),m=n<20?Math.ceil(20/n):1;for(let y=0;y<c;y+=m){l.beginPath(),l.moveTo(s[y][0].x,s[y][0].y);for(let g=1;g<u;g++)l.lineTo(s[y][g].x,s[y][g].y);l.stroke()}if(m>1&&c>1){let y=c-1;l.beginPath(),l.moveTo(s[y][0].x,s[y][0].y);for(let g=1;g<u;g++)l.lineTo(s[y][g].x,s[y][g].y);l.stroke()}for(let y=0;y<u;y+=m){l.beginPath(),l.moveTo(s[0][y].x,s[0][y].y);for(let g=1;g<c;g++)l.lineTo(s[g][y].x,s[g][y].y);l.stroke()}if(m>1&&u>1){let y=u-1;l.beginPath(),l.moveTo(s[0][y].x,s[0][y].y);for(let g=1;g<c;g++)l.lineTo(s[g][y].x,s[g][y].y);l.stroke()}return a}function tt(t){let e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e}function Ft(t,e,o={}){let{returnCanvas:r=!1,colorLimit:a=null,contrast:l=1}=o,s=t instanceof ImageData?t:Dt(t),c=me(t,e),u=c.scaledImageData;a&&a>0&&(u=Ut(u,a),c.scaledCanvas.getContext("2d").putImageData(u,0,0),c.scaledImageData=u);let i=fe(c);if(l!==1){let d=i.getContext("2d").getImageData(0,0,i.width,i.height);d=Xt(d,l),i.getContext("2d").putImageData(d,0,0)}return r?i:i.getContext("2d").getImageData(0,0,i.width,i.height)}function ae(t,e,o,r){let{width:a,height:l,data:s}=t,c=new ImageData(a,l),u=c.data;for(let i=0;i<l;i+=o)for(let d=0;d<a;d+=o){let n=Math.min(d+o,a),m=Math.min(i+o,l),y=[],g=!1,f=0;for(let E=i;E<m;E++)for(let I=d;I<n;I++){let p=(E*a+I)*4;y.push({r:s[p],g:s[p+1],b:s[p+2],a:s[p+3]});let M=E*a+I;e[M]>0&&(g=!0,f=Math.max(f,e[M]))}let x;if(g&&r>0){let E=re(y);if(r>=1)x=E;else{let I=Nt(y),p=r*f;x={r:Math.round(I.r*(1-p)+E.r*p),g:Math.round(I.g*(1-p)+E.g*p),b:Math.round(I.b*(1-p)+E.b*p),a:Math.round(I.a*(1-p)+E.a*p)}}}else x=Nt(y);for(let E=i;E<m;E++)for(let I=d;I<n;I++){let p=(E*a+I)*4;u[p]=x.r,u[p+1]=x.g,u[p+2]=x.b,u[p+3]=x.a}}return c}function Nt(t){let e=0,o=0,r=0,a=0;for(let s of t)e+=s.r,o+=s.g,r+=s.b,a+=s.a;let l=t.length;return{r:Math.round(e/l),g:Math.round(o/l),b:Math.round(r/l),a:Math.round(a/l)}}function re(t){if(t.length===0)return{r:0,g:0,b:0,a:255};if(t.length===1)return t[0];let e=[...t].sort((o,r)=>{let a=.299*o.r+.587*o.g+.114*o.b,l=.299*r.r+.587*r.g+.114*r.b;return a-l});return e[Math.floor(e.length/2)]}function se(t,e){let o=new Uint8ClampedArray(t.data),r=t.width,a=t.height,l=Math.max(1,Math.floor(Math.sqrt(r*a)/100)),s=[];for(let d=0;d<o.length;d+=4*l){let n=o[d],m=o[d+1],y=o[d+2];s.push({r:n,g:m,b:y})}let c=[];if(s.length<=e){let d=new Map;for(let n of s){let m=`${n.r},${n.g},${n.b}`;if(!d.has(m)&&(d.set(m,n),d.size>=e))break}c.push(...Array.from(d.values()))}else{let d=new Map;for(let m of s){let y=`${m.r},${m.g},${m.b}`;d.set(y,(d.get(y)||0)+1)}let n=Array.from(d.entries()).sort((m,y)=>y[1]-m[1]).map(([m])=>{let[y,g,f]=m.split(",").map(Number);return{r:y,g,b:f}});for(c.push(n[0]);c.length<e&&c.length<n.length;){let m=-1,y=null;for(let g of n){if(c.some(x=>x.r===g.r&&x.g===g.g&&x.b===g.b))continue;let f=1/0;for(let x of c){let E=Math.sqrt(Math.pow(g.r-x.r,2)+Math.pow(g.g-x.g,2)+Math.pow(g.b-x.b,2));E<f&&(f=E)}f>m&&(m=f,y=g)}if(y)c.push(y);else{for(let g of n){if(c.length>=e)break;c.some(f=>f.r===g.r&&f.g===g.g&&f.b===g.b)||c.push(g)}break}}}c.length===0&&c.push({r:128,g:128,b:128});let u=new ImageData(r,a),i=u.data;for(let d=0;d<o.length;d+=4){let n=o[d],m=o[d+1],y=o[d+2],g=o[d+3],f=1/0,x=c[0];for(let E of c){let I=Math.sqrt(Math.pow(n-E.r,2)+Math.pow(m-E.g,2)+Math.pow(y-E.b,2));I<f&&(f=I,x=E)}i[d]=x.r,i[d+1]=x.g,i[d+2]=x.b,i[d+3]=g}return u}function ie(t,e){let o=t.data,r=new ImageData(t.width,t.height),a=r.data;for(let l=0;l<o.length;l+=4)a[l]=Math.max(0,Math.min(255,Math.round((o[l]-128)*e+128))),a[l+1]=Math.max(0,Math.min(255,Math.round((o[l+1]-128)*e+128))),a[l+2]=Math.max(0,Math.min(255,Math.round((o[l+2]-128)*e+128))),a[l+3]=o[l+3];return r}function Dt(t){if(t instanceof ImageData)return t;let e=document.createElement("canvas");if(t instanceof HTMLCanvasElement)e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement){let o=t.naturalWidth||t.width,r=t.naturalHeight||t.height;e.width=o,e.height=r,e.getContext("2d").drawImage(t,0,0)}else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");return e.getContext("2d").getImageData(0,0,e.width,e.height)}async function le(t,e={}){let{edgeSharpness:o=.8,onProgress:r=null}=e,{width:a,height:l}=t,s=null,c=!1;try{if(s=bt(t,{edgeSharpness:o}),c=s!==null,s)if(s.length!==a*l)console.warn("WebGL edge map size mismatch, falling back to CPU"),s=null,c=!1;else{let u=0,i=Math.min(1e4,s.length),d=Math.max(1,Math.floor(s.length/i));for(let n=0;n<s.length;n+=d)s[n]>0&&u++;if(u===0&&i>100){console.warn("WebGL edge map has no edges in sample, trying CPU");let n=st(t,{edgeSharpness:o}),m=0,y=Math.max(1,Math.floor(n.length/i));for(let g=0;g<n.length;g+=y)n[g]>0&&m++;m>0&&(s=n,c=!1)}}}catch(u){console.error("WebGL edge detection error:",u),s=null,c=!1}return s||(s=st(t,{edgeSharpness:o})),r&&r({usingGPU:c}),{edgeMap:s,usingGPU:c}}function ce(t,e){return Bt(t.width,t.height,e)}function ue(t,e={}){let{grid:o,edgeMap:r,imageData:a}=t,{searchSteps:l=9,numIterations:s=2,stepSize:c=1,edgeSharpness:u=.8,useSplines:i=!1,splineDegree:d=2,splineSmoothness:n=.3}=e;if(!o||!r||!a)throw new Error("optimizeGridStep requires grid, edgeMap, and imageData in context");let{width:m,height:y}=a,g=Math.max(l,Math.floor(9+u*16)),f=Math.max(s,Math.floor(2+u*3));return _t(o,r,m,y,{searchSteps:g,numIterations:f,stepSize:c||1,edgeSharpness:u,useSplines:i,splineDegree:d,splineSmoothness:n})}function de(t,e,o,r){return ae(t,e,o,r)}function Xt(t,e){return e===1?t:ie(t,e)}function Ut(t,e){return!e||e<=0?t:se(t,e)}function he(t,e=!1){if(!e)return t;let o=document.createElement("canvas");return o.width=t.width,o.height=t.height,o.getContext("2d").putImageData(t,0,0),o}function me(t,e){let o,r;if(t instanceof ImageData)o=t.width,r=t.height;else if(t instanceof HTMLCanvasElement)o=t.width,r=t.height;else if(t instanceof HTMLImageElement)o=t.naturalWidth||t.width,r=t.naturalHeight||t.height;else throw new Error("Unsupported image type. Use Image, Canvas, or ImageData.");let a=Math.max(1,Math.floor(o/e)),l=Math.max(1,Math.floor(r/e)),s=document.createElement("canvas");s.width=a,s.height=l;let c=s.getContext("2d");if(c.imageSmoothingEnabled=!1,t instanceof ImageData){let i=document.createElement("canvas");i.width=o,i.height=r,i.getContext("2d").putImageData(t,0,0),c.drawImage(i,0,0,a,l)}else c.drawImage(t,0,0,a,l);return{scaledImageData:c.getImageData(0,0,a,l),originalSize:{width:o,height:r},scaledCanvas:s}}function fe(t){let{scaledImageData:e,originalSize:o,scaledCanvas:r}=t;if(!e||!o||!r)throw new Error("upscaleImageStep requires scaledImageData, originalSize, and scaledCanvas from downscaleImageStep");let a=document.createElement("canvas");a.width=o.width,a.height=o.height;let l=a.getContext("2d");return l.imageSmoothingEnabled=!1,l.drawImage(r,0,0,o.width,o.height),a}async function zt(t,e,o={}){let{returnCanvas:r=!1,searchSteps:a=9,numIterations:l=2,onProgress:s=null,colorLimit:c=null,contrast:u=1,edgeSharpness:i=.8,captureIntermediates:d=!1,useSplines:n=!1,splineDegree:m=2,splineSmoothness:y=.3}=o,g=d?[]:null,f=Dt(t),{width:x,height:E}=f;d&&g.push({name:"Original",canvas:tt(f)});let I=await le(f,{edgeSharpness:i,onProgress:s}),{edgeMap:p,usingGPU:M}=I,v=null;if(d){let H=function(W,Y,q,Z,O){let $=xt(W,Y,q),z=document.createElement("canvas");z.width=Z,z.height=O;let Q=z.getContext("2d");return Q.imageSmoothingEnabled=!1,Q.drawImage($,0,0,Y,q,0,0,Z,O),z};g.push({name:"Grayscale",canvas:Gt(f)});let B=Math.min(1,800/Math.max(x,E)),N=Math.round(x*B),F=Math.round(E*B),k=f;if(B<1){let W=document.createElement("canvas");W.width=N,W.height=F;let Y=W.getContext("2d"),q=tt(f);Y.drawImage(q,0,0,N,F),k=Y.getImageData(0,0,N,F)}let V=st(k,{edgeSharpness:i,captureIntermediates:!0});if(g.push({name:"Gradient Magnitude",canvas:H(V.intermediates.magnitude,N,F,x,E)}),g.push({name:"After NMS",canvas:H(V.intermediates.afterNMS,N,F,x,E)}),p&&p.length===x*E){let W=0;for(let Y=0;Y<p.length;Y++)p[Y]>0&&W++;W>0?(v=xt(p,x,E),g.push({name:"Edge Map",canvas:v})):(console.warn("Full-res edge map has no edges, using downscaled version for visualization"),v=H(V.intermediates.afterThreshold,N,F,x,E),g.push({name:"Edge Map",canvas:v}))}else console.warn("Full-res edge map invalid, using downscaled version for visualization"),v=H(V.intermediates.afterThreshold,N,F,x,E),g.push({name:"Edge Map",canvas:v})}let S=ce(f,e),b=0;for(let P=0;P<p.length;P++)p[P]>0&&b++;let C=(b/p.length*100).toFixed(2);if(d){let P=tt(f);g.push({name:"Initial Grid",canvas:yt(P,S,"rgba(255, 0, 0, 1.0)",2)})}let w=.5+i*1.5,T=Math.max(1,e*.3*w),R=Math.max(a,Math.floor(9+i*16)),_=Math.max(l,Math.floor(2+i*3)),A=null;d&&(A={corners:S.corners.map(P=>P.map(B=>({x:B.x,y:B.y})))}),b===0&&console.warn("Edge map has no edges - grid optimization will have no effect");let X=d?Math.max(T,e*.5):T,j=d?Math.max(R,25):R,U=d?Math.max(_,4):_;if(ue({grid:S,edgeMap:p,imageData:f},{searchSteps:j,numIterations:U,stepSize:X,edgeSharpness:i,useSplines:n,splineDegree:m,splineSmoothness:y}),d){let P=S.corners.length,B=S.corners[0].length,N=Math.ceil(e);if(b>0)for(let F=1;F<P-1;F++)for(let k=1;k<B-1;k++){let V=S.corners[F][k],H=Math.floor(V.x),W=Math.floor(V.y),Y=0,q=0,Z=1/0;for(let O=1;O<=N;O++)for(let $=-O;$<=O;$++)for(let z=-O;z<=O;z++){let Q=H+z,dt=W+$;if(Q>=0&&Q<x&&dt>=0&&dt<E){let Qt=dt*x+Q;if(p[Qt]>0){let It=Math.sqrt(z*z+$*$);It<Z&&(Z=It,Y=z,q=$)}}}Z<1/0&&Z>0&&(V.x=H+Y,V.y=W+q)}}if(d){let P=tt(f);g.push({name:"Optimized Grid",canvas:yt(P,S,"rgba(0, 255, 0, 1.0)",2)})}s&&s({usingGPU:M});let L;n?L=Lt(S,f,p,i,n,m,y):L=de(f,p,e,i),L=Xt(L,u),L=Ut(L,c);let D=he(L,!0);return D._usingGPU=M,d?(g.push({name:"Final Result",canvas:D}),{canvas:D,intermediates:g,usingGPU:M}):r?D:L}function Yt(t){return new Promise((e,o)=>{let r=new Image;if(r.onload=()=>e(r),r.onerror=()=>o(new Error("Failed to load image")),t instanceof File){let a=new FileReader;a.onload=l=>{r.src=l.target.result},a.onerror=()=>o(new Error("Failed to read file")),a.readAsDataURL(t)}else r.src=t})}function vt(t,e,o={}){let{interpolation:r="nearest",fillMode:a="constant",fillValue:l=0,returnCanvas:s=!1}=o;if(e.length!==8)throw new Error("Transform matrix must have 8 elements [a1, a2, a3, b1, b2, b3, c1, c2]");let[c,u,i,d,n,m,y,g]=e,f,x,E;if(t instanceof ImageData)f=t.width,x=t.height,E=t.data;else{let S=document.createElement("canvas");if(t instanceof HTMLCanvasElement)S.width=t.width,S.height=t.height,S.getContext("2d").drawImage(t,0,0);else if(t instanceof HTMLImageElement)S.width=t.naturalWidth||t.width,S.height=t.naturalHeight||t.height,S.getContext("2d").drawImage(t,0,0);else throw new Error("Unsupported image type");f=S.width,x=S.height,E=S.getContext("2d").getImageData(0,0,f,x).data}let I=document.createElement("canvas");I.width=f,I.height=x;let p=I.getContext("2d"),M=p.createImageData(f,x),v=M.data;for(let S=0;S<x;S++)for(let b=0;b<f;b++){let C=b,w=S,T=y*C+g*w+1;if(Math.abs(T)<1e-4){let B=(S*f+b)*4;v[B]=l,v[B+1]=l,v[B+2]=l,v[B+3]=255;continue}let R=(c*C+u*w+i)/T,_=(d*C+n*w+m)/T,A=kt(R,f,a),X=kt(_,x,a),j,U,L,D;if(r==="nearest"){let B=Math.round(A),N=Math.round(X),F=et(E,B,N,f,x,l);j=F.r,U=F.g,L=F.b,D=F.a}else{let B=Math.floor(A),N=Math.floor(X),F=B+1,k=N+1,V=et(E,B,N,f,x,l),H=et(E,F,N,f,x,l),W=et(E,B,k,f,x,l),Y=et(E,F,k,f,x,l),q=A-B,Z=X-N,O=Mt(V,H,q),$=Mt(W,Y,q),z=Mt(O,$,Z);j=z.r,U=z.g,L=z.b,D=z.a}let P=(S*f+b)*4;v[P]=j,v[P+1]=U,v[P+2]=L,v[P+3]=D}return p.putImageData(M,0,0),s?I:M}function kt(t,e,o){if(o==="constant")return t;if(o==="reflect"){if(t<0){if(e<=1)return 0;let r=2*e;t<-r&&(t=t+r*Math.floor(-t/r)),t=t<-e?t+r:-t-1}else if(t>e-1){if(e<=1)return 0;let r=2*e;t=t-r*Math.floor(t/r),t>=e&&(t=r-t-1)}return Math.max(0,Math.min(e-1,t))}else if(o==="wrap"){if(t<0){if(e<=1)return 0;let r=e-1;t=t+e*(Math.floor(-t/r)+1)}else if(t>e-1){if(e<=1)return 0;let r=e-1;t=t-e*Math.floor(t/r)}return Math.max(0,Math.min(e-1,t))}else if(o==="nearest")return Math.max(0,Math.min(e-1,t));return t}function et(t,e,o,r,a,l){if(e>=0&&e<r&&o>=0&&o<a){let s=(o*r+e)*4;return{r:t[s],g:t[s+1],b:t[s+2],a:t[s+3]}}else return{r:l,g:l,b:l,a:255}}function Mt(t,e,o){return{r:Math.round(t.r+(e.r-t.r)*o),g:Math.round(t.g+(e.g-t.g)*o),b:Math.round(t.b+(e.b-t.b)*o),a:Math.round(t.a+(e.a-t.a)*o)}}function Vt(t,e,o){let r=Math.cos(t),a=Math.sin(t),l=e-e*r+o*a,s=o-e*a-o*r;return[r,-a,l,a,r,s,0,0]}function Wt(t,e,o,r){return[t,0,o*(1-t),0,e,r*(1-e),0,0]}var h={imageInput:document.getElementById("imageInput"),pixelSizeSlider:document.getElementById("pixelSize"),pixelSizeNumber:document.getElementById("pixelSizeNumber"),pixelSizeValue:document.getElementById("pixelSizeValue"),colorLimitSlider:document.getElementById("colorLimit"),colorLimitNumber:document.getElementById("colorLimitNumber"),colorLimitValue:document.getElementById("colorLimitValue"),colorLimitGroup:document.getElementById("colorLimitGroup"),useColorLimit:document.getElementById("useColorLimit"),useEdgeAware:document.getElementById("useEdgeAware"),gpuIndicator:document.getElementById("gpuIndicator"),gpuStatus:document.getElementById("gpuStatus"),edgeSharpnessGroup:document.getElementById("edgeSharpnessGroup"),edgeSharpnessSlider:document.getElementById("edgeSharpness"),edgeSharpnessNumber:document.getElementById("edgeSharpnessNumber"),edgeSharpnessValue:document.getElementById("edgeSharpnessValue"),gridResolutionGroup:document.getElementById("gridResolutionGroup"),gridResolutionSlider:document.getElementById("gridResolution"),gridResolutionNumber:document.getElementById("gridResolutionNumber"),gridResolutionValue:document.getElementById("gridResolutionValue"),currentGridResolution:document.getElementById("currentGridResolution"),numPassesGroup:document.getElementById("numPassesGroup"),numPassesSlider:document.getElementById("numPasses"),numPassesNumber:document.getElementById("numPassesNumber"),numPassesValue:document.getElementById("numPassesValue"),showStepsGroup:document.getElementById("showStepsGroup"),showAlgorithmSteps:document.getElementById("showAlgorithmSteps"),useSplinesGroup:document.getElementById("useSplinesGroup"),useSplines:document.getElementById("useSplines"),splineSmoothnessGroup:document.getElementById("splineSmoothnessGroup"),splineSmoothnessSlider:document.getElementById("splineSmoothness"),splineSmoothnessNumber:document.getElementById("splineSmoothnessNumber"),splineSmoothnessValue:document.getElementById("splineSmoothnessValue"),stepNavigation:document.getElementById("stepNavigation"),stepLabel:document.getElementById("stepLabel"),stepCounter:document.getElementById("stepCounter"),stepPrev:document.getElementById("stepPrev"),stepNext:document.getElementById("stepNext"),contrastGroup:document.getElementById("contrastGroup"),contrastSlider:document.getElementById("contrast"),contrastNumber:document.getElementById("contrastNumber"),contrastValue:document.getElementById("contrastValue"),useProjection:document.getElementById("useProjection"),rotationGroup:document.getElementById("rotationGroup"),rotationAngleSlider:document.getElementById("rotationAngle"),rotationAngleNumber:document.getElementById("rotationAngleNumber"),rotationAngleValue:document.getElementById("rotationAngleValue"),useScaling:document.getElementById("useScaling"),scalingGroup:document.getElementById("scalingGroup"),scalingGroupY:document.getElementById("scalingGroupY"),scaleXSlider:document.getElementById("scaleX"),scaleXNumber:document.getElementById("scaleXNumber"),scaleXValue:document.getElementById("scaleXValue"),scaleYSlider:document.getElementById("scaleY"),scaleYNumber:document.getElementById("scaleYNumber"),scaleYValue:document.getElementById("scaleYValue"),pixelateBtn:document.getElementById("pixelateBtn"),mainCanvas:document.getElementById("mainCanvas"),canvasTitle:document.getElementById("canvasTitle")},G={intermediates:[],currentStep:0},ot=h.mainCanvas.getContext("2d"),K=null,nt=null;function ct(t,e,o,r,a,l){let s=()=>{let u=t.value;e.value=u,o.textContent=u},c=u=>{let i=Math.max(r,Math.min(a,parseInt(u.target.value)||l));t.value=i,e.value=i,o.textContent=i};t.addEventListener("input",s),e.addEventListener("input",c),s()}ct(h.colorLimitSlider,h.colorLimitNumber,h.colorLimitValue,2,256,32);ct(h.numPassesSlider,h.numPassesNumber,h.numPassesValue,1,10,3);function rt(t,e,o,r,a,l){let s=()=>{let u=parseFloat(t.value);e.value=u.toFixed(1),o.textContent=u.toFixed(1)},c=u=>{let i=Math.max(r,Math.min(a,parseFloat(u.target.value)||l));t.value=i,e.value=i.toFixed(1),o.textContent=i.toFixed(1)};t.addEventListener("input",s),e.addEventListener("input",c),s()}rt(h.edgeSharpnessSlider,h.edgeSharpnessNumber,h.edgeSharpnessValue,0,1,.8);rt(h.contrastSlider,h.contrastNumber,h.contrastValue,.5,2,1);ct(h.rotationAngleSlider,h.rotationAngleNumber,h.rotationAngleValue,0,360,0);rt(h.scaleXSlider,h.scaleXNumber,h.scaleXValue,.1,3,1);rt(h.scaleYSlider,h.scaleYNumber,h.scaleYValue,.1,3,1);rt(h.splineSmoothnessSlider,h.splineSmoothnessNumber,h.splineSmoothnessValue,0,1,.3);var Et=!1,St=!1;function at(){if(!K){h.currentGridResolution.textContent="-";return}let t=parseInt(h.pixelSizeSlider.value),e=Math.ceil(K.width/t),o=Math.ceil(K.height/t);if(h.currentGridResolution.textContent=`${e} \xD7 ${o}`,!St){Et=!0;let r=Math.round((e+o)/2),a=Math.max(10,Math.min(500,r));h.gridResolutionSlider.value=a,h.gridResolutionNumber.value=a,h.gridResolutionValue.textContent=a,Et=!1}}function Ht(){if(!K||Et)return;St=!0;let t=parseInt(h.gridResolutionSlider.value),e=Math.max(K.width,K.height),o=Math.max(2,Math.ceil(e/t)),r=Math.max(2,Math.min(128,o));h.pixelSizeSlider.value=r,h.pixelSizeNumber.value=r,h.pixelSizeValue.textContent=r,at(),St=!1}ct(h.gridResolutionSlider,h.gridResolutionNumber,h.gridResolutionValue,10,500,100);(function(){let t=()=>{let o=h.pixelSizeSlider.value;h.pixelSizeNumber.value=o,h.pixelSizeValue.textContent=o,at()},e=o=>{let r=Math.max(2,Math.min(128,parseInt(o.target.value)||3));h.pixelSizeSlider.value=r,h.pixelSizeNumber.value=r,h.pixelSizeValue.textContent=r,at()};h.pixelSizeSlider.addEventListener("input",t),h.pixelSizeNumber.addEventListener("input",e),t()})();h.gridResolutionSlider.addEventListener("input",()=>{let t=parseInt(h.gridResolutionSlider.value);h.gridResolutionNumber.value=t,h.gridResolutionValue.textContent=t,Ht()});h.gridResolutionNumber.addEventListener("input",()=>{let t=Math.max(10,Math.min(500,parseInt(h.gridResolutionNumber.value)||100));h.gridResolutionSlider.value=t,h.gridResolutionValue.textContent=t,Ht()});function Ot(){let t=h.useSplines.checked;h.splineSmoothnessGroup.style.display=t?"flex":"none"}function jt(){let t=h.useEdgeAware.checked;h.edgeSharpnessGroup.style.display=t?"flex":"none",h.gridResolutionGroup.style.display=t?"flex":"none",h.numPassesGroup.style.display=t?"flex":"none",h.showStepsGroup.style.display=t?"flex":"none",h.useSplinesGroup.style.display=t?"flex":"none",h.gpuIndicator.style.display=t?"block":"none",t||(h.gpuStatus.textContent="",h.stepNavigation.classList.remove("active"),G.intermediates=[]),Ot(),at()}function qt(){let t=h.useColorLimit.checked;h.colorLimitGroup.style.display=t?"flex":"none"}function $t(){let t=h.useProjection.checked;h.rotationGroup.style.display=t?"flex":"none"}function Kt(){let t=h.useScaling.checked;h.scalingGroup.style.display=t?"flex":"none",h.scalingGroupY.style.display=t?"flex":"none"}function lt(t){let e=t,o=t.width/2,r=t.height/2;if(h.useScaling.checked){let a=parseFloat(h.scaleXSlider.value),l=parseFloat(h.scaleYSlider.value),s=Wt(a,l,o,r);e=vt(e,s,{returnCanvas:!0,interpolation:"nearest"})}if(h.useProjection.checked){let a=parseFloat(h.rotationAngleSlider.value)*Math.PI/180,l=Vt(a,o,r);e=vt(e,l,{returnCanvas:!0,interpolation:"nearest"})}return e}function ut(t){if(!G.intermediates.length)return;G.currentStep=Math.max(0,Math.min(t,G.intermediates.length-1));let e=G.intermediates[G.currentStep],o=e.canvas;if(e.name==="Final Result"){let r=e.originalCanvas||e.canvas;o=lt(r)}h.mainCanvas.width=o.width,h.mainCanvas.height=o.height,ot.drawImage(o,0,0),h.canvasTitle.textContent=e.name,h.stepLabel.textContent=e.name,h.stepCounter.textContent=`Step ${G.currentStep+1} of ${G.intermediates.length}`}function Zt(){if(!G.intermediates.length)return;let t=(G.currentStep+1)%G.intermediates.length;ut(t)}function Jt(){if(!G.intermediates.length)return;let t=(G.currentStep-1+G.intermediates.length)%G.intermediates.length;ut(t)}function ge(t){G.intermediates=t,G.currentStep=t.length-1,h.stepNavigation.classList.add("active"),ut(G.currentStep)}h.stepPrev.addEventListener("click",Jt);h.stepNext.addEventListener("click",Zt);document.addEventListener("keydown",t=>{G.intermediates.length!==0&&(t.key==="ArrowLeft"?Jt():t.key==="ArrowRight"&&Zt())});qt();jt();$t();Kt();h.useColorLimit.addEventListener("change",qt);h.useEdgeAware.addEventListener("change",jt);h.useSplines.addEventListener("change",Ot);h.useProjection.addEventListener("change",$t);h.useScaling.addEventListener("change",Kt);h.imageInput.addEventListener("change",async t=>{let e=t.target.files[0];if(!e){h.pixelateBtn.disabled=!0;return}try{h.pixelateBtn.disabled=!0,h.pixelateBtn.textContent="Loading...";let o=await Yt(e);K=o,h.mainCanvas.width=o.width,h.mainCanvas.height=o.height,ot.drawImage(o,0,0),h.canvasTitle.textContent="Original Image",h.stepNavigation.classList.remove("active"),G.intermediates=[],at(),h.pixelateBtn.disabled=!1,h.pixelateBtn.textContent="Pixelate Image"}catch(o){alert("Failed to load image: "+o.message),h.pixelateBtn.disabled=!0,h.pixelateBtn.textContent="Pixelate Image"}});h.pixelateBtn.addEventListener("click",async()=>{if(h.pixelateBtn.disabled)return;if(h.pixelateBtn.disabled=!0,!K){alert("Please upload an image first."),h.pixelateBtn.disabled=!1;return}let t=parseInt(h.pixelSizeSlider.value),e=h.useColorLimit.checked?parseInt(h.colorLimitSlider.value):null,o=h.useEdgeAware.checked;try{h.pixelateBtn.textContent=o?"Processing (Edge-Aware)...":"Processing...",await new Promise(a=>setTimeout(a,0));let r;if(o){let a=parseFloat(h.contrastSlider.value),l=parseFloat(h.edgeSharpnessSlider.value),s=parseInt(h.numPassesSlider.value),c=h.showAlgorithmSteps.checked;h.gpuStatus.textContent="Processing...";let u=h.useSplines.checked,i=parseFloat(h.splineSmoothnessSlider.value),d=await zt(K,t,{returnCanvas:!0,searchSteps:9,numIterations:s,colorLimit:e,contrast:a,edgeSharpness:l,useSplines:u,splineDegree:2,splineSmoothness:i,captureIntermediates:c,onProgress:n=>{n.usingGPU?(h.gpuStatus.textContent="\u2713 Using GPU acceleration",h.gpuStatus.style.color="#4caf50"):(h.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",h.gpuStatus.style.color="#ff9800")}});if(c&&d.intermediates){if(r=d.canvas,d.intermediates.length>0){let n=d.intermediates[d.intermediates.length-1];n.name==="Final Result"&&(n.originalCanvas=n.canvas)}ge(d.intermediates),d.usingGPU?(h.gpuStatus.textContent="\u2713 Using GPU acceleration",h.gpuStatus.style.color="#4caf50"):(h.gpuStatus.textContent="\u26A0 Using CPU (for visualization)",h.gpuStatus.style.color="#ff9800")}else{r=d,nt=r,h.stepNavigation.classList.remove("active"),G.intermediates=[];let n=lt(r);h.mainCanvas.width=n.width,h.mainCanvas.height=n.height,ot.drawImage(n,0,0),h.canvasTitle.textContent="Pixelated Image",d._usingGPU!==void 0&&(d._usingGPU?(h.gpuStatus.textContent="\u2713 Using GPU acceleration",h.gpuStatus.style.color="#4caf50"):(h.gpuStatus.textContent="\u26A0 Using CPU (GPU not available)",h.gpuStatus.style.color="#ff9800"))}}else{let a=parseFloat(h.contrastSlider.value);await new Promise(s=>requestAnimationFrame(s)),r=Ft(K,t,{returnCanvas:!0,colorLimit:e,contrast:a}),h.stepNavigation.classList.remove("active"),G.intermediates=[],nt=r;let l=lt(r);h.mainCanvas.width=l.width,h.mainCanvas.height=l.height,ot.drawImage(l,0,0),h.canvasTitle.textContent="Pixelated Image"}h.pixelateBtn.disabled=!1,h.pixelateBtn.textContent="Pixelate Image"}catch(r){alert("Failed to pixelate image: "+r.message),h.pixelateBtn.disabled=!1,h.pixelateBtn.textContent="Pixelate Image"}});function J(){if(!(!nt&&!G.intermediates.length)){if(G.intermediates.length>0)ut(G.currentStep);else if(nt){let t=lt(nt);h.mainCanvas.width=t.width,h.mainCanvas.height=t.height,ot.drawImage(t,0,0)}}}h.rotationAngleSlider.addEventListener("input",J);h.rotationAngleNumber.addEventListener("input",J);h.useProjection.addEventListener("change",J);h.scaleXSlider.addEventListener("input",J);h.scaleXNumber.addEventListener("input",J);h.scaleYSlider.addEventListener("input",J);h.scaleYNumber.addEventListener("input",J);h.useScaling.addEventListener("change",J);</script></body></html>