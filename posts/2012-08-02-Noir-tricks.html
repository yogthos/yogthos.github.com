<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="me" href="https://mastodon.social/@yogthos">
    <link rel="me" href="https://mas.to/@yogthos">
    <link rel="me" href="https://social.marxist.network/@yogthos">
    <title>(iterate think thoughts): Noir tricks</title>
    <meta name="description" content="Dmitri&#39;s blog about programming, Clojure, and software development">
    <meta name="keywords" content="">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link href="/css/site.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)" id="hljs-light">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tomorrow-night.min.css" media="(prefers-color-scheme: dark)" id="hljs-dark">
    <script>
    (function(){var t=localStorage.getItem('theme');if(t){document.documentElement.setAttribute('data-theme',t);var l=document.getElementById('hljs-light'),d=document.getElementById('hljs-dark');if(l&&d){if(t==='dark'){l.media='not all';d.media='all'}else{l.media='all';d.media='not all'}}}})();
    </script>
</head>
<body>

<aside id="sidebar">

    <p id="logo">
        <a title="(iterate think thoughts)" href="/index.html">
            <span class="text"><span class="paren">(</span><span class="fn">iterate</span>
                <br>
                <span class="text">&nbsp;&nbsp;think</span>
                <br>
                <span class="text">&nbsp;&nbsp;thoughts<span class="paren">)</span>
            </span>
        </a>
    </p>

    <nav id="menucont" class="bodycontainer">
        <button class="menu-toggle" aria-label="Toggle menu">
            <span class="hamburger"></span>
            <span class="menu-label">Menu</span>
        </button>
        <ul class="menu">
            <li ><a title="Home" href="/index.html">Home</a></li>
            <li ><a title="Archives" href="/archives.html">Archives</a></li>
            
            <li ><a title="Tags" href="/tags.html">Tags</a></li>
            
            
            <li >
                <a href="/pages/about.html">About</a>
            </li>
            
            <li><a title="RSS" href="/feed.xml">RSS</a></li>
        </ul>
    </nav>

    <div class="theme-toggle-wrapper">
        <button class="theme-toggle" aria-label="Toggle dark mode">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></svg>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main id="content">
    
<div id="post">
    <article>
<div class="post-header">
    <div id="post-meta" class="row">
        <strong>August 2, 2012</strong>
        
    </div>
    <h1><a class="post-title" href="/posts/2012-08-02-Noir-tricks.html">Noir tricks</a></h1>
</div>
<div>
    
    <p>This blog is built on top of <a href='http://www.webnoir.org/'>Noir</a>, which is quite excellent for the most part. However, I did run into one problem which I spent a bit of time on. I'd like to share my workarounds to save others time.</p><p>First issue I noticed is that <code>response/redirect</code> doesn't respect the servlet context. This means that if you're not deploying your app to the root context, your redirects will not work properly. </p><p>After some digging and questions on the Google groups I found out that the offending function is <code>resolve-url</code> in <code>noir.options</code> namespace. When it builds the URL string it doesn't check for the context and as such the resulting URL ends up redirecting to the root of the app server regardless of what context the servlet was deployed at.</p><p>My workaround for this is a bit of a hack, and if anybody has a better solution I'd love to know, but it works well for most purposes. In my <code>server.clj</code> I added a new handler wrapper, which redefines the offending function with one that checks if the URL is relative and prepends the context to it as needed.<pre><code class="clojure">&#40;defn fix-base-url &#91;handler&#93;
  &#40;fn &#91;request&#93;
    &#40;with-redefs &#91;noir.options/resolve-url 
                  &#40;fn &#91;url&#93; 
                    ;prepend context to the relative URLs
                    &#40;if &#40;.contains url &quot;://&quot;&#41;
                      url &#40;str &#40;:context request&#41; url&#41;&#41;&#41;&#93;
      &#40;handler request&#41;&#41;&#41;&#41;
</code></pre></p><p>A related issue is that <code>pre-route</code> doesn't respect the context either. I decided to simply write a macro for defining private pages:<pre><code class="clojure">&#40;defmacro private-page &#91;path params &amp; content&#93;
  `&#40;noir.core/defpage 
     &#126;path 
     &#126;params 
     &#40;if &#40;session/get :admin&#41; 
       &#40;do &#126;@content&#41; &#40;resp/redirect &quot;/&quot;&#41;&#41;&#41;&#41;
</code></pre></p><p>An added advantage of the macro is that I don't have to remember to update <code>pre-routes</code> when I want to make a page private. </p><p>Also, there are a couple of things to be aware of if you wish to make a WAR. Make sure that all your views are required in your server namespace, <code>:gen-class</code> is set and that <code>server/load-views-ns</code> is used instead of <code>server/load-views</code>:<pre><code class="clojure">&#40;ns yuggoth.server
  &#40;:require 
   ...
   &#91;yuggoth.views archives auth blog comments common profile rss upload&#93;&#41;
   &#40;:gen-class&#41;&#41;

&#40;server/load-views-ns 'yuggoth.views&#41;
</code></pre></p><p>In your project.clj add the following:<pre><code class="clojure">:ring {:handler yuggoth.server/handler}
</code></pre></p><p>With the above in place you can build an uberwar with<pre><code class="bash">lein ring uberwar
</code></pre></p><p>The resulting WAR should deploy on any app server such as Tomcat or Glassfish without problems. Aside from the above quirks, I haven't run into any other issues with Noir, and I'm absolutely in love with it. </p>
</div>

<div id="post-tags">
    <br/>
    <b>Tags: </b>
    
    <a href="/clojure.html">clojure</a>
    
    <a href="/noir.html">noir</a>
    
</div>

<br/>
</article>

    <div id="prev-next">
        
        <a class="button" href="/posts/2012-08-04-Serving-RSS-with-Clojure.html">&laquo; Serving RSS with Clojure</a>
        
        
        <a class="right button" href="/posts/2012-07-31-open-access.html">open access &raquo;</a>
        
    </div>

    


</div>

    <hr/>
    <footer id="footercont">Copyright &copy; 2026 Dmitri Sotnikov
        <p>Powered by <a href="http://cryogenweb.org">Cryogen</a></p>
    </footer>
</main>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="/js/scripts.js" type="text/javascript"></script>


</body>
</html>
