<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="me" href="https://mastodon.social/@yogthos">
    <link rel="me" href="https://mas.to/@yogthos">
    <link rel="me" href="https://social.marxist.network/@yogthos">
    <title>(iterate think thoughts): Making Selmer User Friendly</title>
    <meta name="description" content="Dmitri&#39;s blog about programming, Clojure, and software development">
    <meta name="keywords" content="">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link href="/css/site.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)" id="hljs-light">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-eighties.min.css" media="(prefers-color-scheme: dark)" id="hljs-dark">
    <script>
    (function(){var t=localStorage.getItem('theme');if(t){document.documentElement.setAttribute('data-theme',t);var l=document.getElementById('hljs-light'),d=document.getElementById('hljs-dark');if(l&&d){if(t==='dark'){l.media='not all';d.media='all'}else{l.media='all';d.media='not all'}}}})();
    </script>
</head>
<body>

<aside id="sidebar">

    <p id="logo">
        <a title="(iterate think thoughts)" href="/index.html">
            <span class="text"><span class="paren">(</span><span class="fn">iterate</span>
                <br>
                <span class="text">&nbsp;&nbsp;think</span>
                <br>
                <span class="text">&nbsp;&nbsp;thoughts<span class="paren">)</span>
            </span>
        </a>
    </p>

    <nav id="menucont" class="bodycontainer">
        <button class="menu-toggle" aria-label="Toggle menu">
            <span class="hamburger"></span>
            <span class="menu-label">Menu</span>
        </button>
        <ul class="menu">
            <li ><a title="Home" href="/index.html">Home</a></li>
            <li ><a title="Archives" href="/archives.html">Archives</a></li>
            
            <li ><a title="Tags" href="/tags.html">Tags</a></li>
            
            
            <li >
                <a href="/pages/about.html">About</a>
            </li>
            
            <li><a title="RSS" href="/feed.xml">RSS</a></li>
        </ul>
    </nav>

    <div class="theme-toggle-wrapper">
        <button class="theme-toggle" aria-label="Toggle dark mode">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></svg>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main id="content">
    
<div id="post">
    <article>
<div class="post-header">
    <div id="post-meta" class="row">
        <strong>November 21, 2013</strong>
        
    </div>
    <h1><a class="post-title" href="/posts/2013-11-21-Making-Selmer-User-Friendly.html">Making Selmer User Friendly</a></h1>
</div>
<div>
    
    <p>It's been nearly 5 month since Selmer was released. In that time many bugs have been squashed and lots of new features added. However, there is one aspect that remained shameful and that was error reporting.</p><p>When Selmer failed to parse a template it would often produce error messages that were less than useful. For example, given the following template:</p><pre><code class="xml">&lt;html&gt;
  &lt;body&gt;
    {% blok %}
    {% endblock %}
    &lt;h2&gt;Hello {{name}}&lt;/h2&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>we'd end up with the following error after trying to render it:</p><pre><code>Exception in thread &quot;main&quot; java.lang.Exception: unrecognized tag: :blok - did you forget to close a tag?
</code></pre><p>While the error indicated the name of the problem tag, it didn't say what template this tag originated from or on what line it appeared.</p><p>These types of errors can result in a lot of wasted time and frustration. It would be much better to provide a clear error that contains the actual offending tag along with the name of the template and the line number.</p><p>As of version <code>0.4.8</code>, Selmer has a validator that checks the following cases:</p><ul><li>can the tag be parsed successfully</li><li>is the filter found in the map of filters</li><li>does the tag contain a name</li><li>is the tag name found in the map of tags</li><li>if a tag is a block tag, is the corresponding closing tag found</li><li>is the tag a closing tag for an opening tag that's not present</li></ul><p>Here's the error returned by the validator when rendering the above template:</p><pre><code>Exception in thread &quot;main&quot; java.lang.Exception: Unrecognized tag: {% blok %} on line 3 for template file:/Users/Yogthos/selmer-test/resources/index.html
</code></pre><p>This gives us a lot more information as to what went wrong and where. This is a big improvement on the original error, however we still have an ugly stacktrace to look at to figure out what happened.</p><p>It would be even better to return a distinct validation error that could be intercepted by some middleware to produce a friendly error page.</p><p>This is precisely what Selmer does as of version <code>0.5.3</code>. The validator will now return <code>ex-info</code> with a key <code>:type</code> that's set to <code>:selmer-validation-error</code>.</p><p>It will also contain an error page template that can be rendered using the <code>ex-data</code> attached to the exception. We can now write a simple middleware function to catch these errors and render the error page:</p><pre><code class="clojure">&#40;defn template-error-page &#91;handler&#93;
  &#40;fn &#91;request&#93;
    &#40;try
      &#40;handler request&#41;
      &#40;catch clojure.lang.ExceptionInfo ex
        &#40;let &#91;{:keys &#91;type error-template&#93; :as data} &#40;ex-data ex&#41;&#93;
          &#40;if &#40;= :selmer-validation-error type&#41;
            {:status 500
             :body   &#40;selmer.parser/render error-template data&#41;}
            &#40;throw ex&#41;&#41;&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Using the above middleware, we'll see the following page whenever the parser fails to compile a template:</p><p><center> <img src="http://yogthos.net/files/selmererror.png" alt="Selmer error" /> </center></p><p>We can now immediately tell that an error occurred during the template compilation and see only the information pertaining to the nature of the error.</p><p>Of course, we wouldn't want to display this information when running in production. A simple solution would be to set a <code>dev</code> flag and check for it in our middleware.</p><p>This is precisely what the latest <a href='http://www.luminusweb.net/'>Luminus</a> template will do using the <a href='https://github.com/weavejester/environ'>environ</a> library. The <code>project.clj</code> now contains an <code>:env</code> key under the <code>:dev</code> profile with the <code>:selmer-dev</code> flag set to <code>true</code>:</p><pre><code class="clojure">:dev {:dependencies &#91;&#91;ring-mock &quot;0.1.5&quot;&#93;
                     &#91;ring/ring-devel &quot;1.2.1&quot;&#93;&#93;
      :env {:selmer-dev true}}}
</code></pre><p>The middleware will check that the key is present and only render the error page in development mode:</p><pre><code class="clojure">&#40;defn template-error-page &#91;handler&#93;
  &#40;if &#40;env :selmer-dev&#41;
    &#40;fn &#91;request&#93;
      &#40;try
        &#40;handler request&#41;
        &#40;catch clojure.lang.ExceptionInfo ex
          &#40;let &#91;{:keys &#91;type error-template&#93; :as data} &#40;ex-data ex&#41;&#93;
            &#40;if &#40;= :selmer-validation-error type&#41;
              {:status 500
               :body &#40;parser/render error-template data&#41;}
              &#40;throw ex&#41;&#41;&#41;&#41;&#41;&#41;
    handler&#41;&#41;
</code></pre><p>When it comes to writing libraries it's easy to forget about the little things like error reporting and documentation. However, these things are just as important as having good code and a clean API. </p><p>In the end, this is what makes the difference between a pleasant development experience and one that's fraught with frustration.</p>
</div>

<div id="post-tags">
    <br/>
    <b>Tags: </b>
    
    <a href="/selmer.html">selmer</a>
    
    <a href="/clojure.html">clojure</a>
    
    <a href="/luminus.html">luminus</a>
    
</div>

<br/>
</article>

    <div id="prev-next">
        
        <a class="button" href="/posts/2013-12-09-Clojure-High-Performance-Programming-Review.html">&laquo; Clojure High Performance Programming Review</a>
        
        
        <a class="right button" href="/posts/2013-08-28-Web-Development-With-Clojure-Beta.html">Web Development With Clojure Beta &raquo;</a>
        
    </div>

    


</div>

    <hr/>
    <footer id="footercont">Copyright &copy; 2026 Dmitri Sotnikov
        <p>Powered by <a href="http://cryogenweb.org">Cryogen</a></p>
    </footer>
</main>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="/js/scripts.js" type="text/javascript"></script>


</body>
</html>
