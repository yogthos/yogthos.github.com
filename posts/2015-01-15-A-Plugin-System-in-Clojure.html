<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="me" href="https://mastodon.social/@yogthos">
    <link rel="me" href="https://mas.to/@yogthos">
    <link rel="me" href="https://social.marxist.network/@yogthos">
    <title>(iterate think thoughts): A simple plugin system in Clojure</title>
    <meta name="description" content="Dmitri&#39;s blog about programming, Clojure, and software development">
    <meta name="keywords" content="">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link href="/css/site.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)" id="hljs-light">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-eighties.min.css" media="(prefers-color-scheme: dark)" id="hljs-dark">
    <script>
    (function(){var t=localStorage.getItem('theme');if(t){document.documentElement.setAttribute('data-theme',t);var l=document.getElementById('hljs-light'),d=document.getElementById('hljs-dark');if(l&&d){if(t==='dark'){l.media='not all';d.media='all'}else{l.media='all';d.media='not all'}}}})();
    </script>
</head>
<body>

<aside id="sidebar">

    <p id="logo">
        <a title="(iterate think thoughts)" href="/index.html">
            <span class="text"><span class="paren">(</span><span class="fn">iterate</span>
                <br>
                <span class="text">&nbsp;&nbsp;think</span>
                <br>
                <span class="text">&nbsp;&nbsp;thoughts<span class="paren">)</span>
            </span>
        </a>
    </p>

    <nav id="menucont" class="bodycontainer">
        <button class="menu-toggle" aria-label="Toggle menu">
            <span class="hamburger"></span>
            <span class="menu-label">Menu</span>
        </button>
        <ul class="menu">
            <li ><a title="Home" href="/index.html">Home</a></li>
            <li ><a title="Archives" href="/archives.html">Archives</a></li>
            
            <li ><a title="Tags" href="/tags.html">Tags</a></li>
            
            
            <li >
                <a href="/pages/about.html">About</a>
            </li>
            
            <li><a title="RSS" href="/feed.xml">RSS</a></li>
        </ul>
    </nav>

    <div class="theme-toggle-wrapper">
        <button class="theme-toggle" aria-label="Toggle dark mode">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></svg>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main id="content">
    
<div id="post">
    <article>
<div class="post-header">
    <div id="post-meta" class="row">
        <strong>January 15, 2015</strong>
        
    </div>
    <h1><a class="post-title" href="/posts/2015-01-15-A-Plugin-System-in-Clojure.html">A simple plugin system in Clojure</a></h1>
</div>
<div>
    
    <p>In this post we’ll see how to create a simplistic plugin system where plugins can be supplied as Leiningen dependencies and automatically initialized without any additional code change in the application.</p><p>Let’s take a look at Cryogen for a concrete example of how this can be useful. Cryogen started out using Markdown for content encoding, and we recently got a pull request that adds <a href='https://github.com/cryogen-project/cryogen/pull/43'>AsciiDoc support</a>.</p><p>It’s always great to get additional features, but sometimes features also carry an undesirable cost. It turns out that AsciiDoc support relies on <a href='https://github.com/asciidoctor/asciidoctorj'>AsciidoctorJ</a>, that in turn relies on JRuby and pulls in a huge amount of additional dependencies. This has a significant impact on the startup time of the application.</p><p>For anybody who isn’t using AsciiDoc the new feature simply degrades the user experience. So, ideally we’d like to keep AsciiDoc as a feature, but also avoid impacting users who aren’t using it. The ideal scenario is to be able to split out the parsers into standalone libraries and include the ones we need. This also has the benefit of people being able to write their own custom plugins that add the features they need without having to update the core project.</p><p>The approach I took here was to create an <code>init</code> function for each plugin that will take care of any initialization that the plugin needs to do and register it with the system.</p><p>All the available parsers are stored in an atom called <code>markup-registry</code> in <a href='https://github.com/cryogen-project/cryogen-core'>cryogen-core</a>, and each plugin simply updates the registry when it loads:</p><pre><code class="clojure">&#40;defn init &#91;&#93;
  &#40;swap! markup-registry conj &#40;markdown&#41;&#41;&#41;
</code></pre><p>The full code for the Markdown plugin can be seen <a href='https://github.com/cryogen-project/cryogen-markdown/blob/master/src/cryogen_markdown/core.clj'>here</a>.</p><p>Next, we need to make our plugins discoverable so that they can be loaded when the application starts. This can be done using a configuration file that can be found on a classpath. Cryogen plugin configuration is stored in <code>resources/plugin.edn</code> using the following format:</p><pre><code class="clojure">{:description &quot;Markdown parser&quot;
 :init cryogen-markdown.core/init}
</code></pre><p>Using the above information we can load the appropriate namespace and run the initializer function for the plugin.</p><p>First, we need to grab all the resources with the name <code>plugin.edn</code> which can done as follows:</p><pre><code class="clojure">&#40;defn load-plugins &#91;&#93;
  &#40;let &#91;plugins &#40;.getResources &#40;ClassLoader/getSystemClassLoader&#41; &quot;plugin.edn&quot;&#41;&#93;
    &#40;loop &#91;&#93;
      &#40;load-plugin &#40;.. plugins nextElement openStream&#41;&#41;
      &#40;when &#40;.hasMoreElements plugins&#41;
        &#40;recur&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Next, we read the configuration for each resource, require its namespace and then run the initializer functions as seen below:</p><pre><code class="clojure">&#40;defn load-plugin &#91;url&#93;
  &#40;let &#91;{:keys &#91;description init&#93;} &#40;edn/read-string &#40;slurp url&#41;&#41;&#93;
    &#40;println &#40;green &#40;str &quot;loading module: &quot; description&#41;&#41;&#41;
    &#40;-&gt; init str &#40;s/split #&quot;/&quot;&#41; first symbol require&#41;
    &#40;&#40;resolve init&#41;&#41;&#41;&#41;
</code></pre><p>With that in place we simply run <code>load-plugins</code> when the applicatin starts and any plugins found on the classpath will be initialized. All the user has to do is select what plugins they want to include in their dependencies to get the functionality they need.</p>
</div>

<div id="post-tags">
    <br/>
    <b>Tags: </b>
    
    <a href="/cryogen.html">cryogen</a>
    
    <a href="/clojure.html">clojure</a>
    
</div>

<br/>
</article>

    <div id="prev-next">
        
        <a class="button" href="/posts/2015-02-28-Luminus-2.0.html">&laquo; Announcing Luminus 2.0</a>
        
        
        <a class="right button" href="/posts/2014-12-1-State-of-Reagent.html">The State of Reagent &raquo;</a>
        
    </div>

    


</div>

    <hr/>
    <footer id="footercont">Copyright &copy; 2026 Dmitri Sotnikov
        <p>Powered by <a href="http://cryogenweb.org">Cryogen</a></p>
    </footer>
</main>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="/js/scripts.js" type="text/javascript"></script>


</body>
</html>
