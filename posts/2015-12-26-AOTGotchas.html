<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="me" href="https://mastodon.social/@yogthos">
    <link rel="me" href="https://mas.to/@yogthos">
    <link rel="me" href="https://social.marxist.network/@yogthos">
    <title>(iterate think thoughts): Trouble with AOT</title>
    <meta name="description" content="Dmitri&#39;s blog about programming, Clojure, and software development">
    <meta name="keywords" content="">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link href="/css/site.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)" id="hljs-light">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-eighties.min.css" media="(prefers-color-scheme: dark)" id="hljs-dark">
    <script>
    (function(){var t=localStorage.getItem('theme');if(t){document.documentElement.setAttribute('data-theme',t);var l=document.getElementById('hljs-light'),d=document.getElementById('hljs-dark');if(l&&d){if(t==='dark'){l.media='not all';d.media='all'}else{l.media='all';d.media='not all'}}}})();
    </script>
</head>
<body>

<aside id="sidebar">

    <p id="logo">
        <a title="(iterate think thoughts)" href="/index.html">
            <span class="text"><span class="paren">(</span><span class="fn">iterate</span>
                <br>
                <span class="text">&nbsp;&nbsp;think</span>
                <br>
                <span class="text">&nbsp;&nbsp;thoughts<span class="paren">)</span>
            </span>
        </a>
    </p>

    <nav id="menucont" class="bodycontainer">
        <button class="menu-toggle" aria-label="Toggle menu">
            <span class="hamburger"></span>
            <span class="menu-label">Menu</span>
        </button>
        <ul class="menu">
            <li ><a title="Home" href="/index.html">Home</a></li>
            <li ><a title="Archives" href="/archives.html">Archives</a></li>
            
            <li ><a title="Tags" href="/tags.html">Tags</a></li>
            
            
            <li >
                <a href="/pages/about.html">About</a>
            </li>
            
            <li><a title="RSS" href="/feed.xml">RSS</a></li>
        </ul>
    </nav>

    <div class="theme-toggle-wrapper">
        <button class="theme-toggle" aria-label="Toggle dark mode">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></svg>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main id="content">
    
<div id="post">
    <article>
<div class="post-header">
    <div id="post-meta" class="row">
        <strong>December 26, 2015</strong>
        
    </div>
    <h1><a class="post-title" href="/posts/2015-12-26-AOTGotchas.html">Trouble with AOT</a></h1>
</div>
<div>
    
     <p>I recently ran into an interesting issue when I added the <a href='https://github.com/fzakaria/slf4j-timbre'>slf4j-timbre</a> dependency to a project. As soon as the dependency was added the project would fail to build and I'd see the following error:</p><pre><code>Caused by: java.io.FileNotFoundException: Could not locate clojure/tools/reader/impl/ExceptionInfo&#95;&#95;init.class or clojure/tools/reader/impl/ExceptionInfo.clj on classpath.
</code></pre><p>The <code>slf4j-timbre</code> library does not depend on <code>clojure.tools.reader</code>, and at first glance there's nothing in it that should've caused problems. I did notice that the library depends on <code>com.taoensso/timbre 4.1.4</code> that in turn depends on <code>com.taoensso/encore 2.18.0</code>, and it uses on an older version of <code>clojure.tools.reader</code>.</p><p>At this point I thought the solution would be simple. I'd just include the latest version of <code>encore</code> and everything should work fine. However that didn't turn out to be the case.</p><p>I decided to take another look at <code>slf4j-timbre</code> to see what else might be happening. At this point I noticed that it uses <code>:aot :all</code> in the project configuration. This causes the library to be compiled to Java classes as opposed to being distributed at source. This is necessary since the library has to implement the SLF4J interface and has to provide a Java class in its implementation.</p><p>When the namespace that references <code>Timbre</code> is compiled then any namespaces it depends on are also compiled and packaged in the <code>jar</code>. These compiled classes will take precedence over the source dependencies when the library is included in the project.</p><p>So, even though I was explicitly including the version of <code>encore</code> that uses the latest <code>clojure.tools.reader</code>, the compiled version packaged in <code>slf4j-timbre</code> would end up being used causing the exception above. As far as I can tell there's no way to overwrite these in the project configuration.</p><h3 id="implications&#95;for&#95;luminus">Implications for Luminus</h3><p>Unfortunately, Luminus dependencies require both a SLF4J compliant logger and the latest <code>clojure.tools.reader</code>. While I think <code>Timbre</code> is an excellent library, it's just not the right fit at the moment.</p><p>Luckily, <a href='https://github.com/clojure/tools.logging'>clojure.tools.logging</a> provides a SLF4J compliant API for Clojure logging. The latest release of Luminus uses <code>clojure.tools.logging</code> along with the <a href='https://logging.apache.org/log4j/2.x/'>log4j</a> library as the default logging implementation. It's a mature library that has excellent performance and provides a <a href='https://logging.apache.org/log4j/2.x/manual/appenders.html'>plethora of logging appenders</a>.</p><p>Since <code>log4j</code> can be configured using a properties file, it fits the Luminus approach of using 12 factor style configuration. The library will look for a file called <code>log4j.properties</code> on the classpath to get its default configuration. Luminus packages this file in the <code>resources</code> folder with the following configuration:</p><pre><code>### stdout appender
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.Target=System.out
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=&#91;%d&#93;&#91;%p&#93;&#91;%c&#93; %m%n

### rolling file appender
log4j.appender.R=org.apache.log4j.RollingFileAppender
log4j.appender.R.File=./log/app-name.log

log4j.appender.R.MaxFileSize=100KB
log4j.appender.R.MaxBackupIndex=20

log4j.appender.R.layout=org.apache.log4j.PatternLayout
log4j.appender.R.layout.ConversionPattern=&#91;%d&#93;&#91;%p&#93;&#91;%c&#93; %m%n

### root logger sets the minimum logging level
### and aggregates the appenders
log4j.rootLogger=DEBUG, stdout, R
</code></pre><p>As you can see the configuration is very straight forward, it's also <a href='https://logging.apache.org/log4j/2.x/manual/configuration.html#Properties'>well documented</a>. The default configuration can be overridden at runtime by setting the <code>:log-config</code> environment variable. You can now create a custom logging configuration on the target system and then set an environment variable to point to it as seen below:</p><pre><code>export LOG&#95;CONFIG=prod-log.properties
</code></pre><p>I think that the new approach provides a solid solution for most situations with minimal changes from the existing behavior.</p><h3 id="final&#95;thoughts">Final Thoughts</h3><p>The moral of the story is that you want to be very careful when using AOT in libraries. Whenever possible it is best to avoid it, and if you do have to use it then try to find the minimal subset of the namespaces that absolutely have to be compiled.</p>
</div>

<div id="post-tags">
    <br/>
    <b>Tags: </b>
    
    <a href="/clojure.html">clojure</a>
    
    <a href="/luminus.html">luminus</a>
    
</div>

<br/>
</article>

    <div id="prev-next">
        
        <a class="button" href="/posts/2016-01-01-ClojureWebDev2.html">&laquo; Web Development with Clojure 2nd Edition</a>
        
        
        <a class="right button" href="/posts/2015-12-05-LuminusComponents.html">Managing State in Luminus &raquo;</a>
        
    </div>

    


</div>

    <hr/>
    <footer id="footercont">Copyright &copy; 2026 Dmitri Sotnikov
        <p>Powered by <a href="http://cryogenweb.org">Cryogen</a></p>
    </footer>
</main>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="/js/scripts.js" type="text/javascript"></script>


</body>
</html>
