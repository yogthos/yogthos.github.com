<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="me" href="https://mastodon.social/@yogthos">
    <link rel="me" href="https://mas.to/@yogthos">
    <link rel="me" href="https://social.marxist.network/@yogthos">
    <title>(iterate think thoughts): Using nREPL as System Interface</title>
    <meta name="description" content="Dmitri&#39;s blog about programming, Clojure, and software development">
    <meta name="keywords" content="">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link href="/css/site.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)" id="hljs-light">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tomorrow-night.min.css" media="(prefers-color-scheme: dark)" id="hljs-dark">
    <script>
    (function(){var t=localStorage.getItem('theme');if(t){document.documentElement.setAttribute('data-theme',t);var l=document.getElementById('hljs-light'),d=document.getElementById('hljs-dark');if(l&&d){if(t==='dark'){l.media='not all';d.media='all'}else{l.media='all';d.media='not all'}}}})();
    </script>
</head>
<body>

<aside id="sidebar">

    <p id="logo">
        <a title="(iterate think thoughts)" href="/index.html">
            <span class="text"><span class="paren">(</span><span class="fn">iterate</span>
                <br>
                <span class="text">&nbsp;&nbsp;think</span>
                <br>
                <span class="text">&nbsp;&nbsp;thoughts<span class="paren">)</span>
            </span>
        </a>
    </p>

    <nav id="menucont" class="bodycontainer">
        <button class="menu-toggle" aria-label="Toggle menu">
            <span class="hamburger"></span>
            <span class="menu-label">Menu</span>
        </button>
        <ul class="menu">
            <li ><a title="Home" href="/index.html">Home</a></li>
            <li ><a title="Archives" href="/archives.html">Archives</a></li>
            
            <li ><a title="Tags" href="/tags.html">Tags</a></li>
            
            
            <li >
                <a href="/pages/about.html">About</a>
            </li>
            
            <li><a title="RSS" href="/feed.xml">RSS</a></li>
        </ul>
    </nav>

    <div class="theme-toggle-wrapper">
        <button class="theme-toggle" aria-label="Toggle dark mode">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></svg>
            <span>Theme</span>
        </button>
    </div>
</aside>

<main id="content">
    
<div id="post">
    <article>
<div class="post-header">
    <div id="post-meta" class="row">
        <strong>November 26, 2022</strong>
        
    </div>
    <h1><a class="post-title" href="/posts/2022-11-26-nREPL-system-interaction.html">Using nREPL as System Interface</a></h1>
</div>
<div>
    
    <p>Clojure REPL is a powerful tool for developing programs interactively. Connecting the editor to the REPL allows us to get instant feedback on the code we're writing and have confidence that it works as intended as we're developing the application. However, the REPL isn't inherently limited to application development. It provides us with an interface to the language, and the language in turn be used as an interface to the host system. Let's take a look at how we can use <a href='https://book.babashka.org/'>Babashka</a> along with <a href='https://osquery.readthedocs.io/en/stable/introduction/using-osqueryi/'>Osquery</a> to inspect the state of the host.</p><p>Osquery is a handy tool that allows using SQL commands in order to leverage a relational data-model to describe a device. Different aspects of the system are mapped to relational tables using the following <a href='https://www.osquery.io/schema/5.5.1/'>schema</a>. The tables give us access to files, ports, mounts, and many other aspects of the system. One aspect of Osqeury that's particularly useful to us is that it's able to return results in JSON format that we can parse into EDN and work with as structured data in the REPL.</p><p>To see how this works we'll start the nREPL server by running <code>bb --nrepl-server</code>. The REPL will start on port <code>1667</code> by default, we can also set a custom port by providing port number as the second argument to <code>bb</code>. Once the REPL is running we can connect any nREPL compatible editor such as Calva or Emacs.</p><p>Let's create a file called <code>osquery.clj</code> and open it in the editor and add some code to drive Osquery. First thing we'll need to do is to require the namespaces for interacting with the shell and parsing JSON:</p><pre><code class="clojure">&#40;require '&#91;clojure.java.shell :refer &#91;sh&#93;&#93;
         '&#91;cheshire.core :as json&#93;&#41;
</code></pre><p>Next, we'll define the <code>osquery</code> function that will take a SQL query as text, execute <code>osqueryi</code> command and return its result as EDN:</p><pre><code class="clojure">&#40;defn osquery &#91;query&#93;
  &#40;let &#91;{:keys &#91;exit out err&#93;} &#40;sh &quot;osqueryi&quot; &quot;--json&quot; query&#41;&#93;
    &#40;if &#40;zero? exit&#41;
      &#40;json/decode out true&#41;
      &#40;throw &#40;Exception. err&#41;&#41;&#41;&#41;&#41;
</code></pre><p>And we're now ready to try to query some information about the system. Let's run a query to see all the routes where destination is <code>::1</code></p><pre><code class="clojure">&#40;osquery &quot;select &#42; from routes where destination = '::1'&quot;&#41;
</code></pre><p>We should get back a list of routes that looks something like the following:</p><pre><code class="clojure">&#40;{:hopcount &quot;0&quot;,
  :interface &quot;lo0&quot;,
  :mtu &quot;16384&quot;,
  :type &quot;local&quot;,
  :source &quot;&quot;,
  :gateway &quot;::1&quot;,
  :netmask &quot;128&quot;,
  :flags &quot;2098181&quot;,
  :destination &quot;::1&quot;,
  :metric &quot;0&quot;}&#41;
</code></pre><p>The result is just a plain Clojure data structure we can trivially manipulate using full power of Clojure. </p><p>We can even go a step further using <a href='https://github.com/seancorfield/honeysql'>HoneySQL</a> library that will allow us to make structured queries. We'll need to require <code>deps</code> and pull in the library as follows:</p><pre><code class="clojure">&#40;require '&#91;babashka.deps :as deps&#93;&#41;

&#40;deps/add-deps '{:deps {com.github.seancorfield/honeysql {:mvn/version &quot;2.2.861&quot;}}}&#41;

&#40;require '&#91;honey.sql :as hsql&#93;&#41;
</code></pre><p>Finally, we'll update our <code>osquery</code> function as follows:</p><pre><code class="clojure">&#40;defn osquery &#91;query&#93;
  &#40;let &#91;{:keys &#91;exit out err&#93;} &#40;apply sh &quot;osqueryi&quot; &quot;--json&quot; &#40;hsql/format query {:inline true}&#41;&#41;&#93;
    &#40;if &#40;zero? exit&#41;
      &#40;json/decode out true&#41; 
      &#40;throw &#40;Exception. err&#41;&#41;&#41;&#41;&#41;
</code></pre><p>With the changes above we can now write our queries in EDN:</p><pre><code class="clojure">&#40;osquery {:select &#91;:&#42;&#93; :from &#91;:routes&#93; :where &#91;:= :destination &quot;::1&quot;&#93;}&#41;
</code></pre><p>I hope this little example illustrates how the REPL can be used as a powerful OS interaction tool as well as a programming tool and inspires you to use the REPL in new and exciting ways. Babashka in particular is a great tool for such REPL driven interaction due to fast startup and wide range of useful libraries that let us access databases, HTTP servers, and other resources. This makes Babashka an excellent tool for doing devops.</p>
</div>

<div id="post-tags">
    <br/>
    <b>Tags: </b>
    
    <a href="/clojure.html">clojure</a>
    
    <a href="/repl.html">repl</a>
    
    <a href="/babashka.html">babashka</a>
    
</div>

<br/>
</article>

    <div id="prev-next">
        
        <a class="button" href="/posts/2022-12-18-StructuringClojureApplications.html">&laquo; Structuring Clojure Applications</a>
        
        
        <a class="right button" href="/posts/2022-01-08-IntroducingKit.html">Introducing Kit Framework &raquo;</a>
        
    </div>

    


</div>

    <hr/>
    <footer id="footercont">Copyright &copy; 2026 Dmitri Sotnikov
        <p>Powered by <a href="http://cryogenweb.org">Cryogen</a></p>
    </footer>
</main>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="/js/scripts.js" type="text/javascript"></script>


</body>
</html>
